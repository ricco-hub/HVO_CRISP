var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(k){var w=0;return function(){return w<k.length?{done:!1,value:k[w++]}:{done:!0}}};$jscomp.arrayIterator=function(k){return{next:$jscomp.arrayIteratorImpl(k)}};$jscomp.makeIterator=function(k){var w="undefined"!=typeof Symbol&&Symbol.iterator&&k[Symbol.iterator];return w?w.call(k):$jscomp.arrayIterator(k)};
$jscomp.getGlobal=function(k){return"undefined"!=typeof window&&window===k?k:"undefined"!=typeof global&&null!=global?global:k};$jscomp.global=$jscomp.getGlobal(this);$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(k,w,e){k!=Array.prototype&&k!=Object.prototype&&(k[w]=e.value)};
$jscomp.polyfill=function(k,w,e,P){if(w){e=$jscomp.global;k=k.split(".");for(P=0;P<k.length-1;P++){var C=k[P];C in e||(e[C]={});e=e[C]}k=k[k.length-1];P=e[k];w=w(P);w!=P&&null!=w&&$jscomp.defineProperty(e,k,{configurable:!0,writable:!0,value:w})}};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(k){function w(){this.batch_=null}function e(e){return e instanceof C?e:new C(function(a,b){a(e)})}if(k&&!$jscomp.FORCE_POLYFILL_PROMISE)return k;w.prototype.asyncExecute=function(e){if(null==this.batch_){this.batch_=[];var a=this;this.asyncExecuteFunction(function(){a.executeBatch_()})}this.batch_.push(e)};var P=$jscomp.global.setTimeout;w.prototype.asyncExecuteFunction=function(e){P(e,0)};w.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var e=
this.batch_;this.batch_=[];for(var a=0;a<e.length;++a){var b=e[a];e[a]=null;try{b()}catch(d){this.asyncThrow_(d)}}}this.batch_=null};w.prototype.asyncThrow_=function(e){this.asyncExecuteFunction(function(){throw e;})};var C=function(e){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var a=this.createResolveAndReject_();try{e(a.resolve,a.reject)}catch(b){a.reject(b)}};C.prototype.createResolveAndReject_=function(){function e(d){return function(c){b||(b=!0,d.call(a,c))}}var a=this,b=!1;
return{resolve:e(this.resolveTo_),reject:e(this.reject_)}};C.prototype.resolveTo_=function(e){if(e===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(e instanceof C)this.settleSameAsPromise_(e);else{a:switch(typeof e){case "object":var a=null!=e;break a;case "function":a=!0;break a;default:a=!1}a?this.resolveToNonPromiseObj_(e):this.fulfill_(e)}};C.prototype.resolveToNonPromiseObj_=function(e){var a=void 0;try{a=e.then}catch(b){this.reject_(b);return}"function"==typeof a?
this.settleSameAsThenable_(a,e):this.fulfill_(e)};C.prototype.reject_=function(e){this.settle_(2,e)};C.prototype.fulfill_=function(e){this.settle_(1,e)};C.prototype.settle_=function(e,a){if(0!=this.state_)throw Error("Cannot settle("+e+", "+a+"): Promise already settled in state"+this.state_);this.state_=e;this.result_=a;this.executeOnSettledCallbacks_()};C.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var e=0;e<this.onSettledCallbacks_.length;++e)N.asyncExecute(this.onSettledCallbacks_[e]);
this.onSettledCallbacks_=null}};var N=new w;C.prototype.settleSameAsPromise_=function(e){var a=this.createResolveAndReject_();e.callWhenSettled_(a.resolve,a.reject)};C.prototype.settleSameAsThenable_=function(e,a){var b=this.createResolveAndReject_();try{e.call(a,b.resolve,b.reject)}catch(d){b.reject(d)}};C.prototype.then=function(e,a){function b(a,b){return"function"==typeof a?function(b){try{d(a(b))}catch(y){c(y)}}:b}var d,c,z=new C(function(a,b){d=a;c=b});this.callWhenSettled_(b(e,d),b(a,c));return z};
C.prototype.catch=function(e){return this.then(void 0,e)};C.prototype.callWhenSettled_=function(e,a){function b(){switch(d.state_){case 1:e(d.result_);break;case 2:a(d.result_);break;default:throw Error("Unexpected state: "+d.state_);}}var d=this;null==this.onSettledCallbacks_?N.asyncExecute(b):this.onSettledCallbacks_.push(b)};C.resolve=e;C.reject=function(e){return new C(function(a,b){b(e)})};C.race=function(w){return new C(function(a,b){for(var d=$jscomp.makeIterator(w),c=d.next();!c.done;c=d.next())e(c.value).callWhenSettled_(a,
b)})};C.all=function(w){var a=$jscomp.makeIterator(w),b=a.next();return b.done?e([]):new C(function(d,c){function z(a){return function(b){r[a]=b;n--;0==n&&d(r)}}var r=[],n=0;do r.push(void 0),n++,e(b.value).callWhenSettled_(z(r.length-1),c),b=a.next();while(!b.done)})};return C},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.SymbolClass=function(k,w){this.$jscomp$symbol$id_=k;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:w})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function k(e){if(this instanceof k)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(e||"")+"_"+w++,e)}var w=0;return k}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var k=$jscomp.global.Symbol.iterator;k||(k=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[k]&&$jscomp.defineProperty(Array.prototype,k,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var k=$jscomp.global.Symbol.asyncIterator;k||(k=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(k){$jscomp.initSymbolIterator();k={next:k};k[$jscomp.global.Symbol.iterator]=function(){return this};return k};
$jscomp.iteratorFromArray=function(k,w){$jscomp.initSymbolIterator();k instanceof String&&(k+="");var e=0,P={next:function(){if(e<k.length){var C=e++;return{value:w(C,k[C]),done:!1}}P.next=function(){return{done:!0,value:void 0}};return P.next()}};P[Symbol.iterator]=function(){return P};return P};$jscomp.polyfill("Array.prototype.entries",function(k){return k?k:function(){return $jscomp.iteratorFromArray(this,function(w,e){return[w,e]})}},"es6","es3");
JSROOT.define(["d3","painter","base3d","hist"],function(k,w,e){function P(a,b,d,c){function e(a,b){a<=h&&(a+=4);return a>h&&a<h+b}if(b&&b.children)for(var r=0;r<b.children.length;++r){var n=b.children[r];if(n.axis_draw)break;n=void 0}if(n)if(a){d=d?!0:!1;c=c?!0:!1;var h=1;a=a.position;0>a.x&&0<=a.y&&(h=2);0<=a.x&&0<=a.y&&(h=3);0<=a.x&&0>a.y&&(h=4);for(a=0;a<n.children.length;++a)if(b=n.children[a],b.grid)b.visible=c&&e(b.grid,3);else if(b.zid)b.visible=e(b.zid,2);else if(b.xyid)b.visible=e(b.xyid,
3);else if(b.xyboxid){r=5;var y=0;c&&!d?(r=3,y=-2):d&&!c?r=3:d||c||(r=b.bottom?3:0);b.visible=e(b.xyboxid+y,r);!b.visible&&b.bottom&&c&&(b.visible=e(b.xyboxid,3))}else b.zboxid&&(r=2,y=0,d&&c?r=5:c&&!d?r=4:!c&&d&&(y=-2,r=4),b.visible=e(b.zboxid+y,r))}else b.remove(n)}function C(a,b){var d=a.getPadPainter().getRootPad(!0),c=Math.max(.75*a.size_xy3d,a.size_z3d);b&&a.camera.position.set(-1.6*c,-3.5*c,1.4*a.size_z3d);if(!(!d||!b&&a.zoomChangedInteractive()||isNaN(d.fTheta)||isNaN(d.fPhi)||d.fTheta===
a.camera_Theta&&d.fPhi===a.camera_Phi)){c=3*Math.max(a.size_xy3d,a.size_z3d);b=(-d.fPhi-90)/180*Math.PI;var e=d.fTheta/180*Math.PI;a.camera_Phi=d.fPhi;a.camera_Theta=d.fTheta;a.camera.position.set(c*Math.cos(b)*Math.cos(e),c*Math.sin(b)*Math.cos(e),a.size_z3d+c*Math.sin(e));b=!0}b&&a.camera.lookAt(a.lookat)}function N(a,b){JSROOT.THistPainter.call(this,a,b);this.mode3d=!0}function ca(a,b){JSROOT.ObjectPainter.call(this,a,b)}JSROOT.TFramePainter.prototype.create3DScene=function(a){if(-1===a)this.mode3d&&
(this.clear3dCanvas?(P(null,this.toplevel),this.clear3dCanvas(),w.disposeThreejsObject(this.scene),this.control&&this.control.cleanup(),this.renderer&&(this.renderer.dispose&&this.renderer.dispose(),this.renderer.forceContextLoss&&this.renderer.forceContextLoss()),delete this.size_xy3d,delete this.size_z3d,delete this.tooltip_mesh,delete this.scene,delete this.toplevel,delete this.camera,delete this.pointLight,delete this.renderer,delete this.control,this.render_tmout&&(clearTimeout(this.render_tmout),
delete this.render_tmout),this.mode3d=!1):console.error("Strange, why mode3d is configured!!!!",this.mode3d));else if(this.mode3d=!0,"toplevel"in this)this.scene.remove(this.toplevel),w.disposeThreejsObject(this.toplevel),delete this.tooltip_mesh,delete this.toplevel,this.control&&this.control.HideTooltip(),a=new e.Object3D,this.scene.add(a),this.toplevel=a,this.resize3D(),C(this,!1);else{a=w.getRender3DKind(a);w.assign3DHandler(this);var b=this.getSizeFor3d(void 0,a);this.size_z3d=100;this.size_xy3d=
10<b.height&&10<b.width?Math.round(b.width/b.height*this.size_z3d):this.size_z3d;this.scene=new e.Scene;this.toplevel=new e.Object3D;this.scene.add(this.toplevel);this.scene_width=b.width;this.scene_height=b.height;this.camera=new e.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size_z3d);this.camera_Theta=this.camera_Phi=30;this.pointLight=new e.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size_xy3d/2,this.size_xy3d/2,this.size_z3d/
2);this.lookat=new e.Vector3(0,0,.8*this.size_z3d);this.camera.up=new e.Vector3(0,0,1);this.scene.add(this.camera);C(this,!0);this.renderer=w.createRender3D(this.scene_width,this.scene_height,a);this.webgl=a===JSROOT.constants.Render3D.WebGL;this.add3dCanvas(b,this.renderer.jsroot_dom,this.webgl);this.first_render_tm=0;this.enable_highlight=!1;if(!JSROOT.batch_mode&&this.webgl){this.control=w.createOrbitControl(this,this.camera,this.scene,this.renderer,this.lookat);var d=this,c=this.getMainPainter();
this.control.ProcessMouseMove=function(a){for(var b=null,c=null,e=null,z=0;z<a.length;++z)if(a[z].object.tooltip){if(b=a[z].object.tooltip(a[z])){c=a[z].object;break}}else a[z].object.zoom&&!e&&(e=a[z].object);b&&!b.use_itself&&(a=1E-4*d.size_xy3d,z=1E-4*d.size_z3d,(b.x1>b.x2||b.y1>b.y2||b.z1>b.z2)&&console.warn("check 3D hints coordinates"),b.x1-=a,b.x2+=a,b.y1-=a,b.y2+=a,b.z1-=z,b.z2+=z);d.highlightBin3D(b,c);return!b&&e&&d.Get3DZoomCoord?(c=e.GlobalIntersect(this.raycaster),b=e.zoom,c=d.Get3DZoomCoord(c,
b),"z"===b&&e.use_y_for_z&&(b="y"),e=d.getAxis(b),a={name:b,title:"TAxis",line:"any info",only_status:!0},e&&(a.name=e.fName,a.title=e.fTitle||"histogram TAxis object"),a.line=b+" : "+d.axisAsText(b,c),a):b&&b.lines?b:""};this.control.ProcessMouseLeave=function(){d.highlightBin3D(null)};this.control.contextMenu=function(a,b){var e="painter",d=c;if(b)for(var z=0;z<b.length;++z){var q=b[z].object;if(q.zoom){e=q.zoom;d=null;break}if(q.painter&&"function"===typeof q.painter.fillContextMenu){d=q.painter;
break}}(b=c.getFramePainter())&&b.showContextMenu&&b.showContextMenu(e,a,d)}}}};JSROOT.TFramePainter.prototype.render3D=function(a){var b=this;if(-1111===a){var d=JSROOT._.get_document();a=e.CreateSVGRenderer(!1,0,d);a.setSize(this.scene_width,this.scene_height);a.render(this.scene,this.camera);return a.makeOuterHTML?(d=d.createElement("div"),d.innerHTML=a.makeOuterHTML(),d.childNodes[0]):a.domElement}void 0===a&&(a=5);0<a&&!this.usesvg&&!JSROOT.batch_mode?this.render_tmout||(this.render_tmout=setTimeout(function(){return b.render3D(0)},
a)):(this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.renderer&&(w.beforeRender3D(this.renderer),a=new Date,this.opt3d||(this.opt3d={FrontBox:!0,BackBox:!0}),P(this.camera,this.toplevel,this.opt3d.FrontBox,this.opt3d.BackBox),this.renderer.render(this.scene,this.camera),w.afterRender3D(this.renderer),d=new Date,0===this.first_render_tm&&(this.first_render_tm=d.getTime()-a.getTime(),this.enable_highlight=1200>this.first_render_tm&&this.isTooltipAllowed(),console.log("three.js r"+
e.REVISION+", first render tm = "+this.first_render_tm))))};JSROOT.TFramePainter.prototype.resize3D=function(){var a=this.getSizeFor3d(this.access3dKind());this.apply3dSize(a);if(this.scene_width===a.width&&this.scene_height===a.height||10>a.width||10>a.height)return!1;this.scene_width=a.width;this.scene_height=a.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);this.renderer.setJSROOTSize&&this.renderer.setJSROOTSize(this.scene_width,
this.scene_height);return!0};JSROOT.TFramePainter.prototype.highlightBin3D=function(a,b){var d=!1,c=null,z=!0,r=!a||void 0===a.x1||!this.enable_highlight,n=this.getMainPainter();!n||n.provideUserTooltip&&n.hasUserTooltip()||(n=null);this.tooltip_selfmesh&&(z=this.tooltip_selfmesh!==b,this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color,delete this.tooltip_selfmesh,d=!0);this.tooltip_mesh&&(c=this.tooltip_mesh,this.toplevel.remove(this.tooltip_mesh),delete this.tooltip_mesh,d=!0);
if(r)d&&this.render3D(),d&&n&&n.provideUserTooltip(null);else{if(a.use_itself)b.save_color=b.material.color,b.material.color=new e.Color(a.color),this.tooltip_selfmesh=b,d=z;else{d=!0;b=w.Box3D.Indexes;z=w.Box3D.Normals;r=w.Box3D.Vertices;var h=new e.Color(a.color?a.color:16711680),y=a.opacity||1;if(c){var q=c.geometry.attributes.position.array;c.geometry.attributes.position.needsUpdate=!0;c.material.color=h;c.material.opacity=y}else{q=new Float32Array(3*b.length);var f=new Float32Array(3*b.length);
c=new e.BufferGeometry;c.setAttribute("position",new e.BufferAttribute(q,3));c.setAttribute("normal",new e.BufferAttribute(f,3));h=new e.MeshBasicMaterial({color:h,opacity:y,flatShading:!0});c=new e.Mesh(c,h)}a.x1===a.x2&&console.warn("same tip X",a.x1,a.x2);a.y1===a.y2&&console.warn("same tip Y",a.y1,a.y2);a.z1===a.z2&&(a.z2=a.z1+1E-4);h=0;for(y=-3;h<b.length;++h){var p=r[b[h]];q[3*h]=a.x1+p.x*(a.x2-a.x1);q[3*h+1]=a.y1+p.y*(a.y2-a.y1);q[3*h+2]=a.z1+p.z*(a.z2-a.z1);f&&(0===h%6&&(y+=3),f[3*h]=z[y],
f[3*h+1]=z[y+1],f[3*h+2]=z[y+2])}this.tooltip_mesh=c;this.toplevel.add(c)}d&&this.render3D();d&&a.$painter&&"function"==typeof a.$painter.redrawProjection&&a.$painter.redrawProjection(a.ix-1,a.ix,a.iy-1,a.iy);d&&n&&n.getObject()&&n.provideUserTooltip({obj:n.getObject(),name:n.getObject().fName,bin:a.bin,cont:a.value,binx:a.ix,biny:a.iy,binz:a.iz,grx:(a.x1+a.x2)/2,gry:(a.y1+a.y2)/2,grz:(a.z1+a.z2)/2})}};JSROOT.TFramePainter.prototype.set3DOptions=function(a){this.opt3d=a};JSROOT.TFramePainter.prototype.drawXYZ=
function(a,b){function d(a,b,c){var d=new e.Geometry;"z"===a?d.vertices.push(new e.Vector3(0,0,0),new e.Vector3(4*E,0,0),new e.Vector3(4*E,0,2*b),new e.Vector3(0,0,2*b)):d.vertices.push(new e.Vector3(-b,0,0),new e.Vector3(b,0,0),new e.Vector3(b,4*-E,0),new e.Vector3(-b,4*-E,0));d.faces.push(new e.Face3(0,2,1));d.faces.push(new e.Face3(0,3,2));d.computeFaceNormals();var f=new e.MeshBasicMaterial({transparent:!0,vertexColors:e.NoColors,side:e.DoubleSide,opacity:0});d=new e.Mesh(d,f);d.zoom=a;d.size_3d=
b;d.use_y_for_z=c;"y"==a&&d.rotateZ(Math.PI/2).rotateX(Math.PI);d.GlobalIntersect=function(a){var b=new e.Plane,c=this.geometry;if(c&&c.vertices&&(b.setFromCoplanarPoints(c.vertices[0],c.vertices[1],c.vertices[2]),b.applyMatrix4(this.matrixWorld),c=a.ray.origin.clone(),a=c.clone().addScaledVector(a.ray.direction,1E10),b=b.intersectLine(new e.Line3(c,a),new e.Vector3)))return a=-this.size_3d,c=this.size_3d,"z"===this.zoom&&(a=0,c=2*this.size_3d),b[this.zoom]<a?b[this.zoom]=a:b[this.zoom]>c&&(b[this.zoom]=
c),b};d.ShowSelection=function(a,b){var c=this.children?this.children[0]:null,d=this.zoom;if(!a||!b)return c&&(this.remove(c),w.disposeThreejsObject(c)),c;if(c)var f=c.geometry;else f=this.geometry.clone(),"z"===d?f.vertices[1].x=f.vertices[2].x=E:f.vertices[2].y=f.vertices[3].y=-E,c=new e.Mesh(f,new e.MeshBasicMaterial({color:65280,side:e.DoubleSide})),this.add(c);"z"==d?(f.vertices[0].z=f.vertices[1].z=a[d],f.vertices[2].z=f.vertices[3].z=b[d]):(f.vertices[0].x=f.vertices[3].x=a[d],f.vertices[1].x=
f.vertices[2].x=b[d]);f.computeFaceNormals();f.verticesNeedUpdate=!0;return f.normalsNeedUpdate=!0};return d}b||(b={});var c=-this.size_xy3d,z=this.size_xy3d,r=-this.size_xy3d,n=this.size_xy3d,h=0,y=2*this.size_z3d,q=Math.round(.05*this.size_z3d),f=this.getPadPainter().getRootPad(!0),p=this.xmin,v=this.xmax,m=this.ymin,x=this.ymax,l=this.zmin,g=this.zmax,u=!1,t=!1;this.size_z3d||(c=this.xmin,z=this.xmax,r=this.ymin,n=this.ymax,h=this.zmin,y=this.zmax,q=.05*(y-h));"zoom_xmin"in this&&"zoom_xmax"in
this&&this.zoom_xmin!==this.zoom_xmax&&(p=this.zoom_xmin,v=this.zoom_xmax);"zoom_ymin"in this&&"zoom_ymax"in this&&this.zoom_ymin!==this.zoom_ymax&&(m=this.zoom_ymin,x=this.zoom_ymax,u=!0);"zoom_zmin"in this&&"zoom_zmax"in this&&this.zoom_zmin!==this.zoom_zmax&&(l=this.zoom_zmin,g=this.zoom_zmax,t=!0);b.use_y_for_z&&(this.zmin=this.ymin,this.zmax=this.ymax,l=m,g=x,t=u,m=0,x=1);this.lego_zmin=l;this.lego_zmax=g;void 0===b.zmult||t||(g*=b.zmult);this.x_handle=new JSROOT.TAxisPainter(null,this.xaxis);
this.x_handle.configureAxis("xaxis",this.xmin,this.xmax,p,v,!1,[c,z],{log:f?f.fLogx:0});this.x_handle.assignFrameMembers(this,"x");this.y_handle=new JSROOT.TAxisPainter(null,this.yaxis);this.y_handle.configureAxis("yaxis",this.ymin,this.ymax,m,x,!1,[r,n],{log:f&&!b.use_y_for_z?f.fLogx:0});this.y_handle.assignFrameMembers(this,"y");this.z_handle=new JSROOT.TAxisPainter(null,this.zaxis);this.z_handle.configureAxis("zaxis",this.zmin,this.zmax,l,g,!1,[h,y],{log:f?f.fLogz:0});this.z_handle.assignFrameMembers(this,
"z");this.setRootPadRange(f,!0);this.x_handle.debug=!0;var L=new e.MeshBasicMaterial({color:0});f=new e.LineBasicMaterial({color:0});var E=.5*q;v=[];var A=1;l=this.x_handle.createTicks(!1,!0);x=this.y_handle.createTicks(!1,!0);m=this.z_handle.createTicks(!1,!0);p=new e.Object3D;p.axis_draw=!0;a.add(p);a=[];var M=0;for(g=this.xaxis;l.next();){u=l.grpos;t=1===l.kind;var H=this.x_handle.format(l.tick,2);l.last_major()?g&&g.fTitle||(H="x"):null===H&&(t=!1,H="");if(t&&H&&0<H.length){H=new e.TextGeometry(H,
{font:JSROOT.threejs_font_helvetiker_regular,size:q,height:0,curveSegments:5});H.computeBoundingBox();var J=H.boundingBox.max.x-H.boundingBox.min.x,O=H.boundingBox.max.y-H.boundingBox.min.y;H.center=!0;M=Math.max(M,O);H.grx=u;v.push(H);l.last_major()||(O=l.next_major_grpos()-u,0<J&&(A=Math.min(A,.9*O/J)),this.x_handle.isCenteredLabels()&&(H.grx+=O/2))}a.push(u,0,0,u,t?-E:.6*-E,0)}g&&g.fTitle&&(l=new e.TextGeometry(g.fTitle,{font:JSROOT.threejs_font_helvetiker_regular,size:q,height:0,curveSegments:5}),
l.computeBoundingBox(),l.center=g.TestBit(JSROOT.EAxisBits.kCenterTitle),l.gry=2,l.grx=(c+z)/2,v.push(l));this.Get3DZoomCoord=function(a,b){a=a[b];var c=this["scale_"+b+"min"],d=this["scale_"+b+"max"];a="z"===b?a/2/this.size_z3d:(a+this.size_xy3d)/2/this.size_xy3d;return a=this["log"+b]?Math.exp(Math.log(c)+a*(Math.log(d)-Math.log(c))):c+a*(d-c)};var D=new e.Object3D;D.position.set(0,r,h);D.rotation.x=.25*Math.PI;D.xyid=2;a=w.createLineSegments(a,f);D.add(a);v.forEach(function(a){var b=a.boundingBox.max.x-
a.boundingBox.min.x,c=a.center?a.grx-b/2:z-b;b=new e.Matrix4;b.set(A,0,0,c,0,A,0,(-M*A-1.5*E)*(a.gry||1),0,0,1,0,0,0,0,1);a=new e.Mesh(a,L);a.applyMatrix4(b);D.add(a)});b.zoom&&D.add(d("x",this.size_xy3d));p.add(D);D=new e.Object3D;D.position.set(0,n,h);D.rotation.x=.75*Math.PI;D.add(new e.LineSegments(a.geometry,f));v.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.grx+b/2:z;b=new e.Matrix4;b.set(-A,0,0,c,0,A,0,(-M*A-1.5*E)*(a.gry||1),0,0,-1,0,0,0,0,1);a=new e.Mesh(a,
L);a.applyMatrix4(b);D.add(a)});D.xyid=4;b.zoom&&D.add(d("x",this.size_xy3d));p.add(D);v=[];A=1;M=0;a=[];for(l=this.yaxis;x.next();)g=x.grpos,u=1===x.kind,t=this.y_handle.format(x.tick,2),x.last_major()?l&&l.fTitle||(t="y"):null===t&&(u=!1,t=""),u&&(t=new e.TextGeometry(t,{font:JSROOT.threejs_font_helvetiker_regular,size:q,height:0,curveSegments:5}),t.computeBoundingBox(),H=t.boundingBox.max.x-t.boundingBox.min.x,J=t.boundingBox.max.y-t.boundingBox.min.y,t.center=!0,M=Math.max(M,J),t.gry=g,v.push(t),
x.last_major()||(J=x.next_major_grpos()-g,0<H&&(A=Math.min(A,.9*J/H)),this.y_handle.isCenteredLabels()&&(t.gry+=J/2))),a.push(0,g,0,u?-E:.6*-E,g,0);l&&l.fTitle&&(x=new e.TextGeometry(l.fTitle,{font:JSROOT.threejs_font_helvetiker_regular,size:q,height:0,curveSegments:5}),x.computeBoundingBox(),x.center=l.TestBit(JSROOT.EAxisBits.kCenterTitle),x.grx=2,x.gry=(r+n)/2,v.push(x));if(!b.use_y_for_z){a=w.createLineSegments(a,f);var F=new e.Object3D;F.position.set(c,0,h);F.rotation.y=-.25*Math.PI;F.add(a);
v.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.gry+b/2:n;b=new e.Matrix4;b.set(0,A,0,(-M*A-1.5*E)*(a.grx||1),-A,0,0,c,0,0,1,0,0,0,0,1);a=new e.Mesh(a,L);a.applyMatrix4(b);F.add(a)});F.xyid=3;b.zoom&&F.add(d("y",this.size_xy3d));p.add(F);F=new e.Object3D;F.position.set(z,0,h);F.rotation.y=-.75*Math.PI;F.add(new e.LineSegments(a.geometry,f));v.forEach(function(a){var b=a.boundingBox.max.x-a.boundingBox.min.x,c=a.center?a.gry-b/2:n-b;b=new e.Matrix4;b.set(0,A,0,(-M*
A-1.5*E)*(a.grx||1),A,0,0,c,0,0,-1,0,0,0,0,1);a=new e.Mesh(a,L);a.applyMatrix4(b);F.add(a)});F.xyid=1;b.zoom&&F.add(d("y",this.size_xy3d));p.add(F)}v=[];A=1;a=[];t=g=u=null;x=this.zaxis;l=0;this.size_z3d&&(u=[],g=[]);for(;m.next();){H=m.grpos;J=1==m.kind;O=this.z_handle.format(m.tick,2);null===O&&(J=!1,O="");if(J&&O){O=new e.TextGeometry(O,{font:JSROOT.threejs_font_helvetiker_regular,size:q,height:0,curveSegments:5});O.computeBoundingBox();var G=O.boundingBox.max.x-O.boundingBox.min.x,k=O.boundingBox.max.y-
O.boundingBox.min.y;O.translate(-G,-k/2,0);O.grz=H;v.push(O);null!==t&&0<k&&(A=Math.min(A,.9*(H-t)/k));l=Math.max(l,G);t=H}u&&J&&u.push(c,0,H,z,0,H);g&&J&&g.push(0,r,H,0,n,H);a.push(0,0,H,J?E:.6*E,0,H)}u&&0<u.length&&(m=new e.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),u=w.createLineSegments(u,m),u.position.set(0,n,0),u.grid=2,u.visible=!1,p.add(u),m=new e.LineSegments(u.geometry,m),m.position.set(0,r,0),m.grid=4,m.visible=!1,p.add(m));g&&0<g.length&&(m=new e.LineDashedMaterial({color:0,dashSize:2,
gapSize:2}),g=w.createLineSegments(g,m),g.position.set(z,0,0),g.grid=3,g.visible=!1,p.add(g),m=new e.LineSegments(g.geometry,m),m.position.set(c,0,0),m.grid=1,m.visible=!1,p.add(m));var B=[];a=w.createLineSegments(a,f);for(m={$jscomp$loop$prop$n$64:0};4>m.$jscomp$loop$prop$n$64;m={$jscomp$loop$prop$n$64:m.$jscomp$loop$prop$n$64},++m.$jscomp$loop$prop$n$64)B.push(new e.Object3D),v.forEach(function(a){return function(b){var c=new e.Matrix4;c.set(-A,0,0,2*E,0,0,1,0,0,A,0,b.grz);b=new e.Mesh(b,L);b.applyMatrix4(c);
B[a.$jscomp$loop$prop$n$64].add(b)}}(m)),x&&x.fTitle&&(g=new e.TextGeometry(x.fTitle,{font:JSROOT.threejs_font_helvetiker_regular,size:q,height:0,curveSegments:5}),g.computeBoundingBox(),u=g.boundingBox.max.x-g.boundingBox.min.x,t=x.TestBit(JSROOT.EAxisBits.kCenterTitle)?(y+h-u)/2:y-u,g.rotateZ(Math.PI/2),u=new e.Matrix4,u.set(-A,0,0,3*E+l,0,0,1,0,0,A,0,t),g=new e.Mesh(g,L),g.applyMatrix4(u),B[m.$jscomp$loop$prop$n$64].add(g)),B[m.$jscomp$loop$prop$n$64].add(0==m.$jscomp$loop$prop$n$64?a:new e.LineSegments(a.geometry,
f)),b.zoom&&B[m.$jscomp$loop$prop$n$64].add(d("z",this.size_z3d,b.use_y_for_z)),B[m.$jscomp$loop$prop$n$64].zid=m.$jscomp$loop$prop$n$64+2,p.add(B[m.$jscomp$loop$prop$n$64]);B[0].position.set(c,n,0);B[0].rotation.z=.75*Math.PI;B[1].position.set(z,n,0);B[1].rotation.z=.25*Math.PI;B[2].position.set(z,r,0);B[2].rotation.z=-.25*Math.PI;B[3].position.set(c,r,0);B[3].rotation.z=-.75*Math.PI;if(0!==this.size_z3d){b=w.createLineSegments([c,0,0,z,0,0],f,null,!0);for(q=0;2>q;++q)v=new e.LineSegments(b,f),v.position.set(0,
r,0===q?h:y),v.xyboxid=2,v.bottom=0==q,p.add(v),v=new e.LineSegments(b,f),v.position.set(0,n,0===q?h:y),v.xyboxid=4,v.bottom=0==q,p.add(v);r=w.createLineSegments([0,r,0,0,n,0],f,null,!0);for(b=0;2>b;++b)q=new e.LineSegments(r,f),q.position.set(c,0,0===b?h:y),q.xyboxid=3,q.bottom=0==b,p.add(q),q=new e.LineSegments(r,f),q.position.set(z,0,0===b?h:y),q.xyboxid=1,q.bottom=0==b,p.add(q);c=w.createLineSegments([0,0,h,0,0,y],f,null,!0);for(h=0;4>h;++h)y=new e.LineSegments(c,f),y.zboxid=B[h].zid,y.position.copy(B[h].position),
p.add(y)}};JSROOT.THistPainter.prototype.draw3DBins=function(){var a=this;if(this.draw_content){if(this.isTH2Poly()&&this.drawPolyLego)return this.drawPolyLego();if(2==this.getDimension()&&this.options.Contour&&this.drawContour3D)return this.drawContour3D(!0);if(2==this.getDimension()&&this.options.Surf&&this.drawSurf)return this.drawSurf();if(2==this.getDimension()&&this.options.Error&&this.drawError)return this.drawError();var b=w.Box3D.Vertices,d=w.Box3D.Indexes,c=w.Box3D.Normals,z=w.Box3D.Segments,
r=[0,1,1,2,2,3,3,0],n=[new e.Vector3(0,0,0),new e.Vector3(0,1,0),new e.Vector3(1,1,0),new e.Vector3(1,0,0)],h=this.getFramePainter(),y=h.z_handle.gr.domain()[0],q=h.z_handle.gr.domain()[1],f=this.prepareColorDraw({rounding:!1,use3d:!0,extra:1}),p=f.i1,v=f.i2,m=f.j1,x=f.j2,l,g,u,t,L,E,A,M=this.getHisto(),H=M?M.$baseh:null,J=11===this.options.Lego||13===this.options.Lego;if(!(p>=v||m>=x)){var O=function(b,c,d){E=M.getBinContent(b+1,c+1);L=H?H.getBinContent(b+1,c+1):!1!==a.options.BaseLine?a.options.BaseLine:
a.options.Zero?y:0;E<L&&(b=L,L=E,E=b);if(L>=I||E<B)return!1;A=E===B||L>=E;return!A||0<d?!0:M.$baseh?!1:a.options.Zero||0<y?!0:a._show_empty_bins},D=65535>M.getBin(v,x),F=[y,q],G=null;if(12===this.options.Lego||14===this.options.Lego)F=this.createContour(M.fContour?M.fContour.length:20,h.lego_zmin,h.lego_zmax).arr,G=this.getHistPalette();for(var K=0;K<F.length-1;++K){var B=F[K];var I=F[K+1];G&&K==F.length-2&&I<q&&(I=q);var C=0,S=0,Y=t=0,P=h.grz(B),N=h.grz(I);for(l=p;l<v;++l)for(g=m;g<x;++g)if(O(l,
g,K)){var R=!A&&0<K;var aa=!A&&E>I&&K<F.length-2;t+=A?12:d.length;R&&(t-=6);aa&&(t-=6);J&&!A&&(t-=12,Y+=12)}var W=new Float32Array(3*t),T=new Float32Array(3*t),V=D?new Uint16Array(t/3):new Uint32Array(t/3),U=u=null,Q=null,X=0,da=0,ea=R=void 0,ba=void 0;0<Y&&(u=new Float32Array(3*Y),U=new Float32Array(3*Y),Q=D?new Uint16Array(Y/3):new Uint32Array(Y/3));for(l=p;l<v;++l){t=f.grx[l]+f.xbar1*(f.grx[l+1]-f.grx[l]);var Z=f.grx[l]+f.xbar2*(f.grx[l+1]-f.grx[l]);for(g=m;g<x;++g)if(O(l,g,K)){R=!A&&0<K;aa=!A&&
E>I&&K<F.length-2;var fa=f.gry[g]+f.ybar1*(f.gry[g+1]-f.gry[g]);var ha=f.gry[g]+f.ybar2*(f.gry[g+1]-f.gry[g]);C=L<=B?P:h.grz(L);S=E>I?N:h.grz(E);ea=ba=0;A&&(ba+=12,ea+=24);var ja=d.length,ka=M.getBin(l+1,g+1);for(R&&(ja-=6);ea<ja;)R=b[d[ea]],J&&12>ea?(u[da]=t+R.x*(Z-t),u[da+1]=fa+R.y*(ha-fa),u[da+2]=C+R.z*(S-C),U[da]=c[ba],U[da+1]=c[ba+1],U[da+2]=c[ba+2],0===da%9&&(Q[da/9]=ka),da+=3):(W[X]=t+R.x*(Z-t),W[X+1]=fa+R.y*(ha-fa),W[X+2]=C+R.z*(S-C),T[X]=c[ba],T[X+1]=c[ba+1],T[X+2]=c[ba+2],0===X%9&&(V[X/
9]=ka),X+=3),++ea,0===ea%6&&(ba+=3,aa&&ea===d.length-12&&(ea+=6,ba+=3))}}l=new e.BufferGeometry;l.setAttribute("position",new e.BufferAttribute(W,3));l.setAttribute("normal",new e.BufferAttribute(T,3));g=M.fFillColor;t=this.getColor(g);if(G)t=G.calcColor(K,F.length);else if(1===this.options.Lego||2>g)g=1,t="white";Z=new e.MeshBasicMaterial({color:t,flatShading:!0});l=new e.Mesh(l,Z);l.face_to_bins_index=V;l.painter=this;l.zmin=y;l.zmax=q;l.baseline=!1!==this.options.BaseLine?this.options.BaseLine:
this.options.Zero?y:0;l.tip_color=3===g?16711680:65280;l.handle=f;l.tooltip=function(a){if(isNaN(a.faceIndex))return console.error("faceIndex not provided, check three.js version",e.REVISION,"expected r102"),null;if(0>a.faceIndex||a.faceIndex>=this.face_to_bins_index.length)return null;var b=this.painter,c=this.handle,d=b.getFramePainter(),f=b.getHisto();a=b.get3DToolTip(this.face_to_bins_index[a.faceIndex]);a.x1=Math.max(-d.size_xy3d,c.grx[a.ix-1]+c.xbar1*(c.grx[a.ix]-c.grx[a.ix-1]));a.x2=Math.min(d.size_xy3d,
c.grx[a.ix-1]+c.xbar2*(c.grx[a.ix]-c.grx[a.ix-1]));a.y1=Math.max(-d.size_xy3d,c.gry[a.iy-1]+c.ybar1*(c.gry[a.iy]-c.gry[a.iy-1]));a.y2=Math.min(d.size_xy3d,c.gry[a.iy-1]+c.ybar2*(c.gry[a.iy]-c.gry[a.iy-1]));c=this.baseline;var g=a.value;f.$baseh&&(c=f.$baseh.getBinContent(a.ix,a.iy));g<c&&(f=c,c=g,g=f);a.z1=d.grz(Math.max(this.zmin,c));a.z2=d.grz(Math.min(this.zmax,g));a.color=this.tip_color;b.is_projection&&2==b.getDimension()&&(a.$painter=b);return a};h.toplevel.add(l);0<Y&&(Z=new e.BufferGeometry,
Z.setAttribute("position",new e.BufferAttribute(u,3)),Z.setAttribute("normal",new e.BufferAttribute(U,3)),g=2>g?new e.Color(16711680):new e.Color(k.rgb(t).darker(.5).toString()),g=new e.MeshBasicMaterial({color:g,flatShading:!0}),g=new e.Mesh(Z,g),g.face_to_bins_index=Q,g.painter=this,g.handle=l.handle,g.tooltip=l.tooltip,g.zmin=l.zmin,g.zmax=l.zmax,g.baseline=l.baseline,g.tip_color=l.tip_color,h.toplevel.add(g))}if(!(12<this.options.Lego)){t=Z=0;d=!0;I=q;B=y;for(l=p;l<v;++l)for(g=m;g<x;++g)O(l,g,
0)&&(Z+=A?n.length:b.length,t+=A?r.length:z.length);65520<Z&&(d=!1);d||(Z=3*t);c=new Float32Array(3*Z);J=d?new Uint16Array(t):null;D=h.grz(y);F=h.grz(q);Y=Q=K=G=0;for(l=p;l<v;++l)for(t=f.grx[l]+f.xbar1*(f.grx[l+1]-f.grx[l]),Z=f.grx[l]+f.xbar2*(f.grx[l+1]-f.grx[l]),g=m;g<x;++g)if(O(l,g,0))if(fa=f.gry[g]+f.ybar1*(f.gry[g+1]-f.gry[g]),ha=f.gry[g]+f.ybar2*(f.gry[g+1]-f.gry[g]),G=L<=y?D:h.grz(L),K=E>q?F:h.grz(E),U=A?r:z,V=A?n:b,d){for(p=0;p<U.length;++p)J[Y++]=Q/3+U[p];for(p=0;p<V.length;++p)u=V[p],c[Q]=
t+u.x*(Z-t),c[Q+1]=fa+u.y*(ha-fa),c[Q+2]=G+u.z*(K-G),Q+=3}else for(p=0;p<U.length;++p)u=V[U[p]],c[Q]=t+u.x*(Z-t),c[Q+1]=fa+u.y*(ha-fa),c[Q+2]=G+u.z*(K-G),Q+=3;b=this.getColor(M.fLineColor);b=new e.LineBasicMaterial({color:new e.Color(b),linewidth:M.fLineWidth});b=w.createLineSegments(c,b,d?J:null);h.toplevel.add(b)}}}};w.drawAxis3D=function(a,b){a=new JSROOT.ObjectPainter(a,b);"_main"in b||a.addToPadPrimitives();a.Draw3DAxis=function(){var a=this.getFramePainter();if(!a||!a._toplevel)return Promise.reject(Error("no 3D frame found for 3D axis drawing"));
var b=(new e.Box3).setFromObject(a._toplevel);this.xmin=b.min.x;this.xmax=b.max.x;this.ymin=b.min.y;this.ymax=b.max.y;this.zmin=b.min.z;this.zmax=b.max.z;this.size_xy3d=this.size_z3d=0;this.drawXYZ=JSROOT.TFramePainter.prototype.drawXYZ;this.drawXYZ(a._toplevel);a.adjustCameraPosition();a.render3D();return Promise.resolve(this)};return a.Draw3DAxis()};JSROOT.TH1Painter.prototype.draw3D=function(a){var b=this;this.mode3d=!0;var d=this.getFramePainter(),c=this.isMainPainter(),e=this.getHisto();"resize"==
a?c&&d.resize3D()&&d.render3D():(this.deleteAttr(),this.scanContent(!0),c&&(d.create3DScene(this.options.Render3D),d.setAxesRanges(e.fXaxis,this.xmin,this.xmax,e.fYaxis,this.ymin,this.ymax,e.fZaxis,0,0),d.set3DOptions(this.options),d.drawXYZ(d.toplevel,{use_y_for_z:!0,zmult:1.1,zoom:JSROOT.settings.Zooming,ndim:1})),d.mode3d&&(this.draw3DBins(),d.render3D(),this.updateStatWebCanvas(),d.addKeysHandler()));return c?this.drawColorPalette(this.options.Zscale&&(12===this.options.Lego||14===this.options.Lego)).then(function(){return b.drawHistTitle()}):
Promise.resolve(this)};JSROOT.TH2Painter.prototype.draw3D=function(a){var b=this;this.mode3d=!0;var d=this.getFramePainter(),c=this.isMainPainter(),e=this.getHisto();if("resize"==a)c&&d.resize3D()&&d.render3D();else{a=this.getPadPainter().getRootPad(!0);var r=1.1;this.zmin=a&&a.fLogz?.3*this.gminposbin:this.gminbin;this.zmax=this.gmaxbin;-1111!==this.options.minimum&&(this.zmin=this.options.minimum);-1111!==this.options.maximum&&(this.zmax=this.options.maximum,r=1);a&&a.fLogz&&0>=this.zmin&&(this.zmin=
1E-5*this.zmax);this.deleteAttr();c&&(d.create3DScene(this.options.Render3D),d.setAxesRanges(e.fXaxis,this.xmin,this.xmax,e.fYaxis,this.ymin,this.ymax,e.fZaxis,this.zmin,this.zmax),d.set3DOptions(this.options),d.drawXYZ(d.toplevel,{zmult:r,zoom:JSROOT.settings.Zooming,ndim:2}));d.mode3d&&(this.draw3DBins(),d.render3D(),this.updateStatWebCanvas(),d.addKeysHandler())}return c?this.drawColorPalette(this.options.Zscale&&(12===this.options.Lego||14===this.options.Lego||11===this.options.Surf||12===this.options.Surf)).then(function(){return b.drawHistTitle()}):
Promise.resolve(this)};JSROOT.TH2Painter.prototype.drawContour3D=function(a){var b=this.getFramePainter(),d=this.prepareColorDraw({rounding:!1,use3d:!0,extra:100,middle:0}),c=this.getHisto(),e=this.getContourLevels(),r=this.getHistPalette(),n=2*b.size_z3d,h=[];this.buildContour(d,e,r,function(c,d,f,z,r,m){if(!(3>r-z)){if(a&&(n=b.grz(e[m]),0>n||n>2*b.size_z3d))return;for(c=z;c<r;++c)h.push(d[c],f[c],n),h.push(d[c+1],f[c+1],n)}});d=w.createLineSegments(h,w.create3DLineMaterial(this,c));b.toplevel.add(d)};
JSROOT.TH2Painter.prototype.drawSurf=function(){function a(a,b,c,d,e,f){if(l){var g=0>c?-1:c>2*n.size_z3d?1:0,h=0>f?-1:f>2*n.size_z3d?1:0;if(g!==h||0===g){if(!L)return++H;if(0!==g){var z=f-c;c=0>g?0:2*n.size_z3d;a=d-(d-a)/z*(f-c);b=e-(e-b)/z*(f-c)}0!==h&&(g=c-f,f=0>h?0:2*n.size_z3d,d=a-(a-d)/g*(c-f),e=b-(b-e)/g*(c-f));J[k]=a;J[k+1]=b;J[k+2]=c;k+=3;J[k]=d;J[k+1]=e;J[k+2]=f;k+=3}}}function b(a,b,c,d,e,f,g,h){I>=B.length&&console.log("more than 6 points???");c=(g-c)/(f-c);f=3;0!==C&&Math.abs(c)<Math.abs(C)&&
(B[I]=B[I-3],B[I+1]=B[I-2],B[I+2]=B[I-1],I-=3,f=6);B[I]=a+c*(d-a);B[I+1]=b+c*(e-b);B[I+2]=g;h&&F&&(S[Y]=B[I],S[Y+1]=B[I+1],S[Y+2]=B[I+2],Y+=3);I+=f;C=c}function d(a,b,c){b=8*((b-h.i1)*(h.j2-h.j1)+(c-h.j1));if(0<=K[b])return console.error("More than 8 vertexes for the bin");c=b+8+K[b];K[b]--;K[c]=a}function c(a){for(var b=h.i1;b<h.i2;++b)for(var c=h.j1;c<h.j2;++c){var d=8*((b-h.i1)*(h.j2-h.j1)+(c-h.j1));if(-1!==K[d]){var e=0<=K[d]?d:d+9+K[d];d+=8;for(var f=0,g=0,z=0,l=e;l<d;++l){var q=K[l];if(0>q)return console.error("FAILURE in NORMALS RECALCULATIONS");
f+=a[q];g+=a[q+1];z+=a[q+2]}f/=d-e;g/=d-e;for(z/=d-e;e<d;++e)l=K[e],a[l]=f,a[l+1]=g,a[l+2]=z}}}function z(a,c,e,f,g,h,l,z,p,t){for(var m=1;m<x.length;++m){var n=e<x[m-1]?-1:e>x[m]?1:0,r=h<x[m-1]?-1:h>x[m]?1:0,v=p<x[m-1]?-1:p>x[m]?1:0,w=n+r+v;if(3!==w){if(-3===w)break;if(L){if(I=Y=0,0===n&&(B[I]=a,B[I+1]=c,B[I+2]=e,I+=3),n!==r&&(C=0,(0>n||0>r)&&b(a,c,e,f,g,h,x[m-1]),(0<n||0<r)&&b(a,c,e,f,g,h,x[m],!0)),0===r&&(B[I]=f,B[I+1]=g,B[I+2]=h,I+=3),r!==v&&(C=0,(0>r||0>v)&&b(f,g,h,l,z,p,x[m-1]),(0<r||0<v)&&
b(f,g,h,l,z,p,x[m],!0)),0===v&&(B[I]=l,B[I+1]=z,B[I+2]=p,I+=3),v!==n&&(C=0,(0>v||0>n)&&b(l,z,p,a,c,e,x[m-1]),(0<v||0<n)&&b(l,z,p,a,c,e,x[m],!0)),0!==I)if(9>I)console.log("found less than 3 points",I/3);else{if(F&&6===Y){for(n=0;6>n;++n)F[G+n]=S[n];G+=6}n=A[m];r=M[m];u&&9===I&&(d(r,y,q),d(r+3,y+1,t?q+1:q),d(r+6,t?y:y+1,q+1));for(v=3;v<I-3;v+=3)n[r]=B[0],n[r+1]=B[1],n[r+2]=B[2],r+=3,n[r]=B[v],n[r+1]=B[v+1],n[r+2]=B[v+2],r+=3,n[r]=B[v+3],n[r+1]=B[v+4],n[r+2]=B[v+5],r+=3;M[m]=r}}else w=Math.abs(r-n)+
Math.abs(v-r)+Math.abs(n-v),0===n&&++w,0===r&&++w,0===v&&++w,1!==w&&2!==w||console.error("FOND npnts",w),2<w&&(void 0===E[m]&&(E[m]=0),E[m]+=w-2),!(0<n||0<r||0<v)||n===r&&r===v&&v===n||++D}}}var r=this.getHisto(),n=this.getFramePainter(),h=this.prepareColorDraw({rounding:!1,use3d:!0,extra:1,middle:.5}),y,q,f,p,v=n.z_handle.gr.domain()[0],m=n.logz?function(a){return a<v?-.1:n.grz(a)}:n.grz;if(!(2>h.i2-h.i1||2>h.j2-h.j1)){var x=f=null,l=!0,g=!1,u=!1,t=null;switch(this.options.Surf){case 11:f=this.getContourLevels();
t=this.getHistPalette();break;case 12:case 15:case 17:f=this.getContourLevels();t=this.getHistPalette();l=!1;break;case 14:l=!1;u=!0;break;case 16:f=this.getContourLevels();g=!0;l=!1;break;default:f=n.z_handle.createTicks(!0),g=!0}if(f)for(x=new Float32Array(f.length),p=0;p<f.length;++p)x[p]=m(f[p]);else x=[0,2*n.size_z3d];var L,E=[],A=[],M=[],H=0,J=null,k=0,D=0,F=null,G=0,K=null,B=new Float32Array(18),I=0,C=0,S=new Float32Array(6),Y=0;if(u)for(K=new Int32Array((h.i2-h.i1)*(h.j2-h.j1)*8),f=0;f<K.length;++f)K[f]=
-1;for(L=0;2>L;++L){if(L){for(f=1;f<x.length;++f)E[f]&&(A[f]=new Float32Array(9*E[f]),M[f]=0);l&&0<H&&(J=new Float32Array(6*H));g&&0<D&&(F=new Float32Array(6*D))}for(y=h.i1;y<h.i2-1;++y){f=h.grx[y];var P=h.grx[y+1];for(q=h.j1;q<h.j2-1;++q){p=h.gry[q];var N=h.gry[q+1];var R=m(r.getBinContent(y+1,q+1));var aa=m(r.getBinContent(y+1,q+2));var W=m(r.getBinContent(y+2,q+1));var T=m(r.getBinContent(y+2,q+2));z(f,p,R,P,N,T,f,N,aa,!0);z(f,p,R,P,p,W,P,N,T,!1);a(f,N,aa,f,p,R);a(f,p,R,P,p,W);y===h.i2-2&&a(P,
p,W,P,N,T);q===h.j2-2&&a(f,N,aa,P,N,T)}}}for(m=1;m<x.length;++m)A[m]&&(M[m]!==9*E[m]&&console.error("SURF faces missmatch lvl",m,"faces",E[m],"index",M[m],"check",9*E[m]-M[m]),g=new e.BufferGeometry,g.setAttribute("position",new e.BufferAttribute(A[m],3)),g.computeVertexNormals(),u&&1===m&&c(g.getAttribute("normal").array),f=f=void 0,t?f=t.calcColor(m,x.length):(f=1<r.fFillColor?this.getColor(r.fFillColor):"white",14===this.options.Surf&&2>r.fFillColor&&(f=this.getColor(48))),f=14===this.options.Surf?
new e.MeshLambertMaterial({color:f,side:e.DoubleSide}):new e.MeshBasicMaterial({color:f,side:e.DoubleSide}),g=new e.Mesh(g,f),n.toplevel.add(g),g.painter=this);J&&(6*H!==k&&console.error("SURF lines mismmatch nsegm",H," lindx",k,"difference",6*H-k),t=this.getColor(r.fLineColor),t=new e.LineBasicMaterial({color:new e.Color(t),linewidth:r.fLineWidth}),t=w.createLineSegments(J,t),t.painter=this,n.toplevel.add(t));F&&(6*D!==G&&console.error("SURF grid draw mismatch ngridsegm",D,"gindx",G,"diff",6*D-G),
r=1===this.options.Surf?new e.LineDashedMaterial({color:0,dashSize:2,gapSize:2}):new e.LineBasicMaterial({color:new e.Color(this.getColor(r.fLineColor))}),r=w.createLineSegments(F,r),r.painter=this,n.toplevel.add(r));17===this.options.Surf&&this.drawContour3D();if(13===this.options.Surf){h=this.prepareColorDraw({rounding:!1,use3d:!0,extra:100,middle:0});r=this.getContourLevels();var V=this.getHistPalette(),U=-1,Q=2*n.size_z3d;this.buildContour(h,r,V,function(a,b,c,d,f){b[f]===b[d]&&c[f]===c[d]&&f--;
if(!(3>f-d)){for(var g=[],h=d;h<=f;++h)h!==d&&b[h]===b[h-1]&&c[h]===c[h-1]||g.push(new e.Vector2(b[h],c[h]));if(!(3>g.length)&&(d=e.ShapeUtils.triangulateShape(g,[]))&&0!==d.length){if(0>U||U!==a)U=a,Q+=1E-4*n.size_z3d;b=new Float32Array(9*d.length);c=new Float32Array(9*d.length);for(h=f=0;h<d.length;++h)for(var l=d[h],z=0;3>z;++z){var m=g[l[z]];b[f]=m.x;b[f+1]=m.y;b[f+2]=Q;c[f]=0;c[f+1]=0;c[f+2]=1;f+=3}g=new e.BufferGeometry;g.setAttribute("position",new e.BufferAttribute(b,3));g.setAttribute("normal",
new e.BufferAttribute(c,3));a=V.getColor(a);a=new e.MeshBasicMaterial({color:a,flatShading:!0,side:e.DoubleSide,opacity:.5});a=new e.Mesh(g,a);a.painter=this;n.toplevel.add(a)}}})}}};JSROOT.TH2Painter.prototype.drawError=function(){for(var a=this.getFramePainter(),b=this.getHisto(),d=this.prepareColorDraw({rounding:!1,use3d:!0,extra:1}),c=a.z_handle.gr.domain()[0],z=a.z_handle.gr.domain()[1],r,n,h,y,q,f,p,v,m,x=0,l=null,g=null,u=0,t=0;2>t;++t){for(r=d.i1;r<d.i2;++r)for(f=d.grx[r],p=d.grx[r+1],n=d.j1;n<
d.j2;++n)if(y=b.getBinContent(r+1,n+1),!(y<c||y>z)){if(q=y===c)q=this.options.Zero||0<c?!1:!this._show_empty_bins;q||(0===t?x+=3:(h=b.getBin(r+1,n+1),q=b.getBinError(h),g[u/18]=h,h=d.gry[n],v=d.gry[n+1],m=a.grz(y-q<c?c:y-q),y=a.grz(y+q>z?z:y+q),l[u]=f,l[u+3]=p,l[u+1]=l[u+4]=(h+v)/2,l[u+2]=l[u+5]=(m+y)/2,u+=6,l[u]=l[u+3]=(f+p)/2,l[u+1]=h,l[u+4]=v,l[u+2]=l[u+5]=(m+y)/2,u+=6,l[u]=l[u+3]=(f+p)/2,l[u+1]=l[u+4]=(h+v)/2,l[u+2]=m,l[u+5]=y,u+=6))}if(0===t){if(0===x)return;l=new Float32Array(6*x);g=new Int32Array(x/
3)}}b=this.getColor(this.getObject().fLineColor);b=new e.LineBasicMaterial({color:new e.Color(b),linewidth:this.getObject().fLineWidth});l=w.createLineSegments(l,b);l.painter=this;l.intersect_index=g;l.zmin=c;l.zmax=z;l.tip_color=3===this.getObject().fLineColor?16711680:65280;l.tooltip=function(a){if(isNaN(a.index))return console.error("segment index not provided, check three.js version",e.REVISION,"expected r102"),null;var b=Math.floor(a.index/6);if(0>b||b>=this.intersect_index.length)return null;
var c=this.painter;a=c.getHisto();var d=c.getFramePainter();b=c.get3DToolTip(this.intersect_index[b]);b.x1=Math.max(-d.size_xy3d,d.grx(a.fXaxis.GetBinLowEdge(b.ix)));b.x2=Math.min(d.size_xy3d,d.grx(a.fXaxis.GetBinLowEdge(b.ix+1)));b.y1=Math.max(-d.size_xy3d,d.gry(a.fYaxis.GetBinLowEdge(b.iy)));b.y2=Math.min(d.size_xy3d,d.gry(a.fYaxis.GetBinLowEdge(b.iy+1)));b.z1=d.grz(b.value-b.error<this.zmin?this.zmin:b.value-b.error);b.z2=d.grz(b.value+b.error>this.zmax?this.zmax:b.value+b.error);b.color=this.tip_color;
return b};a.toplevel.add(l)};JSROOT.TH2Painter.prototype.drawPolyLego=function(){var a=this.getHisto(),b=this.getFramePainter(),d=b.z_handle.gr.domain()[0],c=b.z_handle.gr.domain()[1],z,r=a.fBins.arr.length,n=b.grz(d),h=n;this.maxbin=this.gmaxbin;this.minbin=this.gminbin;this.minposbin=this.gminposbin;var y=this.getContour(!0),q=this.getHistPalette();for(z=0;z<r;++z){var f=a.fBins.arr[z];if(!(f.fContent<d)){var p=y.getPaletteIndex(q,f.fContent);if(null!==p&&!(f.fXmin>b.scale_xmax||f.fXmax<b.scale_xmin||
f.fYmin>b.scale_ymax||f.fYmax<b.scale_ymin)){h=b.grz(f.fContent>c?c:f.fContent);var v=[],m=[],x=1,l=f.fPoly,g=0;"TMultiGraph"==l._typename&&(x=f.fPoly.fGraphs.arr.length,l=null);for(var u=0;u<x;++u){if(!l||0<u)l=f.fPoly.fGraphs.arr[u];for(var t=l.fNpoints,L=l.fX,w=l.fY;2<t&&L[0]===L[t-1]&&w[0]===w[t-1];)--t;for(var A=void 0,k=void 0,H=0;2>H;++H){var J=void 0,O=void 0,D=void 0,F=void 0,G=b.size_xy3d*b.size_z3d,K=0<H?0:G/1E6;A=[];k=null;for(var B=0;B<t;++B)D=b.grx(L[B]),F=b.gry(w[B]),0<B&&(G=(D-J)*
(D-J)+(F-O)*(F-O)),G>K&&(A.push(new e.Vector2(D,F)),J=D,O=F);try{2<A.length&&(k=e.ShapeUtils.triangulateShape(A,[]))}catch(I){k=null}if(k&&k.length>A.length-3)break}k&&k.length&&A&&(v.push(A),m.push(k),g+=2*k.length,h>n&&(g+=2*A.length))}f=new Float32Array(9*g);for(l=x=0;l<v.length;++l){g=v[l];u=m[l];for(t=0;2>t;++t)for(L=0;L<u.length;++L)k=u[L],w=g[k[0]],A=g[k[0===t?2:1]],k=g[k[0===t?1:2]],f[x]=w.x,f[x+1]=w.y,f[x+2]=t?h:n,x+=3,f[x]=A.x,f[x+1]=A.y,f[x+2]=t?h:n,x+=3,f[x]=k.x,f[x+1]=k.y,f[x+2]=t?h:
n,x+=3;if(h>n)for(u=0;u<g.length;++u)t=g[u],L=g[0<u?u-1:g.length-1],f[x]=t.x,f[x+1]=t.y,f[x+2]=n,x+=3,f[x]=L.x,f[x+1]=L.y,f[x+2]=n,x+=3,f[x]=L.x,f[x+1]=L.y,f[x+2]=h,x+=3,f[x]=t.x,f[x+1]=t.y,f[x+2]=n,x+=3,f[x]=L.x,f[x+1]=L.y,f[x+2]=h,x+=3,f[x]=t.x,f[x+1]=t.y,f[x+2]=h,x+=3}v=new e.BufferGeometry;v.setAttribute("position",new e.BufferAttribute(f,3));v.computeVertexNormals();p=this.fPalette.getColor(p);p=new e.MeshBasicMaterial({color:p,flatShading:!0});p=new e.Mesh(v,p);b.toplevel.add(p);p.painter=this;
p.bins_index=z;p.draw_z0=n;p.draw_z1=h;p.tip_color=65280;p.tooltip=function(){var a=this.painter,b=a.getFramePainter(),c=a.getObject().fBins.arr[this.bins_index];return{use_itself:!0,x1:b.grx(c.fXmin),x2:b.grx(c.fXmax),y1:b.gry(c.fYmin),y2:b.gry(c.fYmax),z1:this.draw_z0,z2:this.draw_z1,bin:this.bins_index,value:c.fContent,color:this.tip_color,lines:a.getPolyBinTooltips(this.bins_index)}}}}}};N.prototype=Object.create(JSROOT.THistPainter.prototype);N.prototype.scanContent=function(a){if(!(a&&this.nbinsx&&
this.nbinsy&&this.nbinsz)){a=this.getObject();this.extractAxesProperties(3);this.gminbin=this.gmaxbin=a.getBinContent(1,1,1);for(var b=0;b<this.nbinsx;++b)for(var d=0;d<this.nbinsy;++d)for(var c=0;c<this.nbinsz;++c){var e=a.getBinContent(b+1,d+1,c+1);e<this.gminbin?this.gminbin=e:e>this.gmaxbin&&(this.gmaxbin=e)}this.draw_content=0<this.gmaxbin}};N.prototype.countStat=function(){var a=this.getHisto(),b=a.fXaxis,d=a.fYaxis,c=a.fZaxis,e=0,r=0,n=0,h=0,y=0,q=0,f=0,p=this.getSelectIndex("x","left"),v=
this.getSelectIndex("x","right"),m=this.getSelectIndex("y","left"),x=this.getSelectIndex("y","right"),l=this.getSelectIndex("z","left"),g=this.getSelectIndex("z","right"),u=this.getFramePainter(),t={name:a.fName,entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},w,k,A;for(w=0;w<this.nbinsx+2;++w){var M=b.GetBinCoord(w-.5);var H=w<p?0:w>v?2:1;for(k=0;k<this.nbinsy+2;++k){var J=d.GetBinCoord(k-.5);var O=k<m?0:k>x?2:1;for(A=0;A<this.nbinsz+2;++A){var D=c.GetBinCoord(A-.5);var F=A<l?0:
A>g?2:1;var G=a.getBinContent(w,k,A);t.entries+=G;1==H&&1==O&&1==F&&(e+=G,r+=M*G,n+=J*G,h+=D*G,y+=M*M*G,q+=J*J*G,f+=D*D*G)}}}0<a.fTsumw&&!u.isAxisZoomed("x")&&!u.isAxisZoomed("y")&&!u.isAxisZoomed("z")&&(e=a.fTsumw,r=a.fTsumwx,y=a.fTsumwx2,n=a.fTsumwy,q=a.fTsumwy2,h=a.fTsumwz,f=a.fTsumwz2);0<e&&(t.meanx=r/e,t.meany=n/e,t.meanz=h/e,t.rmsx=Math.sqrt(Math.abs(y/e-t.meanx*t.meanx)),t.rmsy=Math.sqrt(Math.abs(q/e-t.meany*t.meany)),t.rmsz=Math.sqrt(Math.abs(f/e-t.meanz*t.meanz)));t.integral=e;1<a.fEntries&&
(t.entries=a.fEntries);return t};N.prototype.fillStatistic=function(a,b,d){if(this.isIgnoreStatsFill())return!1;var c=this.countStat(),e=b%10,r=Math.floor(b/10)%10,n=Math.floor(b/100)%10,h=Math.floor(b/1E3)%10;b=Math.floor(b/1E6)%10;a.clearPave();0<e&&a.addText(c.name);0<r&&a.addText("Entries = "+a.format(c.entries,"entries"));0<n&&(a.addText("Mean x = "+a.format(c.meanx)),a.addText("Mean y = "+a.format(c.meany)),a.addText("Mean z = "+a.format(c.meanz)));0<h&&(a.addText("Std Dev x = "+a.format(c.rmsx)),
a.addText("Std Dev y = "+a.format(c.rmsy)),a.addText("Std Dev z = "+a.format(c.rmsz)));0<b&&a.addText("Integral = "+a.format(c.integral,"entries"));d&&a.fillFunctionStat(this.findFunction("TF3"),d);return!0};N.prototype.getBinTooltips=function(a,b,d){var c=[],e=this.getHisto();c.push(this.getObjectHint());c.push("x = "+this.getAxisBinTip("x",e.fXaxis,a)+"  xbin="+(a+1));c.push("y = "+this.getAxisBinTip("y",e.fYaxis,b)+"  ybin="+(b+1));c.push("z = "+this.getAxisBinTip("z",e.fZaxis,d)+"  zbin="+(d+
1));a=e.getBinContent(a+1,b+1,d+1);a===Math.round(a)?c.push("entries = "+a):c.push("entries = "+w.floatToString(a,JSROOT.gStyle.fStatFormat));return c};N.prototype.draw3DScatter=function(){var a=this.getObject(),b=this.getFramePainter(),d=this.getSelectIndex("x","left",.5),c=this.getSelectIndex("x","right",0),z=this.getSelectIndex("y","left",.5),r=this.getSelectIndex("y","right",0),n=this.getSelectIndex("z","left",.5),h=this.getSelectIndex("z","right",0),y,q,f;if(c<=d||r<=z||h<=n)return!0;var p=1E3<
this.gmaxbin?1E3/this.gmaxbin:1,v=0,m=0,x=Math.max(0,this.gminbin);for(y=d;y<c;++y)for(q=z;q<r;++q)for(f=n;f<h;++f){var l=a.getBinContent(y+1,q+1,f+1);m+=l;l<=x||(v+=Math.round(l*p))}if(v>(b.webgl?1E5:3E4))return!1;JSROOT.seed(m);m=new w.PointsCreator(v,b.webgl,b.size_xy3d/200);v=new Int32Array(v);var g=0;for(y=d;y<c;++y)for(q=z;q<r;++q)for(f=n;f<h;++f)if(l=a.getBinContent(y+1,q+1,f+1),!(l<=x))for(d=Math.round(l*p),l=0;l<d;++l){var u=a.fXaxis.GetBinCoord(y+JSROOT.random()),t=a.fYaxis.GetBinCoord(q+
JSROOT.random()),k=a.fZaxis.GetBinCoord(f+JSROOT.random());v[g++]=a.getBin(y+1,q+1,f+1);m.addPoint(b.grx(u),b.gry(t),b.grz(k))}c=m.createPoints(this.getColor(a.fMarkerColor));b.toplevel.add(c);c.bins=v;c.painter=this;c.tip_color=3===a.fMarkerColor?16711680:65280;c.tooltip=function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",e.REVISION,"expected r102"),null;var b=Math.floor(a.index/this.nvertex);if(0>b||b>=this.bins.length)return null;var c=this.painter;
a=c.getHisto();var d=c.getFramePainter();b=c.get3DToolTip(this.bins[b]);b.x1=d.grx(a.fXaxis.GetBinLowEdge(b.ix));b.x2=d.grx(a.fXaxis.GetBinLowEdge(b.ix+1));b.y1=d.gry(a.fYaxis.GetBinLowEdge(b.iy));b.y2=d.gry(a.fYaxis.GetBinLowEdge(b.iy+1));b.z1=d.grz(a.fZaxis.GetBinLowEdge(b.iz));b.z2=d.grz(a.fZaxis.GetBinLowEdge(b.iz+1));b.color=this.tip_color;b.opacity=.3;return b};return!0};N.prototype.draw3DBins=function(){if(this.draw_content&&(this.options.Box||this.options.GLBox||this.options.GLColor||this.options.Lego||
!this.draw3DScatter())){var a=this.getObject().fFillColor,b=this.getColor(a),d=this.getFramePainter(),c=0,z=!1,r=!1,n=!1,h=1,y=!0,q=this.options.Box?this.options.BoxStyle:0,f=.5;!q&&this.options.Lego&&(q=1===this.options.Lego?10:this.options.Lego);if(11===this.options.GLBox||12===this.options.GLBox){f=.4;z=!0;12===this.options.GLBox&&(n=!0);q=d.webgl?new e.SphereGeometry(.5,16,12):new e.SphereGeometry(.5,8,6);q.applyMatrix4((new e.Matrix4).makeRotationX(Math.PI/2));c=9*q.faces.length;var p=new Float32Array(c);
var v=new Float32Array(c);for(var m=0;m<q.faces.length;++m)p[9*m]=q.vertices[q.faces[m].a].x,p[9*m+1]=q.vertices[q.faces[m].a].y,p[9*m+2]=q.vertices[q.faces[m].a].z,p[9*m+3]=q.vertices[q.faces[m].b].x,p[9*m+4]=q.vertices[q.faces[m].b].y,p[9*m+5]=q.vertices[q.faces[m].b].z,p[9*m+6]=q.vertices[q.faces[m].c].x,p[9*m+7]=q.vertices[q.faces[m].c].y,p[9*m+8]=q.vertices[q.faces[m].c].z,v[9*m]=q.faces[m].vertexNormals[0].x,v[9*m+1]=q.faces[m].vertexNormals[0].y,v[9*m+2]=q.faces[m].vertexNormals[0].z,v[9*m+
3]=q.faces[m].vertexNormals[1].x,v[9*m+4]=q.faces[m].vertexNormals[1].y,v[9*m+5]=q.faces[m].vertexNormals[1].z,v[9*m+6]=q.faces[m].vertexNormals[2].x,v[9*m+7]=q.faces[m].vertexNormals[2].y,v[9*m+8]=q.faces[m].vertexNormals[2].z}else{m=w.Box3D.Indexes;var x=w.Box3D.Normals,l=w.Box3D.Vertices;c=3*m.length;p=new Float32Array(c);v=new Float32Array(c);for(var g=0,u=-3;g<m.length;++g){var t=l[m[g]];p[3*g]=t.x-.5;p[3*g+1]=t.y-.5;p[3*g+2]=t.z-.5;0===g%6&&(u+=3);v[3*g]=x[u];v[3*g+1]=x[u+1];v[3*g+2]=x[u+2]}r=
!0;12===q?n=!0:13===q?(n=!0,r=!1):this.options.GLColor&&(n=!0,h=.5,r=y=!1,z=!0)}y&&(y=this.gminbin||this.gmaxbin?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1);var k=this.getHisto(),E=this.getSelectIndex("x","left",.5),A=this.getSelectIndex("x","right",0),C=this.getSelectIndex("y","left",.5),H=this.getSelectIndex("y","right",0),J=this.getSelectIndex("z","left",.5),O=this.getSelectIndex("z","right",0);if(!(A<=E||H<=C||O<=J)){q=(d.grx(k.fXaxis.GetBinLowEdge(A+1))-d.grx(k.fXaxis.GetBinLowEdge(E+
1)))/(A-E);m=(d.gry(k.fYaxis.GetBinLowEdge(H+1))-d.gry(k.fYaxis.GetBinLowEdge(C+1)))/(H-C);x=(d.grz(k.fZaxis.GetBinLowEdge(O+1))-d.grz(k.fZaxis.GetBinLowEdge(J+1)))/(O-J);var D=0,F,G,K;l=[];var B=0;g=[];var I=n?this.getContour():null,P=n?this.getHistPalette():null;for(F=E;F<A;++F)for(G=C;G<H;++G)for(K=J;K<O;++K){var S=k.getBinContent(F+1,G+1,K+1);if(this.options.GLColor||!(0===S||S<this.gminbin)){var N=y?Math.pow(Math.abs(S*y),.3333):1;.001>N||(D++,n&&(u=I.getPaletteIndex(P,S),null!==u?(void 0===
l[u]&&(l[u]=0,g[u]=B++),l[u]+=1):console.error("not found color for",S)))}}n||(l.push(D),B=1,g=[0]);var ca=Array(B);u=Array(B);t=Array(B);var ia=Array(B),R=Array(B),aa=Array(B);B=Array(B);for(F=0;F<l.length;++F)l[F]&&(D=l[F],G=g[F],ca[G]=0,R[G]=0,r&&(R[G]=65520<D*c/3?2:1),u[G]=new Float32Array(D*c),t[G]=new Float32Array(D*c),ia[G]=new Int32Array(D),1===R[G]&&(aa[G]=new Uint16Array(D*w.Box3D.MeshSegments.length)),2===R[G]&&(B[G]=new Float32Array(D*w.Box3D.Segments.length*3)));for(F=E;F<A;++F)for(D=
k.fXaxis.GetBinCenter(F+1),r=d.grx(D),G=C;G<H;++G)for(D=k.fYaxis.GetBinCenter(G+1),E=d.gry(D),K=J;K<O;++K)if(S=k.getBinContent(F+1,G+1,K+1),this.options.GLColor||!(0===S||S<this.gminbin))if(N=y?Math.pow(Math.abs(S*y),.3333):1,!(.001>N)){var W=0;if(n){D=I.getPaletteIndex(P,S);if(null===D)continue;W=g[D]}D=ca[W];S=k.fZaxis.GetBinCenter(K+1);S=d.grz(S);ia[W][D]=k.getBin(F+1,G+1,K+1);for(var T=D*c,V=u[W],U=t[W],Q=0;Q<c;Q+=3,T+=3)V[T]=r+p[Q]*q*N,V[T+1]=E+p[Q+1]*m*N,V[T+2]=S+p[Q+2]*x*N,U[T]=v[Q],U[T+1]=
v[Q+1],U[T+2]=v[Q+2];if(1===R[W]){V=w.Box3D.MeshSegments;T=D*V.length;U=Math.round(D*c/3);Q=aa[W];for(var X=0;X<V.length;++X)Q[T+X]=U+V[X]}if(2===R[W])for(V=w.Box3D.Segments,U=B[W],T=D*V.length*3,Q=0;Q<V.length;++Q,T+=3)X=w.Box3D.Vertices[V[Q]],U[T]=r+(X.x-.5)*q*N,U[T+1]=E+(X.y-.5)*m*N,U[T+2]=S+(X.z-.5)*x*N;ca[W]=D+1}for(p=0;p<l.length;++p)l[p]&&(D=l[p],v=g[p],k=new e.BufferGeometry,k.setAttribute("position",new e.BufferAttribute(u[v],3)),k.setAttribute("normal",new e.BufferAttribute(t[v],3)),n&&
(b=this.fPalette.getColor(p)),A=z?new e.MeshLambertMaterial({color:b,opacity:h,transparent:1>h}):new e.MeshBasicMaterial({color:b,opacity:h}),k=new e.Mesh(k,A),k.bins=ia[v],k.bins_faces=c/9,k.painter=this,k.scalex=f*q,k.scaley=f*m,k.scalez=f*x,k.tip_color=3===a?16711680:65280,k.use_scale=y,k.tooltip=function(a){if(isNaN(a.faceIndex))return console.error("intersect.faceIndex not provided, check three.js version",e.REVISION,"expected r102"),null;var b=Math.floor(a.faceIndex/this.bins_faces);if(0>b||
b>=this.bins.length)return null;var c=this.painter;a=c.getHisto();var d=c.getFramePainter();b=c.get3DToolTip(this.bins[b]);c=d.grx(a.fXaxis.GetBinCoord(b.ix-.5));var f=d.gry(a.fYaxis.GetBinCoord(b.iy-.5));a=d.grz(a.fZaxis.GetBinCoord(b.iz-.5));d=this.use_scale?Math.pow(Math.abs(b.value*this.use_scale),.3333):1;b.x1=c-this.scalex*d;b.x2=c+this.scalex*d;b.y1=f-this.scaley*d;b.y2=f+this.scaley*d;b.z1=a-this.scalez*d;b.z2=a+this.scalez*d;b.color=this.tip_color;return b},d.toplevel.add(k),0<R[v]&&(k=this.getColor(this.getObject().fLineColor),
k=new e.LineBasicMaterial({color:k}),A=null,A=1===R[v]?w.createLineSegments(u[v],k,aa[v]):w.createLineSegments(B[v],k),d.toplevel.add(A)))}}};N.prototype.redraw=function(a){var b=this.getFramePainter(),d=this.getHisto();"resize"==a?b.resize3D()&&b.render3D():(b.create3DScene(this.options.Render3D),b.setAxesRanges(d.fXaxis,this.xmin,this.xmax,d.fYaxis,this.ymin,this.ymax,d.fZaxis,this.zmin,this.zmax),b.set3DOptions(this.options),b.drawXYZ(b.toplevel,{zoom:JSROOT.settings.Zooming,ndim:3}),this.draw3DBins(),
b.render3D(),this.updateStatWebCanvas(),b.addKeysHandler());return this.drawHistTitle()};N.prototype.fillToolbar=function(){var a=this.getPadPainter();a&&(a.addPadButton("auto_zoom","Unzoom all axes","ToggleZoom","Ctrl *"),this.draw_content&&a.addPadButton("statbox","Toggle stat box","ToggleStatBox"),a.showPadButtons())};N.prototype.canZoomInside=function(a,b,d){var c=this.getHisto();c&&(c=c["f"+a.toUpperCase()+"axis"]);return!c||1<c.FindBin(d,.5)-c.FindBin(b,0)};N.prototype.autoZoom=function(){var a=
this.getSelectIndex("x","left"),b=this.getSelectIndex("x","right"),d=this.getSelectIndex("y","left"),c=this.getSelectIndex("y","right"),e=this.getSelectIndex("z","left"),r=this.getSelectIndex("z","right"),n,h,y,q=this.getObject();if(a!==b&&d!==c&&e!==r){var f=q.getBinContent(a+1,d+1,e+1);for(n=a;n<b;++n)for(h=d;h<c;++h)for(y=e;y<r;++y)f=Math.min(f,q.getBinContent(n+1,h+1,y+1));if(!(0<f)){var p=b,v=a,m=c,k=d,l=r,g=e;for(n=a;n<b;++n)for(h=d;h<c;++h)for(y=e;y<r;++y)q.getBinContent(n+1,h+1,y+1)>f&&(n<
p&&(p=n),n>=v&&(v=n+1),h<m&&(m=h),h>=k&&(k=h+1),y<l&&(l=y),y>=g&&(g=y+1));n=!1;p===v-1&&p>a+1&&v<b-1&&(p--,v++);m===k-1&&m>d+1&&k<c-1&&(m--,k++);l===g-1&&l>e+1&&g<r-1&&(l--,g++);if((p>a||v<b)&&p<v-1){var u=q.fXaxis.GetBinLowEdge(p+1);var t=q.fXaxis.GetBinLowEdge(v+1);n=!0}if((m>d||k<c)&&m<k-1){var w=q.fYaxis.GetBinLowEdge(m+1);var E=q.fYaxis.GetBinLowEdge(k+1);n=!0}if((l>e||g<r)&&l<g-1){var A=q.fZaxis.GetBinLowEdge(l+1);var C=q.fZaxis.GetBinLowEdge(g+1);n=!0}n&&this.getFramePainter().zoom(u,t,w,E,
A,C)}}};N.prototype.fillHistContextMenu=function(a){var b=this,d=w.getDrawSettings("ROOT."+this.getObject()._typename,"nosame");a.addDrawMenu("Draw with",d.opts,function(a){if("inspect"===a)return b.showInspector();b.decodeOptions(a);b.interactiveRedraw(!0,"drawopt")})};w.drawHistogram3D=function(a,b,d){var c=new JSROOT.TH3Painter(a,b);return w.ensureTCanvas(c,"3d").then(function(){c.setAsMainPainter();c.decodeOptions(d);c.checkPadRange();c.scanContent();return c.redraw()}).then(function(){var b=
c.createStat();if(b)return JSROOT.draw(a,b,"")}).then(function(){c.fillToolbar();return c})};ca.prototype=Object.create(JSROOT.ObjectPainter.prototype);ca.prototype.decodeOptions=function(a){var b=new JSROOT.DrawOptions(a);this.options||(this.options={});var d=this.options;d.Color=b.check("COL");d.Line=b.check("LINE");d.Error=b.check("ERR")&&this.matchObjectType("TGraph2DErrors");d.Circles=b.check("P0");d.Markers=b.check("P");d.Markers||d.Error||d.Circles||d.Line||(d.Markers=!0);d.Markers||(d.Color=
!1);this.storeDrawOpt(a)};ca.prototype.createHistogram=function(){for(var a=this.getObject(),b=a.fX[0],d=b,c=a.fY[0],e=c,r=a.fZ[0],n=r,h=0;h<a.fNpoints;++h){var k=a.fX[h],q=a.fY[h],f=a.fZ[h],p=this.options.Error?a.fEX[h]:0,v=this.options.Error?a.fEY[h]:0,m=this.options.Error?a.fEZ[h]:0;b=Math.min(b,k-p);d=Math.max(d,k+p);c=Math.min(c,q-v);e=Math.max(e,q+v);r=Math.min(r,f-m);n=Math.max(n,f+m)}b>=d&&(d=b+1);c>=e&&(e=c+1);r>=n&&(n=r+1);h=.02*(d-b);q=.02*(e-c);p=.02*(n-r);a=b-h;h=d+h;k=c-q;q=e+q;f=r-
p;p=n+p;0>a&&0<=b&&(a=.98*b);0<h&&0>=d&&(h=0);0>k&&0<=c&&(k=.98*c);0<q&&0>=e&&(q=0);0>f&&0<=r&&(f=.98*r);0<p&&0>=n&&(p=0);d=this.getObject();-1111!=d.fMinimum&&(f=d.fMinimum);-1111!=d.fMaximum&&(p=d.fMaximum);b=JSROOT.createHistogram("TH2I",10,10);b.fName=d.fName+"_h";b.fTitle=d.fTitle;b.fXaxis.fXmin=a;b.fXaxis.fXmax=h;b.fYaxis.fXmin=k;b.fYaxis.fXmax=q;b.fZaxis.fXmin=f;b.fZaxis.fXmax=p;b.fMinimum=f;b.fMaximum=p;d=JSROOT.BIT(9);b.fBits|=d;return b};ca.prototype.redraw=function(){function a(a,b){for(var d=
0,e=0;e<k.fNpoints;++e)k.fX[e]<c.scale_xmin||k.fX[e]>c.scale_xmax||k.fY[e]<c.scale_ymin||k.fY[e]>c.scale_ymax||k.fZ[e]<a||k.fZ[e]>=b||++d;return d}function b(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",e.REVISION,"expected r121"),null;var b=Math.floor(a.index/this.nvertex);if(0>b||b>=this.index.length)return null;b=this.index[b];var c=this.painter,d=c.grx(this.graph.fX[b]),f=c.gry(this.graph.fY[b]),g=c.grz(this.graph.fZ[b]);if(this.check_next&&
b+1<this.graph.fX.length){var h=function(a){return a*a};a=a.point;var k=c.grx(this.graph.fX[b+1]),l=c.gry(this.graph.fY[b+1]),m=c.grz(this.graph.fZ[b+1]);h(a.x-k)+h(a.y-l)+h(a.z-m)<h(a.x-d)+h(a.y-f)+h(a.z-g)&&(d=k,f=l,g=m,b++)}return{x1:d-this.scale0,x2:d+this.scale0,y1:f-this.scale0,y2:f+this.scale0,z1:g-this.scale0,z2:g+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+b,"x: "+c.axisAsText("x",this.graph.fX[b]),"y: "+c.axisAsText("y",this.graph.fY[b]),"z: "+c.axisAsText("z",this.graph.fZ[b])]}}
var d=this.getMainPainter(),c=this.getFramePainter(),k=this.getObject(),r=1;if(k&&d&&c&&c.mode3d){if(0<JSROOT.settings.OptimizeDraw&&!c.webgl){var n=a(c.scale_zmin,c.scale_zmax);5E4<n&&(r=Math.floor(n/5E4),2>=r&&(r=2))}var h=new JSROOT.TAttMarkerHandler(k);n=null;var y=[c.scale_zmin,c.scale_zmax];h=c.size_xy3d/100*h.getFullSize();this.options.Circles&&(h=.06*c.size_xy3d);c.usesvg&&(h*=.3);this.options.Color&&(y=d.getContourLevels(),n=d.getHistPalette());for(d=0;d<y.length-1;++d){var q=Math.max(y[d],
c.scale_zmin),f=Math.min(y[d+1],c.scale_zmax);if(!(q>=f)){var p=Math.floor(a(q,f)/r),v=null,m=0,x=new Int32Array(p),l=0,g=null,u=null,t=0,C=0;if(this.options.Markers||this.options.Circles)v=new w.PointsCreator(p,c.webgl,h/3);this.options.Error&&(g=new Float32Array(18*p));this.options.Line&&(u=new Float32Array(6*(p-1)));for(p=0;p<k.fNpoints;++p)if(!(k.fX[p]<c.scale_xmin||k.fX[p]>c.scale_xmax||k.fY[p]<c.scale_ymin||k.fY[p]>c.scale_ymax||k.fZ[p]<q||k.fZ[p]>=f)){if(1<r&&(m=(m+1)%r,0!==m))continue;x[l++]=
p;var E=c.grx(k.fX[p]),A=c.gry(k.fY[p]),M=c.grz(k.fZ[p]);v&&v.addPoint(E,A,M);g&&(g[t]=c.grx(k.fX[p]-k.fEX[p]),g[t+1]=A,g[t+2]=M,g[t+3]=c.grx(k.fX[p]+k.fEX[p]),g[t+4]=A,g[t+5]=M,t+=6,g[t]=E,g[t+1]=c.gry(k.fY[p]-k.fEY[p]),g[t+2]=M,g[t+3]=E,g[t+4]=c.gry(k.fY[p]+k.fEY[p]),g[t+5]=M,t+=6,g[t]=E,g[t+1]=A,g[t+2]=c.grz(k.fZ[p]-k.fEZ[p]),g[t+3]=E,g[t+4]=A,g[t+5]=c.grz(k.fZ[p]+k.fEZ[p]),t+=6);u&&(6<=C&&(u[C]=u[C-3],u[C+1]=u[C-2],u[C+2]=u[C-1],C+=3),u[C]=E,u[C+1]=A,u[C+2]=M,C+=3)}u&&3<C&&u.length==C&&(q=this.getColor(this.getObject().fLineColor),
q=new e.LineBasicMaterial({color:new e.Color(q),linewidth:this.getObject().fLineWidth}),u=w.createLineSegments(u,q),c.toplevel.add(u),u.graph=k,u.index=x,u.painter=c,u.scale0=.7*h,u.tip_name=this.getObjectHint(),u.tip_color=3===k.fMarkerColor?16711680:65280,u.nvertex=2,u.check_next=!0,u.tooltip=b);g&&(u=this.getColor(this.getObject().fLineColor),u=new e.LineBasicMaterial({color:new e.Color(u),linewidth:this.getObject().fLineWidth}),g=w.createLineSegments(g,u),c.toplevel.add(g),g.graph=k,g.index=x,
g.painter=c,g.scale0=.7*h,g.tip_name=this.getObjectHint(),g.tip_color=3===k.fMarkerColor?16711680:65280,g.nvertex=6,g.tooltip=b);v&&(g="blue",this.options.Circles||(g=n?n.calcColor(d,y.length):this.getColor(k.fMarkerColor)),v=v.createPoints({color:g,style:this.options.Circles?4:k.fMarkerStyle}),v.graph=k,v.painter=c,v.tip_color=3===k.fMarkerColor?16711680:65280,v.scale0=.3*h,v.index=x,v.tip_name=this.getObjectHint(),v.tooltip=b,c.toplevel.add(v))}}c.render3D(100)}};w.drawGraph2D=function(a,b,d){var c=
new JSROOT.TGraph2DPainter(a,b);c.decodeOptions(d);d=Promise.resolve(!0);c.getMainPainter()||(b.fHistogram||(b.fHistogram=c.createHistogram()),d=JSROOT.draw(a,b.fHistogram,"lego;axis"),c.ownhisto=!0);return d.then(function(){c.addToPadPrimitives();c.redraw();return c})};w.drawPolyMarker3D=function(){var a=this.getFramePainter();if(!a||!a.mode3d||!a.toplevel)return Promise.reject(Error("Fail to draw poly markers without 3D mode"));for(var b=1,d=0,c=this.getObject(),k=0;k<c.fP.length;k+=3)c.fP[k]<a.scale_xmin||
c.fP[k]>a.scale_xmax||c.fP[k+1]<a.scale_ymin||c.fP[k+1]>a.scale_ymax||c.fP[k+2]<a.scale_zmin||c.fP[k+2]>a.scale_zmax||++d;0<JSROOT.settings.OptimizeDraw&&5E4<d&&(b=Math.floor(d/5E4),2>=b&&(b=2));k=Math.floor(d/b);d=new w.PointsCreator(k,a.webgl,a.size_xy3d/100);k=new Int32Array(k);for(var r=0,n=0,h=0;h<c.fP.length;h+=3)if(!(c.fP[h]<a.scale_xmin||c.fP[h]>a.scale_xmax||c.fP[h+1]<a.scale_ymin||c.fP[h+1]>a.scale_ymax||c.fP[h+2]<a.scale_zmin||c.fP[h+2]>a.scale_zmax)){if(1<b&&(r=(r+1)%b,0!==r))continue;
k[n++]=h;d.addPoint(a.grx(c.fP[h]),a.gry(c.fP[h+1]),a.grz(c.fP[h+2]))}b=d.createPoints({color:this.getColor(c.fMarkerColor),style:c.fMarkerStyle});b.tip_color=3===c.fMarkerColor?16711680:65280;b.tip_name=c.fName||"Poly3D";b.poly=c;b.painter=a;b.scale0=.7*d.scale;b.index=k;a.toplevel.add(b);b.tooltip=function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",e.REVISION,"expected r102"),null;a=Math.floor(a.index/this.nvertex);if(0>a||a>=this.index.length)return null;
a=this.index[a];var b=this.painter,c=b.grx(this.poly.fP[a]),d=b.gry(this.poly.fP[a+1]),h=b.grz(this.poly.fP[a+2]);return{x1:c-this.scale0,x2:c+this.scale0,y1:d-this.scale0,y2:d+this.scale0,z1:h-this.scale0,z2:h+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+a/3,"x: "+b.axisAsText("x",this.poly.fP[a]),"y: "+b.axisAsText("y",this.poly.fP[a+1]),"z: "+b.axisAsText("z",this.poly.fP[a+2])]}};a.render3D(100);return Promise.resolve(this)};JSROOT.TH3Painter=N;JSROOT.TGraph2DPainter=ca;return JSROOT});
