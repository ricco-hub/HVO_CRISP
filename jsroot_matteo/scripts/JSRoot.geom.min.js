var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(p){var f=0;return function(){return f<p.length?{done:!1,value:p[f++]}:{done:!0}}};$jscomp.arrayIterator=function(p){return{next:$jscomp.arrayIteratorImpl(p)}};$jscomp.makeIterator=function(p){var f="undefined"!=typeof Symbol&&Symbol.iterator&&p[Symbol.iterator];return f?f.call(p):$jscomp.arrayIterator(p)};
$jscomp.getGlobal=function(p){return"undefined"!=typeof window&&window===p?p:"undefined"!=typeof global&&null!=global?global:p};$jscomp.global=$jscomp.getGlobal(this);$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(p,f,g){p!=Array.prototype&&p!=Object.prototype&&(p[f]=g.value)};
$jscomp.polyfill=function(p,f,g,r){if(f){g=$jscomp.global;p=p.split(".");for(r=0;r<p.length-1;r++){var m=p[r];m in g||(g[m]={});g=g[m]}p=p[p.length-1];r=g[p];f=f(r);f!=r&&null!=f&&$jscomp.defineProperty(g,p,{configurable:!0,writable:!0,value:f})}};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(p){function f(){this.batch_=null}function g(e){return e instanceof m?e:new m(function(f,a){f(e)})}if(p&&!$jscomp.FORCE_POLYFILL_PROMISE)return p;f.prototype.asyncExecute=function(e){if(null==this.batch_){this.batch_=[];var f=this;this.asyncExecuteFunction(function(){f.executeBatch_()})}this.batch_.push(e)};var r=$jscomp.global.setTimeout;f.prototype.asyncExecuteFunction=function(e){r(e,0)};f.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var e=
this.batch_;this.batch_=[];for(var f=0;f<e.length;++f){var a=e[f];e[f]=null;try{a()}catch(b){this.asyncThrow_(b)}}}this.batch_=null};f.prototype.asyncThrow_=function(e){this.asyncExecuteFunction(function(){throw e;})};var m=function(e){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var f=this.createResolveAndReject_();try{e(f.resolve,f.reject)}catch(a){f.reject(a)}};m.prototype.createResolveAndReject_=function(){function e(b){return function(c){a||(a=!0,b.call(f,c))}}var f=this,a=!1;
return{resolve:e(this.resolveTo_),reject:e(this.reject_)}};m.prototype.resolveTo_=function(e){if(e===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(e instanceof m)this.settleSameAsPromise_(e);else{a:switch(typeof e){case "object":var f=null!=e;break a;case "function":f=!0;break a;default:f=!1}f?this.resolveToNonPromiseObj_(e):this.fulfill_(e)}};m.prototype.resolveToNonPromiseObj_=function(e){var f=void 0;try{f=e.then}catch(a){this.reject_(a);return}"function"==typeof f?
this.settleSameAsThenable_(f,e):this.fulfill_(e)};m.prototype.reject_=function(e){this.settle_(2,e)};m.prototype.fulfill_=function(e){this.settle_(1,e)};m.prototype.settle_=function(e,f){if(0!=this.state_)throw Error("Cannot settle("+e+", "+f+"): Promise already settled in state"+this.state_);this.state_=e;this.result_=f;this.executeOnSettledCallbacks_()};m.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var e=0;e<this.onSettledCallbacks_.length;++e)x.asyncExecute(this.onSettledCallbacks_[e]);
this.onSettledCallbacks_=null}};var x=new f;m.prototype.settleSameAsPromise_=function(e){var f=this.createResolveAndReject_();e.callWhenSettled_(f.resolve,f.reject)};m.prototype.settleSameAsThenable_=function(e,f){var a=this.createResolveAndReject_();try{e.call(f,a.resolve,a.reject)}catch(b){a.reject(b)}};m.prototype.then=function(e,f){function a(a,d){return"function"==typeof a?function(d){try{b(a(d))}catch(t){c(t)}}:d}var b,c,d=new m(function(a,d){b=a;c=d});this.callWhenSettled_(a(e,b),a(f,c));return d};
m.prototype.catch=function(f){return this.then(void 0,f)};m.prototype.callWhenSettled_=function(f,g){function a(){switch(b.state_){case 1:f(b.result_);break;case 2:g(b.result_);break;default:throw Error("Unexpected state: "+b.state_);}}var b=this;null==this.onSettledCallbacks_?x.asyncExecute(a):this.onSettledCallbacks_.push(a)};m.resolve=g;m.reject=function(f){return new m(function(e,a){a(f)})};m.race=function(f){return new m(function(e,a){for(var b=$jscomp.makeIterator(f),c=b.next();!c.done;c=b.next())g(c.value).callWhenSettled_(e,
a)})};m.all=function(f){var e=$jscomp.makeIterator(f),a=e.next();return a.done?g([]):new m(function(b,c){function d(a){return function(c){k[a]=c;h--;0==h&&b(k)}}var k=[],h=0;do k.push(void 0),h++,g(a.value).callWhenSettled_(d(k.length-1),c),a=e.next();while(!a.done)})};return m},"es6","es3");
JSROOT.define(["d3","three","geobase","painter","base3d"],function(p,f,g,r){function m(a,b){this.bright=b;this.element=a.append("div").attr("class","geo_toolbar_group")}function x(a){r.InteractiveControl.call(this);this.mesh=a&&a.material?a:null}function e(a,b){b&&"TGeoManager"===b._typename&&(this.geo_manager=b,b=b.fMasterVolume);b&&0===b._typename.indexOf("TGeoVolume")&&(b={_typename:"TGeoNode",fVolume:b,fName:b.fName,$geoh:b.$geoh,_proxy:!0});JSROOT.ObjectPainter.call(this,a,b);this.mode3d=this.no_default_title=
!0;this.drawing_stage=0;this.ctrl={clipIntersect:!0,clip:[{name:"x",enabled:!1,value:0,min:-100,max:100},{name:"y",enabled:!1,value:0,min:-100,max:100},{name:"z",enabled:!1,value:0,min:-100,max:100}],ssao:{enabled:!1,output:f.SSAOPass.OUTPUT.Default,kernelRadius:0,minDistance:.001,maxDistance:.1},info:{num_meshes:0,num_faces:0,num_shapes:0},highlight:!1,highlight_scene:!1,depthTest:!0,depthMethod:"dflt",select_in_view:!1,update_browser:!0,light:{kind:"points",top:!1,bottom:!1,left:!1,right:!1,front:!1,
specular:!0,power:1},trans_radial:0,trans_z:0};this.ctrl.depthMethodItems=[{name:"Default",value:"dflt"},{name:"Raytraicing",value:"ray"},{name:"Boundary box",value:"box"},{name:"Mesh size",value:"size"},{name:"Central point",value:"pnt"}];this.ctrl.ssao.outputItems=[{name:"Default",value:f.SSAOPass.OUTPUT.Default},{name:"SSAO Only",value:f.SSAOPass.OUTPUT.SSAO},{name:"SSAO Only + Blur",value:f.SSAOPass.OUTPUT.Blur},{name:"Beauty",value:f.SSAOPass.OUTPUT.Beauty},{name:"Depth",value:f.SSAOPass.OUTPUT.Depth},
{name:"Normal",value:f.SSAOPass.OUTPUT.Normal}];this.cleanup(!0)}JSROOT.loadScript("$$$style/JSRoot.geom");m.prototype.addButtons=function(a){var b=this;this.buttonsNames=[];JSROOT.require(["interactive"]).then(function(c){a.forEach(function(a){var d=a.name;if(!d)throw Error("must provide button 'name' in button config");if(-1!==b.buttonsNames.indexOf(d))throw Error("button name '"+d+"' is taken");b.buttonsNames.push(d);d=a.title||a.name;if("function"!==typeof a.click)throw Error("must provide button 'click' function in button config");
var h=b.element.append("a").attr("class",b.bright?"geo_toolbar_btn_bright":"geo_toolbar_btn").attr("rel","tooltip").attr("data-title",d).on("click",a.click);c.ToolbarIcons.createSVG(h,c.ToolbarIcons[a.icon],16,d)})})};m.prototype.changeBrightness=function(a){this.bright=a;this.element&&this.element.selectAll(a?".geo_toolbar_btn":".geo_toolbar_btn_bright").attr("class",a?"geo_toolbar_btn_bright":"geo_toolbar_btn")};m.prototype.cleanup=function(){this.element&&(this.element.remove(),delete this.element)};
x.prototype=Object.create(r.InteractiveControl.prototype);x.prototype.setHighlight=function(a,b){return this.drawSpecial(a,b)};x.prototype.drawSpecial=function(a){var b=this.mesh;if(b&&b.material){if(a)return b.origin||(b.origin={color:b.material.color,opacity:b.material.opacity,width:b.material.linewidth,size:b.material.size}),b.material.color=new f.Color(a),b.material.opacity=1,b.hightlightWidthScale&&!JSROOT.browser.isWin&&(b.material.linewidth=b.origin.width*b.hightlightWidthScale),b.highlightScale&&
(b.material.size=b.origin.size*b.highlightScale),!0;if(b.origin)return b.material.color=b.origin.color,b.material.opacity=b.origin.opacity,b.hightlightWidthScale&&(b.material.linewidth=b.origin.width),b.highlightScale&&(b.material.size=b.origin.size),!0}};e.prototype=Object.create(JSROOT.ObjectPainter.prototype);e.prototype.createToolbar=function(){var a=this;if(!this._toolbar&&this._webgl&&!this.ctrl.notoolbar&&!JSROOT.batch_mode){var b=[{name:"toImage",title:"Save as PNG",icon:"camera",click:function(){return a.createSnapshot()}},
{name:"control",title:"Toggle control UI",icon:"rect",click:function(){return a.showControlOptions("toggle")}},{name:"enlarge",title:"Enlarge geometry drawing",icon:"circle",click:function(){return a.toggleEnlarge()}}];navigator.getVRDisplays&&(b.push({name:"entervr",title:"Enter VR (It requires a VR Headset connected)",icon:"vrgoggles",click:function(){return a.toggleVRMode()}}),this.initVRMode());JSROOT.settings.ContextMenu&&b.push({name:"menu",title:"Show context menu",icon:"question",click:function(b){b.preventDefault();
b.stopPropagation();r.closeMenu&&r.closeMenu()||r.createMenu(b,a).then(function(a){a.painter.fillContextMenu(a);a.show()})}});var c=new f.Color(this.ctrl.background);this._toolbar=new m(this.selectDom(),1>c.r+c.g+c.b);this._toolbar.addButtons(b)}};e.prototype.initVRMode=function(){var a=this;this._dolly=new f.Group;this._scene.add(this._dolly);this._standingMatrix=new f.Matrix4;this._raycasterEnd=new f.Vector3;this._raycasterOrigin=new f.Vector3;navigator.getVRDisplays().then(function(b){if(b=b[0])a._renderer.vr.setDevice(b),
a._vrDisplay=b,b.stageParameters&&a._standingMatrix.fromArray(b.stageParameters.sittingToStandingTransform),a.initVRControllersGeometry()})};e.prototype.initVRControllersGeometry=function(){var a=new f.SphereGeometry(.025,18,36),b=new f.MeshBasicMaterial({color:"grey"}),c=new f.MeshBasicMaterial({color:"fuchsia"}),d=new f.BoxBufferGeometry(.001,.001,2),k=new f.Mesh(d,c);c=new f.Mesh(d,c);d=new f.Mesh(a,b);a=new f.Mesh(a,b);this._controllersMeshes=[];this._controllersMeshes.push(d);this._controllersMeshes.push(a);
--k.position.z;--c.position.z;d.add(k);a.add(c);this._dolly.add(d);this._dolly.add(a);d.visible=!1;a.visible=!1};e.prototype.updateVRControllersList=function(){var a=navigator.getGamepads&&navigator.getGamepads();if(!this.vrControllers||a.length!==this.vrControllers.length){this._controllersMeshes.forEach(function(a){a.visible=!1});this._vrControllers=[];for(var b=0;b<a.length;++b)a[b]&&a[b].pose&&(this._vrControllers.push({gamepad:a[b],mesh:this._controllersMeshes[b]}),this._controllersMeshes[b].visible=
!0)}};e.prototype.processVRControllerIntersections=function(){for(var a=[],b=0;b<this._vrControllers.length;++b){var c=this._vrControllers[b].mesh,d=c.localToWorld(this._raycasterEnd.set(0,0,-1));c=c.localToWorld(this._raycasterOrigin.set(0,0,0));d.sub(c).normalize();a=a.concat(this._controls.getOriginDirectionIntersects(c,d))}a=a.filter(function(b,c){return a.indexOf(b)===c});this._controls.ProcessMouseMove(a)};e.prototype.updateVRControllers=function(){this.updateVRControllersList();for(var a=0;a<
this._vrControllers.length;++a){var b=this._vrControllers[a],c=b.gamepad.pose.orientation,d=b.gamepad.pose.position;b=b.mesh;c&&b.quaternion.fromArray(c);d&&b.position.fromArray(d);b.updateMatrix();b.applyMatrix4(this._standingMatrix);b.matrixWorldNeedsUpdate=!0}this.processVRControllerIntersections()};e.prototype.toggleVRMode=function(){var a=this;this._vrDisplay&&(this._vrDisplay.isPresenting?this.exitVRMode():(this._previousCameraPosition=this._camera.position.clone(),this._previousCameraRotation=
this._camera.rotation.clone(),this._vrDisplay.requestPresent([{source:this._renderer.domElement}]).then(function(){a._previousCameraNear=a._camera.near;a._dolly.position.set(a._camera.position.x/4,-a._camera.position.y/8,-a._camera.position.z/4);a._camera.position.set(0,0,0);a._dolly.add(a._camera);a._camera.near=.1;a._camera.updateProjectionMatrix();a._renderer.vr.enabled=!0;a._renderer.setAnimationLoop(function(){a.updateVRControllers();a.render3D(0)})}),this._renderer.vr.enabled=!0,window.addEventListener("keydown",
function(b){27===b.keyCode&&a.exitVRMode()})))};e.prototype.exitVRMode=function(){this._vrDisplay.isPresenting&&(this._renderer.vr.enabled=!1,this._dolly.remove(this._camera),this._scene.add(this._camera),this._camera.position.copy(this._previousCameraPosition),this._previousCameraPosition=void 0,this._camera.rotation.copy(this._previousCameraRotation),this._previousCameraRotation=void 0,this._camera.near=this._previousCameraNear,this._camera.updateProjectionMatrix(),this._vrDisplay.exitPresent())};
e.prototype.getGeometry=function(){return this.getObject()};e.prototype.modifyVisisbility=function(a,b){if(0===g.getNodeKind(this.getGeometry())){if(""==a)return g.SetBit(this.getGeometry().fVolume,g.BITS.kVisThis,"+"===b);var c=!1;0>a.indexOf("*")?(a=new RegExp("^"+a+"$"),c=!0):(a=new RegExp("^"+a.split("*").join(".*")+"$"),c=!1);this.findNodeWithVolume(a,function(a){g.setInvisibleAll(a.node.fVolume,"+"!==b);return c?a:null})}};e.prototype.decodeOptions=function(a){"string"!=typeof a&&(a="");var b=
{_grid:!1,_bound:!1,_debug:!1,_full:!1,_axis:0,_count:!1,wireframe:!1,scale:new f.Vector3(1,1,1),zoom:1,rotatey:0,rotatez:0,more:1,maxlimit:1E5,vislevel:void 0,maxnodes:void 0,dflt_colors:!1,use_worker:!1,show_controls:!1,highlight:!1,highlight_scene:!1,no_screen:!1,project:"",is_main:!1,tracks:!1,showtop:!1,can_rotate:!0,ortho_camera:!1,clipx:!1,clipy:!1,clipz:!1,usessao:!1,outline:!1,script_name:"",transparency:0,rotate:!1,background:"#FFFFFF",depthMethod:"dflt",mouse_tmout:50,trans_radial:0,trans_z:0},
c=JSROOT.decodeUrl();"true"==c.get("_grid")&&(b._grid=!0);c=c.get("_debug");"true"==c&&(b._debug=!0,b._grid=!0);"bound"==c&&(b._debug=!0,b._grid=!0,b._bound=!0);"full"==c&&(b._debug=!0,b._grid=!0,b._full=!0,b._bound=!0);c=a.indexOf("macro:");if(0<=c){var d=a.indexOf(";",c+6);0>d&&(d=a.length);b.script_name=a.substr(c+6,d-c-6);a=a.substr(0,c)+a.substr(d+1);console.log("script",b.script_name,"rest",a)}for(;;){var k=a.indexOf("+"),h=a.indexOf("-");if(0>k&&0>h)break;c=k;d="+";if(0>c||0<=h&&h<k)c=h,d=
"-";k=c+1;for(h=/[,; .]/;k<a.length&&!h.test(a[k])&&"+"!=a[k]&&"-"!=a[k];)k++;h=a.substring(c+1,k);a=a.substr(0,c)+a.substr(k);this.modifyVisisbility(h,d)}a=new JSROOT.DrawOptions(a);a.check("MAIN")&&(b.is_main=!0);a.check("TRACKS")&&(b.tracks=!0);a.check("SHOWTOP")&&(b.showtop=!0);a.check("NO_SCREEN")&&(b.no_screen=!0);a.check("ORTHO_CAMERA_ROTATE")&&(b.ortho_camera=!0,b.can_rotate=!0);a.check("ORTHO_CAMERA")&&(b.ortho_camera=!0,b.can_rotate=!1);a.check("MOUSE_CLICK")&&(b.mouse_click=!0);if(a.check("DEPTHRAY")||
a.check("DRAY"))b.depthMethod="ray";if(a.check("DEPTHBOX")||a.check("DBOX"))b.depthMethod="box";if(a.check("DEPTHPNT")||a.check("DPNT"))b.depthMethod="pnt";if(a.check("DEPTHSIZE")||a.check("DSIZE"))b.depthMethod="size";if(a.check("DEPTHDFLT")||a.check("DDFLT"))b.depthMethod="dflt";a.check("ZOOM",!0)&&(b.zoom=a.partAsFloat(0,100)/100);a.check("ROTY",!0)&&(b.rotatey=a.partAsFloat());a.check("ROTZ",!0)&&(b.rotatez=a.partAsFloat());a.check("VISLVL",!0)&&(b.vislevel=a.partAsInt());a.check("BLACK")&&(b.background=
"#000000");a.check("WHITE")&&(b.background="#FFFFFF");if(a.check("BKGR_",!0)){c=null;if(0<a.partAsInt(1))c=r.getColor(a.partAsInt());else for(d=0;8>d;++d)r.getColor(d).toUpperCase()===a.part&&(c=r.getColor(d));c&&(b.background="#"+(new f.Color(c)).getHexString())}a.check("R3D_",!0)&&(b.Render3D=JSROOT.constants.Render3D.fromString(a.part.toLowerCase()));a.check("MORE3")&&(b.more=3);a.check("MORE")&&(b.more=2);a.check("ALL")&&(b.more=10,b.vislevel=9);if(a.check("CONTROLS")||a.check("CTRL"))b.show_controls=
!0;a.check("CLIPXYZ")&&(b.clipx=b.clipy=b.clipz=!0);a.check("CLIPX")&&(b.clipx=!0);a.check("CLIPY")&&(b.clipy=!0);a.check("CLIPZ")&&(b.clipz=!0);a.check("CLIP")&&(b.clipx=b.clipy=b.clipz=!0);a.check("PROJX",!0)&&(b.project="x",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()),b.can_rotate=!1);a.check("PROJY",!0)&&(b.project="y",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()),b.can_rotate=!1);a.check("PROJZ",!0)&&(b.project="z",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()),b.can_rotate=!1);if(a.check("DFLT_COLORS")||
a.check("DFLT"))b.dflt_colors=!0;a.check("SSAO")&&(b.usessao=!0);a.check("OUTLINE")&&(b.outline=!0);a.check("NOWORKER")&&(b.use_worker=-1);a.check("WORKER")&&(b.use_worker=1);if(a.check("NOHIGHLIGHT")||a.check("NOHIGH"))b.highlight_scene=b.highlight=0;a.check("HIGHLIGHT")&&(b.highlight_scene=b.highlight=!0);a.check("HSCENEONLY")&&(b.highlight_scene=!0,b.highlight=0);a.check("NOHSCENE")&&(b.highlight_scene=0);a.check("HSCENE")&&(b.highlight_scene=!0);if(a.check("WIREFRAME")||a.check("WIRE"))b.wireframe=
!0;a.check("ROTATE")&&(b.rotate=!0);if(a.check("INVX")||a.check("INVERTX"))b.scale.x=-1;if(a.check("INVY")||a.check("INVERTY"))b.scale.y=-1;if(a.check("INVZ")||a.check("INVERTZ"))b.scale.z=-1;a.check("COUNT")&&(b._count=!0);a.check("TRANSP",!0)&&(b.transparency=a.partAsInt(0,100)/100);a.check("OPACITY",!0)&&(b.transparency=1-a.partAsInt(0,100)/100);if(a.check("AXISCENTER")||a.check("AC"))b._axis=2;a.check("TRR",!0)&&(b.trans_radial=a.partAsInt()/100);a.check("TRZ",!0)&&(b.trans_z=a.partAsInt()/100);
if(a.check("AXIS")||a.check("A"))b._axis=!0;a.check("D")&&(b._debug=!0);a.check("G")&&(b._grid=!0);a.check("B")&&(b._bound=!0);a.check("W")&&(b.wireframe=!0);a.check("F")&&(b._full=!0);a.check("Y")&&(b._yup=!0);a.check("Z")&&(b._yup=!1);void 0===b._yup&&(b._yup=this.getCanvSvg().empty());return b};e.prototype.activateInBrowser=function(a,b){var c=this;"string"==typeof a&&(a=[a]);this._hpainter&&(this._hpainter.activateItems(a,b),this.ctrl.update_browser||setTimeout(function(){return c._hpainter.activateItems([])},
2E3))};e.prototype.testMatrixes=function(){var a=this,b=0,c=0,d=0,k=(new Date).getTime();this._clones.scanVisible({domatrix:!0,func:function(){var k=a.getmatrix(),h=a.CopyStack(),e=a._clones.createObject3D(h.stack,a._toplevel,"mesh");if(!e)return!0;c++;e=e.matrixWorld;if(e.equals(k))return!0;if(0<e.determinant()&&-.9>k.determinant()){var g=f.Vector3(1,1,-1);k=k.clone().scale(g);if(e.equals(k))return!0}for(var u=g=0;16>u;++u)g=Math.max(g,Math.abs(e.elements[u]-k.elements[u]));d=Math.max(g,d);if(1E-4>
g)return!0;console.log(a._clones.resolveStack(h.stack).name,"maxdiff",g,"determ",e.determinant(),k.determinant());b++;return!1}});var h=(new Date).getTime();console.log("Compare matrixes total",c,"errors",b,"takes",h-k,"maxdiff",d)};e.prototype.fillContextMenu=function(a){var b=this;a.add("header: Draw options");a.addchk(this.ctrl.update_browser,"Browser update",function(){b.ctrl.update_browser=!b.ctrl.update_browser;b.ctrl.update_browser||b.activateInBrowser([])});a.addchk(this.ctrl.show_controls,
"Show Controls",function(){return b.showControlOptions("toggle")});a.addchk(this.ctrl._axis,"Show axes",function(){return b.setAxesDraw("toggle")});this.geo_manager&&a.addchk(this.ctrl.showtop,"Show top volume",function(){return b.setShowTop(!b.ctrl.showtop)});a.addchk(this.ctrl.wireframe,"Wire frame",function(){return b.toggleWireFrame()});a.addchk(this.ctrl.highlight,"Highlight volumes",function(){b.ctrl.highlight=!b.ctrl.highlight});a.addchk(this.ctrl.highlight_scene,"Highlight scene",function(){b.ctrl.highlight_scene=
!b.ctrl.highlight_scene});a.add("Reset camera position",function(){return b.focusCamera()});this._geom_viewer||a.add("Get camera position",function(){return alert("Position (as url): &opt="+b.produceCameraUrl())});this.ctrl.project||a.addchk(this.ctrl.rotate,"Autorotate",function(){return b.setAutoRotate(!b.ctrl.rotate)});a.addchk(this.ctrl.select_in_view,"Select in view",function(){b.ctrl.select_in_view=!b.ctrl.select_in_view;b.ctrl.select_in_view&&b.startDrawGeometry()})};e.prototype.changedGlobalTransparency=
function(a,b){var c="function"==typeof a?a:null;if(c||void 0===a)a=this.ctrl.transparency;this._toplevel.traverse(function(b){if(b&&b.material&&void 0!==b.material.inherentOpacity){var d=c?c(b):void 0;b.material.opacity=void 0!==d?1-d:Math.min(1-(a||0),b.material.inherentOpacity);b.material.transparent=1>b.material.opacity}});b||this.render3D(-1)};e.prototype.resetTransformation=function(){this.changedTransformation("reset")};e.prototype.changedTransformation=function(a){if(this._toplevel){var b=
this.ctrl,c=new f.Matrix4,d=new f.Vector3;"reset"==a&&(b.trans_z=b.trans_radial=0);this._toplevel.traverse(function(k){if(void 0!==k.stack){var h=k.parent;if("reset"==a)h.matrix0&&(h.matrix.copy(h.matrix0),h.matrix.decompose(h.position,h.quaternion,h.scale),h.matrixWorldNeedsUpdate=!0),delete h.matrix0,delete h.vect0,delete h.vect1,delete h.minvert;else{if(void 0===h.vect0){h.matrix0=h.matrix.clone();h.minvert=(new f.Matrix4).getInverse(h.matrixWorld);var e=g.getBoundingBox(k,null,!0);h.vect0=(new f.Vector3((e.max.x+
e.min.x)/2,(e.max.y+e.min.y)/2,(k._flippedMesh?-1:1)*(e.max.z+e.min.z)/2)).applyMatrix4(h.matrixWorld);h.vect1=(new f.Vector3(0,0,0)).applyMatrix4(h.minvert)}d.set(b.trans_radial*h.vect0.x,b.trans_radial*h.vect0.y,b.trans_z*h.vect0.z).applyMatrix4(h.minvert).sub(h.vect1);h.matrix.multiplyMatrices(h.matrix0,c.makeTranslation(d.x,d.y,d.z));h.matrix.decompose(h.position,h.quaternion,h.scale);h.matrixWorldNeedsUpdate=!0}}});this._toplevel.updateMatrixWorld();"norender"!=a&&this.drawSimpleAxis()}};e.prototype.changedAutoRotate=
function(){this.autorotate(2.5)};e.prototype.changedAxes=function(){"string"==typeof this.ctrl._axis&&(this.ctrl._axis=parseInt(this.ctrl._axis));this.drawSimpleAxis()};e.prototype.changedBackground=function(a){void 0!==a&&(this.ctrl.background=a);this._renderer.setClearColor(this.ctrl.background,1);this.render3D(0);this._toolbar&&(a=new f.Color(this.ctrl.background),this._toolbar.changeBrightness(1>a.r+a.g+a.b))};e.prototype.changedSSAO=function(){this.ctrl.ssao.enabled?(this.createSSAO(),this._ssaoPass.output=
parseInt(this.ctrl.ssao.output),this._ssaoPass.kernelRadius=this.ctrl.ssao.kernelRadius,this._ssaoPass.minDistance=this.ctrl.ssao.minDistance,this._ssaoPass.maxDistance=this.ctrl.ssao.maxDistance):this.removeSSAO();this.updateClipping()};e.prototype.showControlOptions=function(a){var b=this;this.ctrl&&("toggle"===a?a=!this._datgui:void 0===a&&(a=this.ctrl.show_controls),this.ctrl.show_controls=a,this._datgui?a||(p.select(this._datgui.domElement).remove(),this._datgui.destroy(),delete this._datgui):
a&&JSROOT.require("dat.gui").then(function(a){return b.buildDatGui(a)}))};e.prototype.buildDatGui=function(a){if(this._renderer){if(!a)throw Error("Fail to load dat.gui");this._datgui=new a.GUI({autoPlace:!1,width:Math.min(650,this._renderer.domElement.width/2)});a=this.selectDom();"static"==a.style("position")&&a.style("position","relative");p.select(this._datgui.domElement).style("position","absolute").style("top",0).style("right",0);a.node().appendChild(this._datgui.domElement);this._datgui.painter=
this;if(this.ctrl.project){a=this.getGeomBoundingBox(this.getProjectionSource(),.01);var b=this.ctrl.project;void 0===this.ctrl.projectPos&&(this.ctrl.projectPos=(a.min[b]+a.max[b])/2);this._datgui.add(this.ctrl,"projectPos",a.min[b],a.max[b]).name(b.toUpperCase()+" projection").onChange(this.startDrawGeometry.bind(this))}else{a=this._datgui.addFolder("Clipping");b=this.changedClipping.bind(this,-1);for(var c=0;3>c;++c){var d=this.ctrl.clip[c],k=d.name.toUpperCase();a.add(d,"enabled").name("Enable "+
k).listen().onChange(b);a.add(d,"value",d.min,d.max).name(k+" position").onChange(this.changedClipping.bind(this,c))}a.add(this.ctrl,"clipIntersect").name("Clip intersection").listen().onChange(b)}a=this._datgui.addFolder("Appearance");a.add(this.ctrl,"highlight").name("Highlight Selection").listen().onChange(this.changedHighlight.bind(this));a.add(this.ctrl,"transparency",0,1,.001).listen().onChange(this.changedGlobalTransparency.bind(this));a.addColor(this.ctrl,"background").name("Background").onChange(this.changedBackground.bind(this));
a.add(this.ctrl,"wireframe").name("Wireframe").listen().onChange(this.changedWireFrame.bind(this));this.ctrl._axis_cfg=0;a.add(this.ctrl,"_axis",{none:0,show:1,center:2}).name("Axes").onChange(this.changedAxes.bind(this));if(!this.ctrl.project)a.add(this.ctrl,"rotate").name("Autorotate").listen().onChange(this.changedAutoRotate.bind(this));a.add(this,"focusCamera").name("Reset camera position");if(this._webgl){a=this._datgui.addFolder("Advanced");var h={};this.ctrl.depthMethodItems.forEach(function(a){h[a.name]=
a.value});a.add(this.ctrl,"depthTest").name("Depth test").listen().onChange(this.changedDepthTest.bind(this));a.add(this.ctrl,"depthMethod",h).name("Rendering order").onChange(this.changedDepthMethod.bind(this));a.add(this,"resetAdvanced").name("Reset")}this.ctrl.project||(a=this._datgui.addFolder("Transform"),a.add(this.ctrl,"trans_z",0,3,.01).name("Z axis").listen().onChange(this.changedTransformation.bind(this)),a.add(this.ctrl,"trans_radial",0,3,.01).name("Radial").listen().onChange(this.changedTransformation.bind(this)),
a.add(this,"resetTransformation").name("Reset"),(this.ctrl.trans_z||this.ctrl.trans_radial)&&a.open());if(!this.ctrl.outline){a=this._datgui.addFolder("Smooth Lighting (SSAO)");b=this.changedSSAO.bind(this);var e={};this.ctrl.ssao.outputItems.forEach(function(a){e[a.name]=a.value});a.add(this.ctrl.ssao,"enabled").name("Enable SSAO").listen().onChange(b);a.add(this.ctrl.ssao,"output",e).listen().onChange(b);a.add(this.ctrl.ssao,"kernelRadius",0,32).listen().onChange(b);a.add(this.ctrl.ssao,"minDistance",
.001,.02).listen().onChange(b);a.add(this.ctrl.ssao,"maxDistance",.01,.3).listen().onChange(b)}}};e.prototype.removeSSAO=function(){delete this._ssaoPass;delete this._effectComposer};e.prototype.createSSAO=function(){this._webgl&&!this._ssaoPass&&(this._effectComposer||(this._effectComposer=new f.EffectComposer(this._renderer),this._effectComposer.addPass(new f.RenderPass(this._scene,this._camera))),this._ssaoPass=new f.SSAOPass(this._scene,this._camera,this._scene_width,this._scene_height),this._ssaoPass.kernelRadius=
16,this._ssaoPass.renderToScreen=!0,this._effectComposer.addPass(this._ssaoPass))};e.prototype.orbitContext=function(a,b){var c=this;r.createMenu(a,this).then(function(a){var d=0,h=0,e=0;if(b)for(var f=0;f<b.length;++f)b[f].object.stack&&h++,b[f].object.geo_name&&d++;if(0===h+d)c.fillContextMenu(a);else for((h=1<h+d)&&a.add("header:"+(0<d?"Items":"Nodes")),d=0;d<b.length;++d){f=b[d].object;var q=void 0,l=void 0,u=void 0;if(f.geo_name)l=f.geo_name,0==l.indexOf("<prnt>")&&(l=(c.getItemName()||"top")+
l.substr(6)),(q=l.substr(l.lastIndexOf("/")+1))||(q=l),u=q;else if(f.stack)q=c._clones.resolveStack(f.stack).name,l=c.getStackFullName(f.stack),u=c.getItemName(),0===q.indexOf("Nodes/")?u=q.substr(6):0<q.length?u=q:u||(u="header");else continue;a.add((h?"sub:":"header:")+u,l,function(a){return c.activateInBrowser([a],!0)});a.add("Browse",l,function(a){return c.activateInBrowser([a],!0)});c._hpainter&&a.add("Inspect",l,function(a){return c._hpainter.display(a,"inspect")});f.geo_name?a.add("Hide",d,
function(c){c=b[c].object;c.visible=!1;c.geo_object&&(c.geo_object.$hidden_via_menu=!0);a.painter.render3D()}):(f=c.accessObjectWireFrame(f),void 0!==f&&a.addchk(f,"Wireframe",d,function(a){a=b[a].object.material;a.wireframe=!a.wireframe;this.render3D()}),1<++e&&a.add("Manifest",d,function(a){this._last_manifest&&(this._last_manifest.wireframe=!this._last_manifest.wireframe);this._last_hidden&&this._last_hidden.forEach(function(a){a.visible=!0});this._last_hidden=[];for(var c=0;c<a;++c)this._last_hidden.push(b[c].object);
this._last_hidden.forEach(function(a){a.visible=!1});this._last_manifest=b[a].object.material;this._last_manifest.wireframe=!this._last_manifest.wireframe;this.render3D()}),a.add("Focus",d,function(a){this.focusCamera(b[a].object)}),c._geom_viewer||a.add("Hide",d,function(c){c=a.painter._clones.resolveStack(b[c].object.stack);c.obj&&0===c.node.kind&&c.obj.fVolume?(g.SetBit(c.obj.fVolume,g.BITS.kVisThis,!1),g.updateBrowserIcons(c.obj.fVolume,this._hpainter)):c.obj&&1===c.node.kind&&(c.obj.fRnrSelf=
!1,g.updateBrowserIcons(c.obj,this._hpainter));this.testGeomChanges()}));h&&a.add("endsub:")}a.show()})};e.prototype.filterIntersects=function(a){if(!a.length)return a;for(var b=0;b<a.length;++b)a[b].object.geo_highlight&&(a[b].object=a[b].object.geo_highlight);for(b=a.length-1;0<=b;--b){var c=a[b].object,d=void 0!==c.stack||void 0!==c.geo_name;d&&c.material&&void 0!==c.material.opacity&&(d=.1<=c.material.opacity);c.jsroot_special&&(d=!1);for(var k=0;k<b&&d;++k)a[k].object===c&&(d=!1);d||a.splice(b,
1)}b=this.ctrl.clip;if(b[0].enabled||b[1].enabled||b[2].enabled){c=[];for(d=0;d<a.length;++d){k=a[d].point;var h="Points"==a[d].object.type,f=!0;b[0].enabled&&this._clipPlanes[0].normal.dot(k)>this._clipPlanes[0].constant^h&&(f=!1);b[1].enabled&&this._clipPlanes[1].normal.dot(k)>this._clipPlanes[1].constant^h&&(f=!1);b[2].enabled&&this._clipPlanes[2].normal.dot(k)>this._clipPlanes[2].constant&&(f=!1);f||c.push(a[d])}a=c}return a};e.prototype.testCameraPositionChange=function(){if(this.ctrl.select_in_view&&
!this._draw_all_nodes){var a=g.createProjectionMatrix(this._camera);g.createFrustum(a).CheckBox(this.getGeomBoundingBox(this._toplevel))||this.startDrawGeometry()}};e.prototype.resolveStack=function(a){return this._clones&&a?this._clones.resolveStack(a):null};e.prototype.getStackFullName=function(a){var b=this.getItemName();return(a=this.resolveStack(a))&&a.name?b?b+"/"+a.name:a.name:b};e.prototype.addHighlightHandler=function(a){a&&"function"==typeof a.highlightMesh&&(this._highlight_handlers||(this._highlight_handlers=
[]),this._highlight_handlers.push(a))};e.prototype.highlightMesh=function(a,b,c,d,k,h){function e(a){return a.get_ctrl?a.get_ctrl():new x(a)}if(c){a=a?[a]:[];var t=this.getExtrasContainer();t&&t.traverse(function(b){b.geo_object===c&&0>a.indexOf(b)&&a.push(b)})}else k&&this._toplevel?(a=[],this._toplevel.traverse(function(b){b instanceof f.Mesh&&g.isSameStack(b.stack,k)&&a.push(b)})):a=a?[a]:[];a.length||(a=null);a&&(a[0].geo_object?this.ctrl.highlight_scene||(a=null):this.ctrl.highlight||(a=null));
if(!h)for(a&&(c||(c=a[0].geo_object),k||(k=a[0].stack)),h=this._highlight_handlers||(this._main_painter?this._main_painter._slave_painters.concat([this._main_painter]):this._slave_painters),t=0;t<h.length;++t)h[t]!==this&&h[t].highlightMesh(null,b,c,d,k,!0);h=this._selected_mesh;if(!h&&!a)return!1;t=!1;if(h&&a&&h.length==a.length){t=!0;for(var q=0;q<h.length&&t;++q)if(h[q]!==a[q]||e(h[q]).checkHighlightIndex(d))t=!1}if(t)return!!h;if(h)for(t=0;t<h.length;++t)e(h[t]).setHighlight();if(this._selected_mesh=
a)for(h=0;h<a.length;++h)e(a[h]).setHighlight(b||16755251,d);this.render3D(0);return!!a};e.prototype.processMouseClick=function(a,b,c){b.length&&(a=b[0].object,a.get_ctrl&&(a=a.get_ctrl(),b=a.extractIndex(b[0]),a.evnt=c,a.setSelected("blue",b)&&this.render3D(),a.evnt=null))};e.prototype.setMouseTmout=function(a){this.ctrl&&(this.ctrl.mouse_tmout=a);this._controls&&(this._controls.mouse_tmout=a)};e.prototype.setDepthMethod=function(a){this.ctrl&&(this.ctrl.depthMethod=a)};e.prototype.addOrbitControls=
function(){if(!this._controls&&this._webgl&&!JSROOT.batch_mode){var a=this;this.setTooltipAllowed(JSROOT.settings.Tooltip);this._controls=r.createOrbitControl(this,this._camera,this._scene,this._renderer,this._lookat);this._controls.mouse_tmout=this.ctrl.mouse_tmout;this.ctrl.can_rotate||(this._controls.enableRotate=!1);this._controls.contextMenu=this.orbitContext.bind(this);this._controls.ProcessMouseMove=function(b){if(a.ctrl&&a._controls){for(var c=null,d=null,k=null,h=[],f,e,q=0;q<b.length;++q){var l=
b[q].object,u=null;l&&(l.geo_object?u=l.geo_name:l.stack&&(u=a.getStackFullName(l.stack)),u&&(0==u.indexOf("<prnt>")&&(u=a.getItemName()+u.substr(6)),h.push(u),c||(c=l,d=u,f=l.geo_object,l.get_ctrl&&(e=l.get_ctrl().extractIndex(b[q]),void 0!==e&&"string"==typeof d&&(d+=" indx:"+JSON.stringify(e))),c.stack&&(k=a.resolveStack(c.stack)))))}a.highlightMesh(c,void 0,f,e);a.ctrl.update_browser&&(a.ctrl.highlight&&d&&(h=[d]),a.activateInBrowser(h));if(!k||!k.obj)return d;b=g.provideObjectInfo(k.obj);b.unshift(d);
return{name:k.obj.fName,title:k.obj.fTitle||k.obj._typename,lines:b}}};this._controls.ProcessMouseLeave=function(){this.ProcessMouseMove([])};this._controls.processDblClick=function(){a.ctrl&&a._controls&&(a._last_manifest?(a._last_manifest.wireframe=!a._last_manifest.wireframe,a._last_hidden&&a._last_hidden.forEach(function(a){a.visible=!0}),delete a._last_hidden,delete a._last_manifest,a.render3D()):a.adjustCameraPosition())}}};e.prototype.addTransformControl=function(){var a=this;this._tcontrols||
!this.ctrl._debug&&!this.ctrl._grid||(this._tcontrols=new f.TransformControls(this._camera,this._renderer.domElement),this._scene.add(this._tcontrols),this._tcontrols.attach(this._toplevel),window.addEventListener("keydown",function(b){switch(b.keyCode){case 81:a._tcontrols.setSpace("local"===a._tcontrols.space?"world":"local");break;case 17:a._tcontrols.setTranslationSnap(Math.ceil(a._overall_size)/50);a._tcontrols.setRotationSnap(f.Math.degToRad(15));break;case 84:a._tcontrols.setMode("translate");
break;case 82:a._tcontrols.setMode("rotate");break;case 83:a._tcontrols.setMode("scale");break;case 187:case 107:a._tcontrols.setSize(a._tcontrols.size+.1);break;case 189:case 109:a._tcontrols.setSize(Math.max(a._tcontrols.size-.1,.1))}}),window.addEventListener("keyup",function(a){switch(a.keyCode){case 17:this._tcontrols.setTranslationSnap(null),this._tcontrols.setRotationSnap(null)}}),this._tcontrols.addEventListener("change",function(){return a.render3D(0)}))};e.prototype.nextDrawAction=function(){if(!this._clones||
0==this.drawing_stage)return!1;if(1==this.drawing_stage){if(this._geom_viewer)return this._draw_all_nodes=!1,this.drawing_stage=3,!0;if(0<this.ctrl.use_worker){if(!this._worker)return this.startWorker(),1;if(!this._worker_ready)return 1}var a=this._clones.countVisibles()||this._clones.markVisibles(),b=null,c=null;this.ctrl.select_in_view&&!this._first_drawing&&(b=g.createProjectionMatrix(this._camera),c=g.createFrustum(b),c.CheckBox(this.getGeomBoundingBox(this._toplevel))&&(c=b=null));this._current_face_limit=
this.ctrl.maxlimit;b&&(this._current_face_limit*=1.25);(a=!JSROOT.batch_mode&&(1E4<a||b&&1E5<this._clones.scanVisible()))&&0==JSROOT.source_dir.indexOf("file://")&&(console.log("disable worker for jsroot from file system"),a=!1);a&&!this._worker&&0<=this.ctrl.use_worker&&this.startWorker();if(!a||!this._worker_ready)return b=this._clones.collectVisibles(this._current_face_limit,c),this._new_draw_nodes=b.lst,this._draw_all_nodes=b.complete,this.drawing_stage=3,!0;b={collect:this._current_face_limit,
flags:this._clones.getVisibleFlags(),matrix:b?b.elements:null};this.submitToWorker(b);this.drawing_stage=2;this.drawing_log="Worker select visibles";return 2}if(2==this.drawing_stage)return this.drawing_log="Worker select visibles",2;if(3==this.drawing_stage){this.drawing_log="Analyse visibles";if(this._new_append_nodes)this._new_draw_nodes=this._draw_nodes.concat(this._new_append_nodes),delete this._new_append_nodes;else if(this._draw_nodes){b=this._geom_viewer?this._draw_nodes:this._clones.mergeVisibles(this._new_draw_nodes,
this._draw_nodes);for(c=0;c<b.length;++c)this._clones.createObject3D(b[c].stack,this._toplevel,"delete_mesh");0<b.length&&(this.drawing_log="Delete "+b.length+" nodes")}this._draw_nodes=this._new_draw_nodes;delete this._new_draw_nodes;this.drawing_stage=4;return!0}if(4===this.drawing_stage)return this.drawing_log="Collect shapes",b=this._clones.collectShapes(this._draw_nodes),this._build_shapes=this._clones.mergeShapesLists(this._build_shapes,b),this.drawing_stage=5,!0;if(5===this.drawing_stage){if(this.canSubmitToWorker()){b=
{limit:this._current_face_limit,shapes:[]};for(a=c=0;a<this._build_shapes.length;++a){var d=this._build_shapes[a];d.ready||d.geom?d={id:d.id,ready:!0,nfaces:g.countGeometryFaces(d.geom),refcnt:d.refcnt}:(d=JSROOT.clone(d,null,!0),c++);b.shapes.push(d)}if(0<c)return this.submitToWorker(b),this.drawing_log="Worker build shapes",this.drawing_stage=6,2}this.drawing_stage=7}if(6===this.drawing_stage)return 2;if(7===this.drawing_stage||8===this.drawing_stage){if(7===this.drawing_stage)if(b=this._clones.buildShapes(this._build_shapes,
this._current_face_limit,500),b.done)this.ctrl.info.num_shapes=this._build_shapes.length,this.drawing_stage=8;else if(this.ctrl.info.num_shapes=b.shapes,this.drawing_log="Creating: "+b.shapes+" / "+this._build_shapes.length+" shapes,  "+b.faces+" faces",30>b.notusedshapes)return!0;b=(new Date).getTime();c=!0;a=this.ctrl.project?this._full_geom:this._toplevel;for(d=0;d<this._draw_nodes.length;++d){var k=this._draw_nodes[d];if(!k.done){var h=k.server_shape||this._build_shapes[k.shapeid];if(h.ready){if(k.done=
!0,h.used=!0,this.createEntryMesh(k,h,a)&&(this.ctrl.info.num_meshes++,this.ctrl.info.num_faces+=h.nfaces),500<(new Date).getTime()-b){c=!1;break}}else 8===this.drawing_stage&&console.warn("shape marked as not ready when should"),c=!1}}if(c){if(this.ctrl.project)return this.drawing_log="Build projection",this.drawing_stage=10,!0;this.drawing_log="Building done";this.drawing_stage=0;return!1}7<this.drawing_stage&&(this.drawing_log="Building meshes "+this.ctrl.info.num_meshes+" / "+this.ctrl.info.num_faces);
return!0}if(9===this.drawing_stage){if(!this._main_painter)return console.warn("MAIN PAINTER DISAPPER"),this.drawing_stage=0,!1;if(!this._main_painter._drawing_ready)return 1;this.drawing_stage=10}if(10===this.drawing_stage)return this.doProjection(),this.drawing_log="Building done",this.drawing_stage=0,!1;console.error("never come here stage = "+this.drawing_stage);return!1};e.prototype.createEntryMesh=function(a,b,c){if(!b.geom||0===b.nfaces)return this._clones.createObject3D(a.stack,c,"delete_mesh"),
!1;this._splitColors&&a.stack&&(0===a.stack[0]?a.custom_color="green":1===a.stack[0]&&(a.custom_color="blue"));var d=this._clones.getDrawEntryProperties(a);c=this._clones.createObject3D(a.stack,c,this.ctrl);d.material.wireframe=this.ctrl.wireframe;d.material.side=this.ctrl.bothSides?f.DoubleSide:f.FrontSide;b=-.9<(c.absMatrix||c.matrixWorld).determinant()?new f.Mesh(b.geom,d.material):g.createFlippedMesh(b,d.material);c.add(b);c.absMatrix&&(b.matrix.copy(c.absMatrix),b.matrix.decompose(b.position,
b.quaternion,b.scale),b.updateMatrixWorld());b.stack=a.stack;b.renderOrder=this._clones.maxdepth-a.stack.length;b.$jsroot_order=c.$jsroot_depth;if(this.ctrl._debug||this.ctrl._full)a=new f.WireframeGeometry(b.geometry),d=new f.LineBasicMaterial({color:d.fillcolor,linewidth:d.linewidth||1}),d=new f.LineSegments(a,d),c.add(d);if(this.ctrl._bound||this.ctrl._full)b=new f.BoxHelper(b),c.add(b);return!0};e.prototype.appendMoreNodes=function(a,b){if(this.drawing_stage&&!b)this._provided_more_nodes=a;else{if(this._more_nodes)for(var c=
0;c<this._more_nodes.length;++c){var d=this._more_nodes[c],k=this._clones.createObject3D(d.stack,this._toplevel,"delete_mesh");r.disposeThreejsObject(k);g.cleanupShape(d.server_shape);delete d.server_shape}delete this._more_nodes;if(a){c=[];for(d=0;d<a.length;++d){k=a[d];var h=k.server_shape;h&&h.ready&&(k.done=!0,h.used=!0,this.createEntryMesh(k,h,this._toplevel)&&c.push(k))}c&&(this._more_nodes=c);b||this.render3D()}}};e.prototype.getProjectionSource=function(){return this._clones_owner?this._full_geom:
this._main_painter?this._main_painter._drawing_ready?this._main_painter._toplevel:(console.warn("MAIN PAINTER NOT READY WHEN DO PROJECTION"),null):(console.warn("MAIN PAINTER DISAPPER"),null)};e.prototype.getGeomBoundingBox=function(a,b){var c=new f.Box3,d=!this._clones;if(!a)return c.min.x=c.min.y=c.min.z=-1,c.max.x=c.max.y=c.max.z=1,c;c.makeEmpty();a.traverse(function(a){(d||a.stack&&a instanceof f.Mesh||a.main_track&&a instanceof f.LineSegments)&&g.getBoundingBox(a,c)});void 0!==b&&c.expandByVector(c.getSize(new f.Vector3).multiplyScalar(b));
return c};e.prototype.doProjection=function(){var a=this,b=this.getProjectionSource();if(!b)return!1;r.disposeThreejsObject(this._toplevel,!0);if(void 0===this.ctrl.projectPos){var c=this.getGeomBoundingBox(b),d=c.min[this.ctrl.project];c=c.max[this.ctrl.project];var k=(d+c)/2;0>d&&0<c&&Math.abs(k)<.2*Math.max(-d,c)&&(k=0);this.ctrl.projectPos=k}b.traverse(function(b){if(b instanceof f.Mesh&&b.stack){var c=g.projectGeometry(b.geometry,b.parent.absMatrix||b.parent.matrixWorld,a.ctrl.project,a.ctrl.projectPos,
b._flippedMesh);c&&(c=new f.Mesh(c,b.material.clone()),a._toplevel.add(c),c.stack=b.stack)}});return!0};e.prototype.changedLight=function(a){if(this._camera){var b=!a;a||(a=this.getGeomBoundingBox(this._toplevel));var c=a.max.x-a.min.x,d=a.max.y-a.min.y;a=a.max.z-a.min.z;var k=[],h=this.ctrl.light.power;void 0===h&&(h=1);if(this._camera._lights!=this.ctrl.light.kind)switch(r.disposeThreejsObject(this._camera,!0),this._camera._lights=this.ctrl.light.kind,this._camera._lights){case "ambient":this._camera.add(new f.AmbientLight(15724527,
h));break;case "hemisphere":this._camera.add(new f.HemisphereLight(16777147,526368,h));break;default:for(var e=0;6>e;++e)this._camera.add(new f.PointLight(15724527,h))}for(e=0;e<this._camera.children.length;++e){var g=this._camera.children[e],q=!1;if(g.isAmbientLight||g.isHemisphereLight)g.intensity=h;else if(g.isPointLight){switch(e){case 0:g.position.set(c/5,d/5,a/5);q=this.ctrl.light.specular;break;case 1:g.position.set(0,0,a/2);q=this.ctrl.light.front;break;case 2:g.position.set(0,2*d,0);q=this.ctrl.light.top;
break;case 3:g.position.set(0,-2*d,0);q=this.ctrl.light.bottom;break;case 4:g.position.set(-2*c,0,0);q=this.ctrl.light.left;break;case 5:g.position.set(2*c,0,0),q=this.ctrl.light.right}g.power=q?h*Math.PI*4:0;q&&k.push(g)}}k.forEach(function(a){a.power=4*h*Math.PI/k.length});b&&this.render3D()}};e.prototype.createScene=function(a,b){this._scene=new f.Scene;this._scene.fog=new f.Fog(16777215,1,1E4);this._scene.overrideMaterial=new f.MeshLambertMaterial({color:7340287,transparent:!0,opacity:.2,depthTest:!1});
this._scene_width=a;this._scene_height=b;this.ctrl.ortho_camera?this._camera=new f.OrthographicCamera(-600,600,-600,600,1,1E4):(this._camera=new f.PerspectiveCamera(25,a/b,1,1E4),this._camera.up=this.ctrl._yup?new f.Vector3(0,1,0):new f.Vector3(0,0,1));this._scene.add(this._camera);this._selected_mesh=null;this._overall_size=10;this._toplevel=new f.Object3D;this._scene.add(this._toplevel);this._renderer=r.createRender3D(a,b,this.options.Render3D,{antialias:!0,logarithmicDepthBuffer:!1,preserveDrawingBuffer:!0});
this._webgl=this._renderer.jsroot_render3d===JSROOT.constants.Render3D.WebGL;this._renderer.setPixelRatio&&!JSROOT.nodejs&&this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(a,b,!this._fit_main_area);this._renderer.localClippingEnabled=!0;this._renderer.setClearColor(this.ctrl.background,1);if(this._fit_main_area&&this._webgl){this._renderer.domElement.style.width="100%";this._renderer.domElement.style.height="100%";var c=this.selectDom();"static"==c.style("position")&&c.style("position",
"relative")}this._animating=!1;this.ctrl.bothSides=!1;this._clipPlanes=[new f.Plane(new f.Vector3(1,0,0),0),new f.Plane(new f.Vector3(0,this.ctrl._yup?-1:1,0),0),new f.Plane(new f.Vector3(0,0,this.ctrl._yup?1:-1),0)];c=new f.PointLight(15724527,1);c.position.set(10,10,10);this._camera.add(c);this._webgl&&(this.ctrl.ssao.enabled||this.ctrl.outline)&&(this.ctrl.outline&&"function"==typeof this.createOutline?(this._effectComposer=new f.EffectComposer(this._renderer),this._effectComposer.addPass(new f.RenderPass(this._scene,
this._camera)),this.createOutline(a,b)):this.ctrl.ssao.enabled&&this.createSSAO());return this._fit_main_area&&!this._webgl?(c=JSROOT._.get_document().createElementNS("http://www.w3.org/2000/svg","svg"),p.select(c).attr("width",a).attr("height",b),c.appendChild(this._renderer.jsroot_dom),c):this._renderer.jsroot_dom};e.prototype.startDrawGeometry=function(a){a||0===this.drawing_stage?(this._clones_owner&&this._clones&&this._clones.setDefaultColors(this.ctrl.dflt_colors),this._last_render_tm=this._startm=
(new Date).getTime(),this._last_render_meshes=0,this.drawing_stage=1,this._drawing_ready=!1,this.drawing_log="collect visible",this.ctrl.info.num_meshes=0,this.ctrl.info.num_faces=0,this.ctrl.info.num_shapes=0,this._selected_mesh=null,this.ctrl.project&&(this._clones_owner?this._full_geom?(this.drawing_stage=10,this.drawing_log="build projection"):this._full_geom=new f.Object3D:(this.drawing_stage=9,this.drawing_log="wait for main painter")),delete this._last_manifest,delete this._last_hidden,delete this._draw_nodes_again,
this.continueDraw()):this._draw_nodes_again=!0};e.prototype.resetAdvanced=function(){this.ctrl.ssao.kernelRadius=16;this.ctrl.ssao.output=f.SSAOPass.OUTPUT.Default;this.ctrl.depthTest=!0;this.ctrl.clipIntersect=!0;this.ctrl.depthMethod="ray";this.changedDepthMethod("norender");this.changedDepthTest()};e.prototype.getOverallSize=function(a){if(!this._overall_size||a){a=this.getGeomBoundingBox(this._toplevel);if(isNaN(a.min.x))return 1E3;this._overall_size=2*Math.max(a.max.x-a.min.x,a.max.y-a.min.y,
a.max.z-a.min.z)}return this._overall_size};e.prototype.createSnapshot=function(a){if(this._renderer){this.render3D(0);var b=this._renderer.domElement.toDataURL("image/png");if("asis"===a)return b;b.replace("image/png","image/octet-stream");var c=JSROOT._.get_document(),d=c.createElement("a");"string"===typeof d.download&&(c.body.appendChild(d),d.download=a||"geometry.png",d.href=b,d.click(),c.body.removeChild(d))}};e.prototype.produceCameraUrl=function(a){if(this._lookat&&this._camera0pos&&this._camera&&
this.ctrl){var b=(new f.Vector3).add(this._camera0pos).sub(this._lookat),c=(new f.Vector3).add(this._camera.position).sub(this._lookat),d=b.length(),k=c.length();d=this.ctrl.zoom*k/d*100;1>d?d=1:1E4<d&&(d=1E4);b.normalize();c.normalize();k=new f.Quaternion;k.setFromUnitVectors(b,c);b=new f.Euler;b.setFromQuaternion(k,"YZX");c=b.y/Math.PI*180;b=b.z/Math.PI*180;0>c&&(c+=360);0>b&&(b+=360);return"roty"+c.toFixed(a||0)+",rotz"+b.toFixed(a||0)+",zoom"+d.toFixed(a||0)}};e.prototype.calculateZoom=function(){if(this._camera0pos&&
this._camera&&this._lookat){var a=(new f.Vector3).add(this._camera0pos).sub(this._lookat);return(new f.Vector3).add(this._camera.position).sub(this._lookat).length()/a.length()}return 0};e.prototype.adjustCameraPosition=function(a,b){if(this._toplevel){var c=this.getGeomBoundingBox(this._toplevel);if(!isNaN(c.min.x)){var d=c.max.x-c.min.x,k=c.max.y-c.min.y,h=c.max.z-c.min.z,e=(c.max.x+c.min.x)/2,g=(c.max.y+c.min.y)/2,q=(c.max.z+c.min.z)/2;this._overall_size=2*Math.max(d,k,h);this._camera.near=this._overall_size/
350;this._camera.far=12*this._overall_size;this._scene.fog.near=2*this._overall_size;this._scene.fog.far=12*this._overall_size;if(a)for(a=0;3>a;++a){var l=this.ctrl.clip[a];l.min=c.min[l.name];l.max=c.max[l.name];var u=l.max-l.min;l.max+=.01*u;l.min-=.01*u;l.value?l.value<l.min?l.value=l.min:l.value>l.max&&(l.value=l.max):l.value=(l.min+l.max)/2}this.ctrl.ortho_camera&&(this._camera.left=c.min.x,this._camera.right=c.max.x,this._camera.top=c.max.y,this._camera.bottom=c.min.y);this._camera.updateProjectionMatrix();
a=2*this.ctrl.zoom;l=Math.max(d,k,h);if((this.ctrl.rotatey||this.ctrl.rotatez)&&this.ctrl.can_rotate)d=this.calculateZoom(),b&&d&&(a=2*d),k=new f.Euler(0,this.ctrl.rotatey/180*Math.PI,this.ctrl.rotatez/180*Math.PI,"YZX"),this._camera.position.set(-a*l,0,0),this._camera.position.applyEuler(k),this._camera.position.add(new f.Vector3(e,g,q)),b&&d&&(b=this.calculateZoom(),this._camera.position.set(-(d/b*a)*l,0,0),this._camera.position.applyEuler(k),this._camera.position.add(new f.Vector3(e,g,q)));else if(this.ctrl.ortho_camera)this._camera.position.set(e,
g,Math.max(d,k));else if(this.ctrl.project)switch(this.ctrl.project){case "x":this._camera.position.set(1.5*a*Math.max(k,h),0,0);break;case "y":this._camera.position.set(0,1.5*a*Math.max(d,h),0);break;case "z":this._camera.position.set(0,0,1.5*a*Math.max(d,k))}else this.ctrl._yup?this._camera.position.set(e-a*Math.max(d,h),g+a*k,q-a*Math.max(d,h)):this._camera.position.set(e-a*Math.max(d,k),g-a*Math.max(d,k),q+a*h);this._lookat=new f.Vector3(e,g,q);this._camera0pos=new f.Vector3(-2*l,0,0);this._camera.lookAt(this._lookat);
this.changedLight(c);this._controls&&(this._controls.target.copy(this._lookat),this._controls.update());this.ctrl.select_in_view&&this.startDrawGeometry()}}};e.prototype.setCameraPosition=function(a,b,c){this.ctrl&&(this.ctrl.rotatey=a||0,this.ctrl.rotatez=b||0,a=!1,c&&!isNaN(c)?this.ctrl.zoom=c:a=!0,this.adjustCameraPosition(!1,a))};e.prototype.focusOnItem=function(a){a&&this._clones&&(a=this._clones.findStackByName(a))&&(a=this._clones.resolveStack(a,!0),this.focusCamera(a,!1))};e.prototype.focusCamera=
function(a,b){var c=this;if(this.ctrl.project||this.ctrl.ortho_camera)return this.adjustCameraPosition();var d=new f.Box3;if(void 0===a)d=this.getGeomBoundingBox(this._toplevel);else if(a instanceof f.Mesh)d.setFromObject(a);else{var k=(new f.Vector3).setFromMatrixPosition(a.matrix);a=a.node;a=(new f.Vector3(a.fDX,a.fDY,a.fDZ)).multiplyScalar(.5);d.min=k.clone().sub(a);d.max=k.clone().add(a)}var h=d.max.x-d.min.x,e=d.max.y-d.min.y,g=d.max.z-d.min.z;k=(d.max.x+d.min.x)/2;a=(d.max.y+d.min.y)/2;d=(d.max.z+
d.min.z)/2;h=this.ctrl._yup?new f.Vector3(k-2*Math.max(h,g),a+2*e,d-2*Math.max(h,g)):new f.Vector3(k-2*Math.max(h,e),a-2*Math.max(h,e),d+2*g);d=new f.Vector3(k,a,d);var q=this._controls.target,l=50,u=0,r=h.sub(this._camera.position).divideScalar(l),p=d.sub(q).divideScalar(l);if(b=b&&this._webgl){for(d=0;3>d;++d)k=this.ctrl.clip[d],k.enabled||(k.value=k.min,k.enabled=!0),k.inc=((k.min+k.max)/2-k.value)/l;this.updateClipping()}this._animating=!0;var m=function(){if(void 0!==c._animating){c._animating?
requestAnimationFrame(m):c._geom_viewer||c.startDrawGeometry();var a=-Math.cos(2*Math.PI*u/l)+1;c._camera.position.add(r.clone().multiplyScalar(a));q.add(p.clone().multiplyScalar(a));c._lookat=q;c._camera.lookAt(c._lookat);c._camera.updateProjectionMatrix();var d=(new Date).getTime();if(b){for(var h=0;3>h;++h)c.ctrl.clip[h].value+=c.ctrl.clip[h].inc*a;c.updateClipping()}else c.render3D(0);a=(new Date).getTime();0==u&&200<a-d&&(l=20);u++;c._animating=u<l}};m()};e.prototype.autorotate=function(a){var b=
this,c=void 0===a?2:a,d=new Date,k=function(){if(b._renderer&&b.ctrl){var a=new Date;b.ctrl.rotate&&requestAnimationFrame(k);b._controls&&(b._controls.autoRotate=b.ctrl.rotate,b._controls.autoRotateSpeed=c*(a.getTime()-d.getTime())/16.6666,b._controls.update());d=new Date;b.render3D(0)}};this._webgl&&k()};e.prototype.completeScene=function(){if(this.ctrl._debug||this.ctrl._grid){if(this.ctrl._full){var a=new f.BoxHelper(this._toplevel);this._scene.add(a)}this._scene.add(new f.AxesHelper(2*this._overall_size));
this._scene.add(new f.GridHelper(Math.ceil(this._overall_size),Math.ceil(this._overall_size)/50));this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}};e.prototype.drawCount=function(a,b){function c(a){return JSROOT.batch_mode?"anytime ms":a.toString()+" ms"}var d=this,k=["Unique nodes: "+this._clones.nodes.length,
"Unique visible: "+a,"Time to clone: "+c(b)];this._clones.scanVisible();var h=0,e={clones:this._clones,cnt:[],func:function(a){void 0===this.cnt[this.last]?this.cnt[this.last]=1:this.cnt[this.last]++;h+=g.countNumShapes(this.clones.getNodeShape(a.id));return!0}},f=(new Date).getTime(),q=this._clones.scanVisible(e),l=(new Date).getTime();k.push("Total visible nodes: "+q,"Total shapes: "+h);for(a=0;a<e.cnt.length;++a)void 0!==e.cnt[a]&&k.push("  lvl"+a+": "+e.cnt[a]);k.push("Time to scan: "+c(l-f),
"","Check timing for matrix calculations ...");var u=this.selectDom().style("overflow","auto");JSROOT.batch_mode?u.property("_json_object_",k):k.forEach(function(a){return u.append("p").text(a)});return new Promise(function(a){setTimeout(function(){e.domatrix=!0;f=(new Date).getTime();q=d._clones.scanVisible(e);l=(new Date).getTime();var b="Time to scan with matrix: "+c(l-f);JSROOT.batch_mode?k.push(b):u.append("p").text(b);a(d)},100)})};e.prototype.performDrop=function(a,b,c,d){var k=this;if(a&&
"TTree"===a.$kind)return b="extract_geo_tracks",d&&0<d.indexOf("$")&&(b=d.substr(0,d.indexOf("$")),d=d.substr(d.indexOf("$")+1)),(c=JSROOT.findFunction(b))?c(a,d).then(function(a){a&&(k.drawExtras(a,"",!1),k.updateClipping(!0),k.render3D(100));return k}):Promise.reject(Error("Function "+b+" not found"));this.drawExtras(a,b)&&(c&&(c._painter=this),this.render3D(100));return Promise.resolve(this)};e.prototype.mouseOverHierarchy=function(a,b,c){this.ctrl&&(c=c._obj,this.ctrl._debug&&console.log("Mouse over",
a,b,c?c._typename:"---"),!c||"TEveTrack"!==c._typename&&"TEvePointSet"!==c._typename&&"TPolyMarker3D"!==c._typename||this.highlightMesh(null,65280,a?c:null))};e.prototype.clearExtras=function(){this.getExtrasContainer("delete");delete this._extraObjects;this.render3D()};e.prototype.addExtra=function(a,b){void 0===this._extraObjects&&(this._extraObjects=JSROOT.create("TList"));if(0<=this._extraObjects.arr.indexOf(a))return!1;this._extraObjects.Add(a,b);delete a.$hidden_via_menu;return!0};e.prototype.extraObjectVisible=
function(a,b,c){if(this._extraObjects){a=a.itemFullName(b);var d=this._extraObjects.opt.indexOf(a);0>d&&b._obj&&(d=this._extraObjects.arr.indexOf(b._obj),0<=d&&(this._extraObjects.opt[d]=a));if(!(0>d)){var k=this._extraObjects.arr[d];b=k.$hidden_via_menu?!1:!0;if(c){k.$hidden_via_menu=b;b=!b;var h=null;this._toplevel.traverse(function(a){a.geo_object===k&&(h=a)});h?h.visible=b:b&&(this.drawExtras(k,"",!1),this.updateClipping(!0));(h||b)&&this.render3D()}return b}}};e.prototype.drawExtras=function(a,
b,c){if(!a||!a._typename||!c&&a.$hidden_via_menu)return!1;var d=!1,k=!1;void 0===c&&(k=c=!0);if("TList"===a._typename||"TObjArray"===a._typename){if(!a.arr)return!1;for(var h=0;h<a.arr.length;++h){var e=a.arr[h],f=a.opt?a.opt[h]:"";f||(f=(b||"<prnt>")+"/["+h+"]");this.drawExtras(e,f,c)&&(d=!0)}}else if("THREE.Mesh"===a._typename)this.addToExtrasContainer(a),d=!0;else if("TGeoTrack"===a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawGeoTrack(a,b)}else if("TEveTrack"===a._typename||"ROOT::Experimental::TEveTrack"===
a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawEveTrack(a,b)}else if("TEvePointSet"===a._typename||"ROOT::Experimental::TEvePointSet"===a._typename||"TPolyMarker3D"===a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawHit(a,b)}else if("TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::REveGeoShapeExtract"===a._typename){if(c&&!this.addExtra(a,b))return!1;d=this.drawExtraShape(a,b)}k&&d&&(this.updateClipping(!0),this.render3D(100));return d};e.prototype.getExtrasContainer=
function(a,b){if(!this._toplevel)return null;b||(b="tracks");for(var c=null,d=[],k=0;k<this._toplevel.children.length;++k){var h=this._toplevel.children[k];if(h._extras)if("collect"===a)d.push(h);else if(h._extras===b){c=h;break}}if("collect"===a){for(a=0;a<d.length;++a)this._toplevel.remove(d[a]);return d}if("delete"===a)return c&&this._toplevel.remove(c),r.disposeThreejsObject(c),null;"get"===a||c||(c=new f.Object3D,c._extras=b,this._toplevel.add(c));return c};e.prototype.addToExtrasContainer=function(a,
b){(b=this.getExtrasContainer("",b))?b.add(a):(console.warn("Fail to add object to extras"),r.disposeThreejsObject(a))};e.prototype.drawGeoTrack=function(a,b){if(!a||!a.fNpoints)return!1;var c=a.fLineWidth||1,d=r.getColor(a.fLineColor)||"rgb(255,0,255)";JSROOT.browser.isWin&&(c=1);for(var k=Math.round(a.fNpoints/4),h=new Float32Array(6*(k-1)),e=0,g=this.ctrl.projectPos,q="x"===this.ctrl.project,l="y"===this.ctrl.project,u="z"===this.ctrl.project,p=0;p<k-1;++p)h[e]=q?g:a.fPoints[4*p],h[e+1]=l?g:a.fPoints[4*
p+1],h[e+2]=u?g:a.fPoints[4*p+2],h[e+3]=q?g:a.fPoints[4*p+4],h[e+4]=l?g:a.fPoints[4*p+5],h[e+5]=u?g:a.fPoints[4*p+6],e+=6;c=new f.LineBasicMaterial({color:d,linewidth:c});h=r.createLineSegments(h,c);h.renderOrder=1E6;h.geo_name=b;h.geo_object=a;h.hightlightWidthScale=2;b&&0==b.indexOf("<prnt>/Tracks")&&(h.main_track=!0);this.addToExtrasContainer(h);return!0};e.prototype.drawEveTrack=function(a,b){if(!a||0>=a.fN)return!1;var c=a.fLineWidth||1,d=r.getColor(a.fLineColor)||"rgb(255,0,255)";JSROOT.browser.isWin&&
(c=1);for(var e=new Float32Array(6*(a.fN-1)),h=0,g=this.ctrl.projectPos,t="x"===this.ctrl.project,q="y"===this.ctrl.project,l="z"===this.ctrl.project,u=0;u<a.fN-1;++u)e[h]=t?g:a.fP[3*u],e[h+1]=q?g:a.fP[3*u+1],e[h+2]=l?g:a.fP[3*u+2],e[h+3]=t?g:a.fP[3*u+3],e[h+4]=q?g:a.fP[3*u+4],e[h+5]=l?g:a.fP[3*u+5],h+=6;c=new f.LineBasicMaterial({color:d,linewidth:c});e=r.createLineSegments(e,c);e.renderOrder=1E6;e.geo_name=b;e.geo_object=a;e.hightlightWidthScale=2;this.addToExtrasContainer(e);return!0};e.prototype.drawHit=
function(a,b){if(!a||!a.fN||0>a.fN)return!1;var c=a.fMarkerSize*this.getOverallSize()*.005;.2>=c&&(c=.2);var d=a.fMarkerStyle;if(4==d||2==d)d=7,c*=1.5;var e=a.fN,h=this.ctrl.projectPos,f="x"===this.ctrl.project,g="y"===this.ctrl.project,q="z"===this.ctrl.project;c=new r.PointsCreator(e,this._webgl,c);for(var l=0;l<e;l++)c.addPoint(f?h:a.fP[3*l],g?h:a.fP[3*l+1],q?h:a.fP[3*l+2]);d=c.createPoints({color:r.getColor(a.fMarkerColor)||"rgb(0,0,255)",style:d});d.renderOrder=1E6;d.highlightScale=2;d.geo_name=
b;d.geo_object=a;this.addToExtrasContainer(d);return!0};e.prototype.drawExtraShape=function(a,b){var c=g.build(a);if(!c)return!1;c.geo_name=b;c.geo_object=a;this.addToExtrasContainer(c);return!0};e.prototype.findNodeWithVolume=function(a,b,c,d,e){var h=!1,f=null;if(c)0<d.length&&(d+="/"),d+=c.fName;else{c=this.getGeometry();if(!c&&0!==g.getNodeKind(c))return null;d=this.geo_manager?c.fName:"";h=!0;e=[]}if(!c.fVolume||c.fVolume._searched)return null;if(a.test(c.fVolume.fName)&&(f=b({node:c,item:d})))return f;
c.fVolume._searched=!0;e.push(c.fVolume);if(c.fVolume.fNodes)for(var k=0;k<c.fVolume.fNodes.arr.length&&!(f=this.findNodeWithVolume(a,b,c.fVolume.fNodes.arr[k],d,e));++k);if(h)for(a=0,b=e.length;a<b;++a)delete e[a]._searched;return f};e.prototype.loadMacro=function(a){var b={obj:this.getGeometry(),prefix:""};this.geo_manager&&(b.prefix=b.obj.fName);if(!a||3>a.length||0!==g.getNodeKind(b.obj))return Promise.resolve(b);var c=this,d={GetVolume:function(a){var d=c.findNodeWithVolume(new RegExp("^"+a+
"$"),function(a){return a});d||console.log("Did not found "+a+" volume");return{found:d,fVolume:d?d.node.fVolume:null,InvisibleAll:function(a){g.setInvisibleAll(this.fVolume,a)},Draw:function(){this.found&&this.fVolume&&(b.obj=this.found.node,b.prefix=this.found.item,console.log("Select volume for drawing",this.fVolume.fName,b.prefix))},SetTransparency:function(a){this.fVolume&&this.fVolume.fMedium&&this.fVolume.fMedium.fMaterial&&(this.fVolume.fMedium.fMaterial.fFillStyle=3E3+a)},SetLineColor:function(a){this.fVolume&&
(this.fVolume.fLineColor=a)}}},DefaultColors:function(){c.ctrl.dflt_colors=!0},SetMaxVisNodes:function(a){c.ctrl.maxnodes||(c.ctrl.maxnodes=pasrseInt(a)||0)},SetVisLevel:function(a){c.ctrl.vislevel||(c.ctrl.vislevel=parseInt(a)||0)}};r.showProgress("Loading macro "+a);return JSROOT.httpRequest(a,"text").then(function(a){a=a.split("\n");for(var c=0;c<a.length;){var e=a[c++].trim();if(!(0==e.indexOf("//")||0>e.indexOf("gGeoManager")||(e=e.replace("->GetVolume",".GetVolume"),e=e.replace("->InvisibleAll",
".InvisibleAll"),e=e.replace("->SetMaxVisNodes",".SetMaxVisNodes"),e=e.replace("->DefaultColors",".DefaultColors"),e=e.replace("->Draw",".Draw"),e=e.replace("->SetTransparency",".SetTransparency"),e=e.replace("->SetLineColor",".SetLineColor"),e=e.replace("->SetVisLevel",".SetVisLevel"),0<=e.indexOf("->"))))try{(new Function("gGeoManager",e))(d)}catch(t){console.error("Problem by processing "+e)}}return b}).catch(function(){console.error("Fail to load "+a);return b})};e.prototype.assignClones=function(a){this._clones_owner=
!0;this._clones=a};e.prototype.prepareObjectDraw=function(a,b){var c=this;if(this.did_cleanup)return Promise.resolve(null);if("__geom_viewer_append__"==b)this._new_append_nodes=a,this.ctrl.use_worker=0,this._geom_viewer=!0;else if("__geom_viewer_selection__"==b&&this._clones)this._new_draw_nodes=a,this.ctrl.use_worker=0,this._geom_viewer=!0;else if(this._main_painter)this._clones_owner=!1,this._clones=this._main_painter._clones,console.log("Reuse clones",this._clones.nodes.length,"from main painter");
else if(a){this._start_drawing_time=(new Date).getTime();this._clones_owner=!0;this._clones=new g.ClonedNodes(a);a=this.ctrl.vislevel;var d=this.ctrl.maxnodes;this.geo_manager&&(!a&&this.geo_manager.fVisLevel&&(a=this.geo_manager.fVisLevel),d||(d=this.geo_manager.fMaxVisNodes));this._clones.setVisLevel(a);this._clones.setMaxVisNodes(d);this._clones.name_prefix=b;a=!!this.geo_manager&&!this.ctrl.showtop;b=this.ctrl.no_screen?0:this._clones.markVisibles(!0,!1,a);b=0>=b?this._clones.markVisibles(!1,
!1,a):this._clones.markVisibles(!0,!0,a);this._clones.produceIdShifts();a=(new Date).getTime()-this._start_drawing_time;this._scene||console.log("Creating clones",this._clones.nodes.length,"takes",a,"uniquevis",b);if(this.options._count)return this.drawCount(b,a)}else this._clones_owner=!1,this._clones=null;this._scene||(this.ctrl.maxlimit=(this._webgl?2E5:1E5)*this.ctrl.more,this._first_drawing=!0,0<this.ctrl.use_worker&&this.startWorker(),r.assign3DHandler(this),b=this.getSizeFor3d(this._webgl?
void 0:3),this._fit_main_area=-1===b.can3d,a=this.createScene(b.width,b.height),this.add3dCanvas(b,a,this._webgl),this.setAsMainPainter());this.createToolbar();if(this._clones)return new Promise(function(a){c._resolveFunc=a;c.showDrawInfo("Drawing geometry");c.startDrawGeometry(!0)});this.completeDraw();return Promise.resolve(this)};e.prototype.showDrawInfo=function(a){if(this._first_drawing&&this._start_drawing_time){var b=this._renderer.domElement.parentNode,c=p.select(b).select(".geo_info");if(a){var d=
.001*((new Date).getTime()-this._start_drawing_time);c.empty()&&(c=p.select(b).append("p").attr("class","geo_info"));c.html(a+", "+d.toFixed(1)+"s")}else c.remove()}};e.prototype.continueDraw=function(){if(0!==this.drawing_stage){for(var a=(new Date).getTime(),b=this._first_drawing?1E3:200,c=a;;){var d=this.nextDrawAction();if(!d)break;c=(new Date).getTime();if(1E5<c-this._startm){this.drawing_stage=0;break}if(!(!0===d&&c-a<b)&&(c-a>b||1===d||2===d)){r.showProgress(this.drawing_log);this.showDrawInfo(this.drawing_log);
this._first_drawing&&this._webgl&&100<this._num_meshes-this._last_render_meshes&&c-this._last_render_tm>2.5*b&&(this.adjustCameraPosition(),this.render3D(-1),this._last_render_meshes=this.ctrl.info.num_meshes);2!==d&&setTimeout(this.continueDraw.bind(this),1===d?100:1);return}}a=c-this._startm;this._first_drawing&&console.log("Create tm = "+a+" meshes "+this.ctrl.info.num_meshes+" faces "+this.ctrl.info.num_faces);if(300<a)return r.showProgress("Rendering geometry"),this.showDrawInfo("Rendering"),
setTimeout(this.completeDraw.bind(this,!0),10);this.completeDraw(!0)}};e.prototype.testCameraPosition=function(a){this._camera.updateMatrixWorld();var b=this._camera.position.clone();!a&&this._last_camera_position&&this._last_camera_position.distanceTo(b)<1E-4*(this._overall_size||1E3)||(this._last_camera_position=b,!this.ctrl.project&&this._webgl&&g.produceRenderOrder(this._toplevel,b,this.ctrl.depthMethod,this._clones))};e.prototype.render3D=function(a,b){var c=this;if(this._renderer)if(void 0===
a&&(a=5),0<a&&this._webgl&&!JSROOT.batch_mode)this.render_tmout||(this.render_tmout=setTimeout(function(){return c.render3D(0,b)},a));else{this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout);r.beforeRender3D(this._renderer);var d=new Date;this.testCameraPosition(-1===a);this._webgl&&this._effectComposer&&0<this._effectComposer.passes.length?this._effectComposer.render():this._renderer.render(this._scene,this._camera);a=new Date;this.last_render_tm=a.getTime();0===this.first_render_tm&&
b&&(this.first_render_tm=a.getTime()-d.getTime(),console.log("three.js r"+f.REVISION+", first render tm = "+this.first_render_tm));return r.afterRender3D(this._renderer)}else console.warn("renderer object not exists - check code")};e.prototype.startWorker=function(){if(!this._worker){this._worker_ready=!1;this._worker_jobs=0;var a=this;this._worker=new Worker(JSROOT.source_dir+"scripts/JSRoot.geoworker.js");this._worker.onmessage=function(b){if("object"===typeof b.data){if("log"in b.data)return console.log("geo: "+
b.data.log);if("progress"in b.data)return r.showProgress(b.data.progress);b.data.tm3=(new Date).getTime();"init"in b.data?(a._worker_ready=!0,console.log("Worker ready: "+(b.data.tm3-b.data.tm0))):a.processWorkerReply(b.data)}};this._worker.postMessage({init:!0,browser:JSROOT.browser,tm0:(new Date).getTime(),vislevel:this._clones.getVisLevel(),maxvisnodes:this._clones.getMaxVisNodes(),clones:this._clones.nodes,sortmap:this._clones.sortmap})}};e.prototype.canSubmitToWorker=function(a){return this._worker?
this._worker_ready&&(0==this._worker_jobs||a):!1};e.prototype.submitToWorker=function(a){if(!this._worker)return!1;this._worker_jobs++;a.tm0=(new Date).getTime();this._worker.postMessage(a)};e.prototype.processWorkerReply=function(a){this._worker_jobs--;if("collect"in a)return this._new_draw_nodes=a.new_nodes,this._draw_all_nodes=a.complete,this.drawing_stage=3,this.continueDraw();if("shapes"in a){for(var b=0;b<a.shapes.length;++b){var c=a.shapes[b],d=this._build_shapes[b];c.buf_pos&&c.buf_norm&&
(0===c.buf_pos.length?d.geom=null:c.buf_pos.length!==c.buf_norm.length?(console.error("item.buf_pos",c.buf_pos.length,"item.buf_norm",c.buf_norm.length),d.geom=null):(d.geom=new f.BufferGeometry,d.geom.setAttribute("position",new f.BufferAttribute(c.buf_pos,3)),d.geom.setAttribute("normal",new f.BufferAttribute(c.buf_norm,3))),d.ready=!0,d.nfaces=c.nfaces)}a.tm4=(new Date).getTime();this.drawing_stage=7;return this.continueDraw()}};e.prototype.testGeomChanges=function(){if(this._main_painter)return console.warn("Get testGeomChanges call for slave painter"),
this._main_painter.testGeomChanges();this.startDrawGeometry();for(var a=0;a<this._slave_painters.length;++a)this._slave_painters[a].startDrawGeometry()};e.prototype.drawSimpleAxis=function(a){this.getExtrasContainer("delete","axis");if(!this.ctrl._axis)return a?null:this.render3D();var b=this.getGeomBoundingBox(this._toplevel),c=this.getExtrasContainer("create","axis"),d=.02*Math.max(b.max.x-b.min.x,b.max.y-b.min.y,b.max.z-b.min.z),e=[0,0,0],h=["x","y","z"],g=["X","Y","Z"],t=["red","green","blue"],
q=this.ctrl.ortho_camera,l=[this.ctrl._yup,this.ctrl._yup,this.ctrl._yup],u=3;if(2==this.ctrl._axis)for(var p=0;3>p;++p){var m=h[p];0>=b.min[m]&&0<=b.max[m]||(e[p]=(b.min[m]+b.max[m])/2)}this.ctrl.ortho_camera&&(u=2,g[0]=g[2],t[0]=t[2],l[0]=l[2],q=!0);p={};for(m=0;m<u;p={$jscomp$loop$prop$name$13$18:p.$jscomp$loop$prop$name$13$18},++m){var x=function(a){return function(c){return 2>b.max[a.$jscomp$loop$prop$name$13$18]-b.min[a.$jscomp$loop$prop$name$13$18]?c.toFixed(3):1E5<Math.abs(c)?c.toExponential(3):
Math.round(c).toString()}}(p),w=new Float32Array(6),y=t[m];p.$jscomp$loop$prop$name$13$18=h[m];var v=x(b.max[p.$jscomp$loop$prop$name$13$18]);w[0]=b.min.x;w[1]=b.min.y;w[2]=b.min.z;w[3]=b.min.x;w[4]=b.min.y;w[5]=b.min.z;switch(m){case 0:w[3]=b.max.x;v=l[0]&&!q?g[0]+" "+v:v+(" "+g[0]);break;case 1:w[4]=b.max.y;v=l[1]?v+(" "+g[1]):g[1]+" "+v;break;case 2:w[5]=b.max.z,v+=" "+g[2]}if(2==this.ctrl._axis)for(var n=0;6>n;++n)n%3!==m&&(w[n]=e[n%3]);n=new f.LineBasicMaterial({color:y});n=r.createLineSegments(w,
n);c.add(n);y=new f.MeshBasicMaterial({color:y});0===e[m]&&e[m]>=b.min[p.$jscomp$loop$prop$name$13$18]&&e[m]<=b.max[p.$jscomp$loop$prop$name$13$18]&&(2!=this.ctrl._axis||0===m)&&(n=q?new f.CircleBufferGeometry(.25*d):new f.SphereBufferGeometry(.25*d),n=new f.Mesh(n,y),n.translateX(0===m?e[0]:w[0]),n.translateY(1===m?e[1]:w[1]),n.translateZ(2===m?e[2]:w[2]),c.add(n));v=new f.TextGeometry(v,{font:JSROOT.threejs_font_helvetiker_regular,size:d,height:0,curveSegments:5});n=new f.Mesh(v,y);v=(new f.Box3).setFromObject(n);
n.translateX(w[3]);n.translateY(w[4]);n.translateZ(w[5]);if(l[m])switch(m){case 0:q?n.translateX(.5*d):(n.rotateY(Math.PI),n.translateX(-v.max.x-.5*d));n.translateY(-v.max.y/2);break;case 1:q?n.rotateZ(Math.PI/2):(n.rotateX(-Math.PI/2),n.rotateY(-Math.PI/2));n.translateX(.5*d);n.translateY(-v.max.y/2);break;case 2:n.rotateY(-Math.PI/2),n.translateX(.5*d),n.translateY(-v.max.y/2)}else switch(m){case 0:n.rotateX(Math.PI/2);n.translateY(-v.max.y/2);n.translateX(.5*d);break;case 1:n.rotateX(Math.PI/2);
n.rotateY(-Math.PI/2);n.translateX(-v.max.x-.5*d);n.translateY(-v.max.y/2);break;case 2:n.rotateX(Math.PI/2),n.rotateZ(Math.PI/2),n.translateX(.5*d),n.translateY(-v.max.y/2)}c.add(n);v=new f.TextGeometry(x(b.min[p.$jscomp$loop$prop$name$13$18]),{font:JSROOT.threejs_font_helvetiker_regular,size:d,height:0,curveSegments:5});n=new f.Mesh(v,y);v=(new f.Box3).setFromObject(n);n.translateX(w[0]);n.translateY(w[1]);n.translateZ(w[2]);if(l[m])switch(m){case 0:q?n.translateX(-v.max.x-.5*d):(n.rotateY(Math.PI),
n.translateX(.5*d));n.translateY(-v.max.y/2);break;case 1:q?n.rotateZ(Math.PI/2):(n.rotateX(-Math.PI/2),n.rotateY(-Math.PI/2));n.translateY(-v.max.y/2);n.translateX(-v.max.x-.5*d);break;case 2:n.rotateY(-Math.PI/2),n.translateX(-v.max.x-.5*d),n.translateY(-v.max.y/2)}else switch(m){case 0:n.rotateX(Math.PI/2);n.translateX(-v.max.x-.5*d);n.translateY(-v.max.y/2);break;case 1:n.rotateX(Math.PI/2);n.rotateY(-Math.PI/2);n.translateY(-v.max.y/2);n.translateX(.5*d);break;case 2:n.rotateX(Math.PI/2),n.rotateZ(Math.PI/
2),n.translateX(-v.max.x-.5*d),n.translateY(-v.max.y/2)}c.add(n)}this.changedDepthMethod(a?"norender":void 0)};e.prototype.toggleAxesDraw=function(){this.setAxesDraw("toggle")};e.prototype.setAxesDraw=function(a){this.ctrl._axis="toggle"===a?this.ctrl._axis?0:1:"number"==typeof a?a:a?1:0;this.drawSimpleAxis()};e.prototype.setAutoRotate=function(a){this.ctrl.project||(void 0!==a&&(this.ctrl.rotate=a),this.autorotate(2.5))};e.prototype.toggleWireFrame=function(){this.ctrl.wireframe=!this.ctrl.wireframe;
this.changedWireFrame()};e.prototype.setWireFrame=function(a){this.ctrl.wireframe=a?!0:!1;this.changedWireFrame()};e.prototype.setShowTop=function(a){this.ctrl.showtop=a?!0:!1;this.redrawObject("same")};e.prototype.changedClipping=function(a){var b=this.ctrl.clip;if(!(void 0!==a&&0<=a)||b[a].enabled){if(b[0].enabled||b[1].enabled||b[2].enabled)this.ctrl.ssao.enabled=!1,this.removeSSAO();this.updateClipping(!1,!0)}};e.prototype.changedDepthTest=function(){if(this._toplevel){var a=this.ctrl.depthTest;
this._toplevel.traverse(function(b){b instanceof f.Mesh&&(b.material.depthTest=a)});this.render3D(0)}};e.prototype.changedDepthMethod=function(a){delete this._last_camera_position;"norender"!==a&&this.render3D()};e.prototype.changedHighlight=function(){this.ctrl.highlight||this.highlightMesh(null)};e.prototype.updateClipping=function(a,b){if(this._webgl){for(var c=this.ctrl.clip,d=[],e=!1,h=[c[0].value,-1*c[1].value,(this.ctrl._yup?-1:1)*c[2].value],g=this.ctrl.clipIntersect?16:0,t=0;3>t;++t)c[t].enabled&&
(g+=2<<t),this._clipPlanes[t].constant!=h[t]&&(e=!0,this._clipPlanes[t].constant=h[t]);this.ctrl.ssao.enabled||(c[0].enabled&&d.push(this._clipPlanes[0]),c[1].enabled&&d.push(this._clipPlanes[1]),c[2].enabled&&d.push(this._clipPlanes[2]),g+=1E3*d.length);0==d.length&&(d=null);this._clipCfg!==g&&(e=!0);this._clipCfg=g;c=!!d;var q=this.ctrl.clipIntersect,l=c?f.DoubleSide:f.FrontSide;(b||e)&&this._scene.traverse(function(a){a.hasOwnProperty("material")&&a.material&&void 0!==a.material.clippingPlanes&&
(a.material.clippingPlanes!==d&&(a.material.clipIntersection=q,a.material.clippingPlanes=d,a.material.needsUpdate=!0),void 0!==a.material.emissive&&a.material.side!=l&&(a.material.side=l,a.material.needsUpdate=!0))});this.ctrl.bothSides=c;a||this.render3D(0);return e}};e.prototype.setCompleteHandler=function(a){this._complete_handler=a};e.prototype.completeDraw=function(a){var b=!1,c=!1,d=!0;if(this.ctrl){this._clones?(this._first_drawing||this._full_redrawing)&&this.ctrl.tracks&&this.geo_manager&&
this.drawExtras(this.geo_manager.fTracks,"<prnt>/Tracks"):(d=!1,this.getExtrasContainer("delete"),this.drawExtras((this._main_painter?this._main_painter._extraObjects:null)||this._extraObjects,"",!1));this._full_redrawing&&(this._full_redrawing=!1,c=!0,this.changedDepthMethod("norender"));this._first_drawing&&(this.adjustCameraPosition(!0),this.showDrawInfo(),this._first_drawing=!1,c=b=!0);0!==this.ctrl.transparency&&this.changedGlobalTransparency(this.ctrl.transparency,!0);b&&this.completeScene();
c&&(this.ctrl.trans_radial||this.ctrl.trans_z)&&this.changedTransformation("norender");c&&this.ctrl._axis&&this.drawSimpleAxis(!0);this._scene.overrideMaterial=null;void 0!==this._provided_more_nodes&&(this.appendMoreNodes(this._provided_more_nodes,!0),delete this._provided_more_nodes);d&&(this.getExtrasContainer("delete"),this.drawExtras((this._main_painter?this._main_painter._extraObjects:null)||this._extraObjects,"",!1));this.updateClipping(!0);this.render3D(0,!0);a&&r.showProgress();this.addOrbitControls();
this.addTransformControl();b&&(!1===this.ctrl.highlight&&(this.ctrl.highlight=1E3>this.first_render_tm),!1===this.ctrl.highlight_scene&&(this.ctrl.highlight_scene=this.ctrl.highlight),this._webgl&&this.ctrl.rotate&&!this.ctrl.project&&this.autorotate(2.5),this._webgl&&this.ctrl.show_controls&&!JSROOT.batch_mode&&this.showControlOptions(!0));this.setAsMainPainter();"function"==typeof this._resolveFunc&&(this._resolveFunc(this),delete this._resolveFunc);"function"==typeof this._complete_handler&&this._complete_handler(this);
if(this._draw_nodes_again)return this.startDrawGeometry();this._drawing_ready=!0}else console.warn("ctrl object does not exist in completeDraw - something went wrong")};e.prototype.isDrawingReady=function(){return this._drawing_ready||!1};e.prototype.removeDrawnNode=function(a){if(this._draw_nodes){for(var b=[],c=0;c<this._draw_nodes.length;++c){var d=this._draw_nodes[c];d.nodeid===a||this._clones.isIdInStack(a,d.stack)?this._clones.createObject3D(d.stack,this._toplevel,"delete_mesh"):b.push(d)}b.length<
this._draw_nodes.length&&(this._draw_nodes=b,this.render3D())}};e.prototype.cleanup=function(a){if(!a){this.removeSSAO();this.clearTopPainter();a=this.clear3dCanvas();this._toolbar&&this._toolbar.cleanup();this.helpText();r.disposeThreejsObject(this._scene);r.disposeThreejsObject(this._full_geom);this._tcontrols&&this._tcontrols.dispose();this._controls&&this._controls.cleanup();this._context_menu&&this._renderer.domElement.removeEventListener("contextmenu",this._context_menu,!1);this._datgui&&this._datgui.destroy();
this._worker&&this._worker.terminate();delete this._animating;var b=this.getGeometry();b&&this.ctrl.is_main&&(b.$geo_painter===this?delete b.$geo_painter:b.fVolume&&b.fVolume.$geo_painter===this&&delete b.fVolume.$geo_painter);this._main_painter&&(b=this._main_painter._slave_painters.indexOf(this),0<=b&&this._main_painter._slave_painters.splice(b,1));for(b=0;b<this._slave_painters.length;++b){var c=this._slave_painters[b];c&&c._main_painter===this&&(c._main_painter=null)}delete this.geo_manager;delete this._highlight_handlers;
JSROOT.ObjectPainter.prototype.cleanup.call(this);delete this.ctrl;delete this.options;this.did_cleanup=!0;0>a&&this.selectDom().html("")}if(this._slave_painters)for(var d in this._slave_painters)a=this._slave_painters[d],a._main_painter=null,a._clones===this._clones&&(a._clones=null);this._main_painter=null;this._slave_painters=[];this._renderer&&(this._renderer.dispose&&this._renderer.dispose(),this._renderer.forceContextLoss&&this._renderer.forceContextLoss());delete this._scene;this._scene_height=
this._scene_width=0;this._toplevel=this._renderer=null;delete this._full_geom;delete this._camera;delete this._camera0pos;delete this._lookat;delete this._selected_mesh;this._clones&&this._clones_owner&&this._clones.cleanup(this._draw_nodes,this._build_shapes);delete this._clones;delete this._clones_owner;delete this._draw_nodes;delete this._drawing_ready;delete this._build_shapes;delete this._new_draw_nodes;delete this._new_append_nodes;delete this._last_camera_position;this.drawing_stage=this.last_render_tm=
this.first_render_tm=0;delete this.drawing_log;delete this._datgui;delete this._controls;delete this._context_menu;delete this._tcontrols;delete this._toolbar;delete this._worker};e.prototype.helpText=function(a){r.showProgress(a)};e.prototype.checkResize=function(a){var b=this.getCanvPainter();if(b&&!b.checkCanvasResize(a))return!1;a=this.getSizeFor3d();if(this._scene_width===a.width&&this._scene_height===a.height||10>a.width||10>a.height)return!1;this._scene_width=a.width;this._scene_height=a.height;
this._camera&&this._renderer&&("PerspectiveCamera"==this._camera.type&&(this._camera.aspect=this._scene_width/this._scene_height),this._camera.updateProjectionMatrix(),this._renderer.setSize(this._scene_width,this._scene_height,!this._fit_main_area),this._effectComposer&&this._effectComposer.setSize(this._scene_width,this._scene_height),this.drawing_stage||this.render3D());return!0};e.prototype.toggleEnlarge=function(){this.enlargeMain("toggle")&&this.checkResize()};e.prototype.ownedByTransformControls=
function(a){for(a=a.parent;a&&!(a instanceof f.TransformControls);)a=a.parent;return a&&a instanceof f.TransformControls};e.prototype.accessObjectWireFrame=function(a,b){if(a.hasOwnProperty("material")&&!(a instanceof f.GridHelper)&&!this.ownedByTransformControls(a))return void 0!==b&&a.stack&&(a.material.wireframe=b),a.material.wireframe};e.prototype.changedWireFrame=function(){var a=this;if(this._scene){var b=this.ctrl.wireframe;this._scene.traverse(function(c){return a.accessObjectWireFrame(c,
b)});this.render3D()}};e.prototype.updateObject=function(a){if("same"===a)return!0;if(!a||!a._typename)return!1;if(a===this.getObject())return!0;if(this.geo_manager&&"TGeoManager"==a._typename)return this.geo_manager=a,this.assignObject({_typename:"TGeoNode",fVolume:a.fMasterVolume,fName:a.fMasterVolume.fName,$geoh:a.fMasterVolume.$geoh,_proxy:!0}),!0;if(!this.matchObjectType(a._typename))return!1;this.assignObject(a);return!0};e.prototype.clearDrawings=function(){this._clones&&this._clones_owner&&
this._clones.cleanup(this._draw_nodes,this._build_shapes);delete this._clones;delete this._clones_owner;delete this._draw_nodes;delete this._drawing_ready;delete this._build_shapes;delete this._extraObjects;delete this._clipCfg;r.disposeThreejsObject(this._toplevel,!0);this._full_redrawing=!0};e.prototype.redrawObject=function(a){if(!this.updateObject(a))return!1;this.clearDrawings();a=this.getGeometry();var b="";this.geo_manager&&(b=a.fName);this.prepareObjectDraw(a,b);return!0};r.createGeoPainter=
function(a,b,c){g.GradPerSegm=JSROOT.settings.GeoGradPerSegm;g.CompressComp=JSROOT.settings.GeoCompressComp;a=new e(a,b);a.options=a.decodeOptions(c);JSROOT.extend(a.ctrl,a.options);a.ctrl.ssao.enabled=a.options.usessao;a.ctrl.clip[0].enabled=a.options.clipx;a.ctrl.clip[1].enabled=a.options.clipy;a.ctrl.clip[2].enabled=a.options.clipz;return a};var z=function(a,b,c){if(!b)return null;var d=null,e=null,h="",f=!1;"fShapeBits"in b&&"fShapeId"in b?(d=b,b=null):"TGeoVolumeAssembly"===b._typename||"TGeoVolume"===
b._typename?d=b.fShape:"TEveGeoShapeExtract"===b._typename||"ROOT::Experimental::REveGeoShapeExtract"===b._typename?(d=b.fShape,f=!0):"TGeoManager"===b._typename?d=b.fMasterVolume.fShape:"TGeoOverlap"===b._typename?(e=b.fMarker,h="<prnt>/Marker",b=g.buildOverlapVolume(b),c||(c="wire")):"fVolume"in b?b.fVolume&&(d=b.fVolume.fShape):b=null;"string"==typeof c&&0==c.indexOf("comp")&&d&&"TGeoCompositeShape"==d._typename&&d.fNode&&(b=1,c=c.substr(4),"x"==c[0]&&(b=999,c=c.substr(1)+"_vislvl999"),b=g.buildCompositeVolume(d,
b));!b&&d&&(b=JSROOT.extend(JSROOT.create("TEveGeoShapeExtract"),{fTrans:null,fShape:d,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:!0}));if(!b)return null;var t=r.createGeoPainter(a,b,c);t.ctrl.is_main&&!b.$geo_painter&&(b.$geo_painter=t);!t.ctrl.is_main&&t.ctrl.project&&b.$geo_painter&&(t._main_painter=b.$geo_painter,t._main_painter._slave_painters.push(t));if(f&&!t.ctrl.vislevel||9>t.ctrl.vislevel)t.ctrl.vislevel=9;e&&(t._splitColors=!0,t.addExtra(e,h));return t.loadMacro(t.ctrl.script_name).then(function(a){return t.prepareObjectDraw(a.obj,
a.prefix)})};g.buildCompositeVolume=function(a,b,c){void 0===b&&(b=1);c||(this.$comp_col_cnt=0,c="");var d=JSROOT.create("TGeoVolume");g.SetBit(d,g.BITS.kVisThis,!0);g.SetBit(d,g.BITS.kVisDaughters,!0);if(c&&"TGeoCompositeShape"!==a._typename||0>=b)return d.fName=c,d.fLineColor=this.$comp_col_cnt++%8+2,d.fShape=a,d;c&&(c+="/");d.$geoh=!0;d.fName="";var e=JSROOT.create("TGeoNodeMatrix");g.SetBit(e,g.BITS.kVisThis,!0);g.SetBit(e,g.BITS.kVisDaughters,!0);e.fName="Left";e.fMatrix=a.fNode.fLeftMat;e.fVolume=
g.buildCompositeVolume(a.fNode.fLeft,b-1,c+"Left");var f=JSROOT.create("TGeoNodeMatrix");g.SetBit(f,g.BITS.kVisThis,!0);g.SetBit(f,g.BITS.kVisDaughters,!0);f.fName="Right";f.fMatrix=a.fNode.fRightMat;f.fVolume=g.buildCompositeVolume(a.fNode.fRight,b-1,c+"Right");d.fNodes=JSROOT.create("TList");d.fNodes.Add(e);d.fNodes.Add(f);c||delete this.$comp_col_cnt;return d};g.buildOverlapVolume=function(a){var b=JSROOT.create("TGeoVolume");g.SetBit(b,g.BITS.kVisDaughters,!0);b.$geoh=!0;b.fName="";var c=JSROOT.create("TGeoNodeMatrix");
c.fName=a.fVolume1.fName||"Overlap1";c.fMatrix=a.fMatrix1;c.fVolume=a.fVolume1;var d=JSROOT.create("TGeoNodeMatrix");d.fName=a.fVolume2.fName||"Overlap2";d.fMatrix=a.fMatrix2;d.fVolume=a.fVolume2;b.fNodes=JSROOT.create("TList");b.fNodes.Add(c);b.fNodes.Add(d);return b};g.provideVisStyle=function(a){if("TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::REveGeoShapeExtract"===a._typename)return a.fRnrSelf?" geovis_this":"";var b=!g.TestBit(a,g.BITS.kVisNone)&&g.TestBit(a,g.BITS.kVisThis),c=g.TestBit(a,
g.BITS.kVisDaughters);!c||a.fNodes&&0!==a.fNodes.arr.length||(c=!1);return b&&c?" geovis_all":b?" geovis_this":c?" geovis_daughters":""};g.createItem=function(a,b,c){c={_kind:"ROOT."+b._typename,_name:c?c:g.getObjectName(b),_title:b.fTitle,_parent:a,_geoobj:b,_get:function(a){a._geoobj&&(a._geoobj.$geoh=!0);return Promise.resolve(a._geoobj)}};var d=!1;if("TGeoMaterial"==b._typename)c._icon="img_geomaterial";else if("TGeoMedium"==b._typename)c._icon="img_geomedium";else if("TGeoMixture"==b._typename)c._icon=
"img_geomixture";else if(0===b._typename.indexOf("TGeoNode")&&b.fVolume){c._title="node:"+b._typename;0<b.fTitle.length&&(c._title+=" "+b.fTitle);var e=b.fVolume}else if(0===b._typename.indexOf("TGeoVolume"))e=b;else if("TEveGeoShapeExtract"==b._typename||"ROOT::Experimental::REveGeoShapeExtract"==b._typename){d=!0;var f=b.fShape;var m=b.fElements?b.fElements.arr:null}else void 0!==b.fShapeBits&&void 0!==b.fShapeId&&(f=b);e&&(f=e.fShape,m=e.fNodes?e.fNodes.arr:null);if(e||f||m)e&&(c._volume=e),m?
(c._more=!0,c._expand=g.expandObject):f&&"TGeoCompositeShape"===f._typename&&f.fNode&&(c._more=!0,c._shape=f,c._expand=function(a){g.createItem(a,a._shape.fNode.fLeft,"Left");g.createItem(a,a._shape.fNode.fRight,"Right");return!0}),c._title||"TGeoVolume"==b._typename||(c._title=b._typename),f?(""==c._title&&(c._title=f._typename),c._icon=g.getShapeIcon(f)):c._icon=c._more?"img_geocombi":"img_geobbox",e?c._icon+=g.provideVisStyle(e):d&&(c._icon+=g.provideVisStyle(b)),c._menu=g.provideMenu,c._icon_click=
g.browserIconClick;a._childs||(a._childs=[]);c._name||("string"===typeof a._name?(c._name=a._name,c._name.lastIndexOf("s")===c._name.length-1&&(c._name=c._name.substr(0,c._name.length-1)),c._name+="_"+a._childs.length):c._name="item_"+a._childs.length);a._childs.push(c);return c};g.createList=function(a,b,c,d){b&&"arr"in b&&0!=b.arr.length&&(b={_name:c,_kind:"ROOT.TList",_title:d,_more:!0,_geoobj:b,_parent:a,_get:function(a){return Promise.resolve(a._geoobj||null)},_expand:function(a,b){"fVolume"in
b&&(b=b.fVolume.fNodes);if(!("arr"in b))return!1;a._childs=[];g.checkDuplicates(null,b.arr);for(var c in b.arr)g.createItem(a,b.arr[c]);return!0}},a._childs||(a._childs=[]),a._childs.push(b))};g.provideMenu=function(a,b,c){function d(a,b,c){b||(b={visible:0,hidden:0});c||(void 0!==b.assign?a.fRnrSelf=b.assign:a.fRnrSelf?b.vis++:b.hidden++);if(a.fElements)for(c=0;c<a.fElements.arr.length;++c)d(a.fElements.arr[c],b,!1);return b}function e(a){"self"===a?(m.fRnrSelf=!m.fRnrSelf,b._icon=b._icon.split(" ")[0]+
g.provideVisStyle(m),c.updateTreeNode(b)):(d(m,{assign:"true"===a},!0),c.forEachItem(function(a){a._geoobj&&a._icon&&(a._icon=b._icon.split(" ")[0]+g.provideVisStyle(a._geoobj),c.updateTreeNode(a))},b));g.findItemWithPainter(b,"testGeomChanges")}function f(a){g.ToggleBit(p,a);var d=b._icon.split(" ")[0]+g.provideVisStyle(p);c.forEachItem(function(a){b._volume===a._volume&&(a._icon=d,c.updateTreeNode(a))});c.updateTreeNode(b);g.findItemWithPainter(b,"testGeomChanges")}if(!b._geoobj)return!1;var m=
b._geoobj,p=b._volume,q="TEveGeoShapeExtract"===m._typename||"ROOT::Experimental::REveGeoShapeExtract"===m._typename;if(!p&&!q)return!1;a.add("separator");0===b._geoobj._typename.indexOf("TGeoNode")&&g.findItemWithPainter(b)&&a.add("Focus",function(){var a=g.findItemWithPainter(b);if(a){var d=c.itemFullName(b,a);a._painter&&"function"==typeof a._painter.focusOnItem&&a._painter.focusOnItem(d)}});q?(a.addchk(m.fRnrSelf,"Visible","self",e),q=d(m,void 0,!0),0<q.hidden+q.visible&&a.addchk(0==q.hidden,
"Daughters",0!=q.hidden?"true":"false",e)):(a.addchk(g.TestBit(p,g.BITS.kVisNone),"Invisible",g.BITS.kVisNone,f),a.addchk(g.TestBit(p,g.BITS.kVisThis),"Visible",g.BITS.kVisThis,f),a.addchk(g.TestBit(p,g.BITS.kVisDaughters),"Daughters",g.BITS.kVisDaughters,f));return!0};g.findItemWithPainter=function(a,b){for(;a;){if(a._painter&&a._painter._camera){if(b&&"function"==typeof a._painter[b])a._painter[b]();return a}a=a._parent}return null};g.updateBrowserIcons=function(a,b){a&&b&&b.forEachItem(function(c){if(a===
c._volume||a===c._geoobj)c._icon=c._icon.split(" ")[0]+g.provideVisStyle(a),b.updateTreeNode(c)})};g.browserIconClick=function(a,b){if(a._volume)return a._more&&a._volume.fNodes&&0<a._volume.fNodes.arr.length?g.ToggleBit(a._volume,g.BITS.kVisDaughters):g.ToggleBit(a._volume,g.BITS.kVisThis),g.updateBrowserIcons(a._volume,b),g.findItemWithPainter(a,"testGeomChanges"),!1;if(a._geoobj&&("TEveGeoShapeExtract"==a._geoobj._typename||"ROOT::Experimental::REveGeoShapeExtract"==a._geoobj._typename))return a._geoobj.fRnrSelf=
!a._geoobj.fRnrSelf,g.updateBrowserIcons(a._geoobj,b),g.findItemWithPainter(a,"testGeomChanges"),!1;var c=g.findItemWithPainter(a);return c?void 0!==c._painter.extraObjectVisible(b,a,!0)?!0:!1:!1};g.getShapeIcon=function(a){switch(a._typename){case "TGeoArb8":return"img_geoarb8";case "TGeoCone":return"img_geocone";case "TGeoConeSeg":return"img_geoconeseg";case "TGeoCompositeShape":return"img_geocomposite";case "TGeoTubeSeg":return"img_geotubeseg";case "TGeoPara":return"img_geopara";case "TGeoParaboloid":return"img_geoparab";
case "TGeoPcon":return"img_geopcon";case "TGeoPgon":return"img_geopgon";case "TGeoShapeAssembly":return"img_geoassembly";case "TGeoSphere":return"img_geosphere";case "TGeoTorus":return"img_geotorus";case "TGeoTrd1":return"img_geotrd1";case "TGeoTrd2":return"img_geotrd2";case "TGeoXtru":return"img_geoxtru";case "TGeoTrap":return"img_geotrap";case "TGeoGtra":return"img_geogtra";case "TGeoEltu":return"img_geoeltu";case "TGeoHype":return"img_geohype";case "TGeoCtub":return"img_geoctub"}return"img_geotube"};
g.getBrowserIcon=function(a,b){var c="";"ROOT.TEveTrack"==a._kind?c="img_evetrack":"ROOT.TEvePointSet"==a._kind?c="img_evepoints":"ROOT.TPolyMarker3D"==a._kind&&(c="img_evepoints");if(0<c.length){var d=g.findItemWithPainter(a);d&&d._painter.extraObjectVisible(b,a)&&(c+=" geovis_this")}return c};g.expandObject=function(a,b){if(!a||!b)return!1;var c=0===b._typename.indexOf("TGeoNode"),d=0===b._typename.indexOf("TGeoVolume"),e="TGeoManager"===b._typename,f="TEveGeoShapeExtract"===b._typename||"ROOT::Experimental::REveGeoShapeExtract"===
b._typename,m="TGeoOverlap"===b._typename;if(!(c||d||e||f||m))return!1;if(a._childs)return!0;if(e)return g.createList(a,b.fMaterials,"Materials","list of materials"),g.createList(a,b.fMedia,"Media","list of media"),g.createList(a,b.fTracks,"Tracks","list of tracks"),g.createList(a,b.fOverlaps,"Overlaps","list of detected overlaps"),g.createItem(a,b.fMasterVolume),!0;if(m)return g.createItem(a,b.fVolume1),g.createItem(a,b.fVolume2),g.createItem(a,b.fMarker,"Marker"),!0;f?(c=b.fElements?b.fElements.arr:
null,d=b.fShape):(c=(d=c?b.fVolume:b)&&d.fNodes?d.fNodes.arr:null,d=d?d.fShape:null);if(!c&&d&&"TGeoCompositeShape"===d._typename&&d.fNode)return a._childs||(g.createItem(a,d.fNode.fLeft,"Left"),g.createItem(a,d.fNode.fRight,"Right")),!0;if(!c)return!1;g.checkDuplicates(b,c);for(b=0;b<c.length;++b)g.createItem(a,c[b]);return!0};r.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:z,expand:g.expandObject,opt:";more;all;count"});r.addDrawFunc({name:"TEvePointSet",icon_get:g.getBrowserIcon,
icon_click:g.browserIconClick});r.addDrawFunc({name:"TEveTrack",icon_get:g.getBrowserIcon,icon_click:g.browserIconClick});JSROOT.TGeoPainter=e;r.GeoDrawingControl=x;r.drawGeoObject=z;return g});
