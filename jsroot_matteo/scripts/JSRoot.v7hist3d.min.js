var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(q){var b=0;return function(){return b<q.length?{done:!1,value:q[b++]}:{done:!0}}};$jscomp.arrayIterator=function(q){return{next:$jscomp.arrayIteratorImpl(q)}};$jscomp.makeIterator=function(q){var b="undefined"!=typeof Symbol&&Symbol.iterator&&q[Symbol.iterator];return b?b.call(q):$jscomp.arrayIterator(q)};
$jscomp.getGlobal=function(q){return"undefined"!=typeof window&&window===q?q:"undefined"!=typeof global&&null!=global?global:q};$jscomp.global=$jscomp.getGlobal(this);$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(q,b,B){q!=Array.prototype&&q!=Object.prototype&&(q[b]=B.value)};
$jscomp.polyfill=function(q,b,B,Q){if(b){B=$jscomp.global;q=q.split(".");for(Q=0;Q<q.length-1;Q++){var D=q[Q];D in B||(B[D]={});B=B[D]}q=q[q.length-1];Q=B[q];b=b(Q);b!=Q&&null!=b&&$jscomp.defineProperty(B,q,{configurable:!0,writable:!0,value:b})}};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(q){function b(){this.batch_=null}function B(b){return b instanceof D?b:new D(function(a,f){a(b)})}if(q&&!$jscomp.FORCE_POLYFILL_PROMISE)return q;b.prototype.asyncExecute=function(b){if(null==this.batch_){this.batch_=[];var a=this;this.asyncExecuteFunction(function(){a.executeBatch_()})}this.batch_.push(b)};var Q=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(b){Q(b,0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var b=
this.batch_;this.batch_=[];for(var a=0;a<b.length;++a){var f=b[a];b[a]=null;try{f()}catch(c){this.asyncThrow_(c)}}}this.batch_=null};b.prototype.asyncThrow_=function(b){this.asyncExecuteFunction(function(){throw b;})};var D=function(b){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var a=this.createResolveAndReject_();try{b(a.resolve,a.reject)}catch(f){a.reject(f)}};D.prototype.createResolveAndReject_=function(){function b(c){return function(b){f||(f=!0,c.call(a,b))}}var a=this,f=!1;
return{resolve:b(this.resolveTo_),reject:b(this.reject_)}};D.prototype.resolveTo_=function(b){if(b===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(b instanceof D)this.settleSameAsPromise_(b);else{a:switch(typeof b){case "object":var a=null!=b;break a;case "function":a=!0;break a;default:a=!1}a?this.resolveToNonPromiseObj_(b):this.fulfill_(b)}};D.prototype.resolveToNonPromiseObj_=function(b){var a=void 0;try{a=b.then}catch(f){this.reject_(f);return}"function"==typeof a?
this.settleSameAsThenable_(a,b):this.fulfill_(b)};D.prototype.reject_=function(b){this.settle_(2,b)};D.prototype.fulfill_=function(b){this.settle_(1,b)};D.prototype.settle_=function(b,a){if(0!=this.state_)throw Error("Cannot settle("+b+", "+a+"): Promise already settled in state"+this.state_);this.state_=b;this.result_=a;this.executeOnSettledCallbacks_()};D.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var b=0;b<this.onSettledCallbacks_.length;++b)ja.asyncExecute(this.onSettledCallbacks_[b]);
this.onSettledCallbacks_=null}};var ja=new b;D.prototype.settleSameAsPromise_=function(b){var a=this.createResolveAndReject_();b.callWhenSettled_(a.resolve,a.reject)};D.prototype.settleSameAsThenable_=function(b,a){var f=this.createResolveAndReject_();try{b.call(a,f.resolve,f.reject)}catch(c){f.reject(c)}};D.prototype.then=function(b,a){function f(a,b){return"function"==typeof a?function(b){try{c(a(b))}catch(C){h(C)}}:b}var c,h,u=new D(function(a,b){c=a;h=b});this.callWhenSettled_(f(b,c),f(a,h));
return u};D.prototype.catch=function(b){return this.then(void 0,b)};D.prototype.callWhenSettled_=function(b,a){function f(){switch(c.state_){case 1:b(c.result_);break;case 2:a(c.result_);break;default:throw Error("Unexpected state: "+c.state_);}}var c=this;null==this.onSettledCallbacks_?ja.asyncExecute(f):this.onSettledCallbacks_.push(f)};D.resolve=B;D.reject=function(b){return new D(function(a,f){f(b)})};D.race=function(b){return new D(function(a,f){for(var c=$jscomp.makeIterator(b),h=c.next();!h.done;h=
c.next())B(h.value).callWhenSettled_(a,f)})};D.all=function(b){var a=$jscomp.makeIterator(b),f=a.next();return f.done?B([]):new D(function(b,h){function c(a){return function(f){r[a]=f;t--;0==t&&b(r)}}var r=[],t=0;do r.push(void 0),t++,B(f.value).callWhenSettled_(c(r.length-1),h),f=a.next();while(!f.done)})};return D},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.SymbolClass=function(q,b){this.$jscomp$symbol$id_=q;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function q(B){if(this instanceof q)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(B||"")+"_"+b++,B)}var b=0;return q}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var q=$jscomp.global.Symbol.iterator;q||(q=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[q]&&$jscomp.defineProperty(Array.prototype,q,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var q=$jscomp.global.Symbol.asyncIterator;q||(q=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(q){$jscomp.initSymbolIterator();q={next:q};q[$jscomp.global.Symbol.iterator]=function(){return this};return q};
$jscomp.iteratorFromArray=function(q,b){$jscomp.initSymbolIterator();q instanceof String&&(q+="");var B=0,Q={next:function(){if(B<q.length){var D=B++;return{value:b(D,q[D]),done:!1}}Q.next=function(){return{done:!0,value:void 0}};return Q.next()}};Q[Symbol.iterator]=function(){return Q};return Q};$jscomp.polyfill("Array.prototype.entries",function(q){return q?q:function(){return $jscomp.iteratorFromArray(this,function(b,B){return[b,B]})}},"es6","es3");
JSROOT.define(["d3","base3d","painter","v7hist"],function(q,b,B){function Q(a,b,c,h){function f(a,b){a<=k&&(a+=4);return a>k&&a<k+b}if(b&&b.children)for(var r=0;r<b.children.length;++r){var t=b.children[r];if(t.axis_draw)break;t=void 0}if(t)if(a){c=c?!0:!1;h=h?!0:!1;var k=1;a=a.position;0>a.x&&0<=a.y&&(k=2);0<=a.x&&0<=a.y&&(k=3);0<=a.x&&0>a.y&&(k=4);for(a=0;a<t.children.length;++a)if(b=t.children[a],b.grid)b.visible=h&&f(b.grid,3);else if(b.zid)b.visible=f(b.zid,2);else if(b.xyid)b.visible=f(b.xyid,
3);else if(b.xyboxid){r=5;var C=0;h&&!c?(r=3,C=-2):c&&!h?r=3:c||h||(r=b.bottom?3:0);b.visible=f(b.xyboxid+C,r);!b.visible&&b.bottom&&h&&(b.visible=f(b.xyboxid,3))}else b.zboxid&&(r=2,C=0,c&&h?r=5:h&&!c?r=4:!h&&c&&(C=-2,r=4),b.visible=f(b.zboxid+C,r))}else b.remove(t)}function D(a){var b=Math.max(.75*a.size_xy3d,a.size_z3d);a.camera.position.set(-1.6*b,-3.5*b,1.4*a.size_z3d);a.camera.lookAt(a.lookat)}function ja(a,f){if(!a)return null;f||(f="line_");var c=a.v7EvalColor(f+"color","black"),h=a.v7EvalAttr(f+
"style",0);a=a.v7EvalAttr(f+"width",1);c=(h=(h=h?B.root_line_styles[parseInt(h)]:"")?h.split(","):[])&&2<=h.length?new b.LineDashedMaterial({color:c,dashSize:parseInt(h[0]),gapSize:parseInt(h[1])}):new b.LineBasicMaterial({color:c});void 0!==a&&1<a&&(c.linewidth=parseInt(a));return c}function R(a,b){JSROOT.v7.RHistPainter.call(this,a,b);this.mode3d=!0}JSROOT.v7.RFramePainter.prototype.create3DScene=function(a){if(-1===a)this.mode3d&&(this.clear3dCanvas?(Q(null,this.toplevel),this.clear3dCanvas(),
B.disposeThreejsObject(this.scene),this.control&&this.control.cleanup(),this.renderer&&(this.renderer.dispose&&this.renderer.dispose(),this.renderer.forceContextLoss&&this.renderer.forceContextLoss()),delete this.size_xy3d,delete this.size_z3d,delete this.tooltip_mesh,delete this.scene,delete this.toplevel,delete this.camera,delete this.pointLight,delete this.renderer,delete this.control,this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.mode3d=!1):console.error("Strange, why mode3d is configured!!!!",
this.mode3d));else if(this.mode3d=!0,"toplevel"in this)this.scene.remove(this.toplevel),B.disposeThreejsObject(this.toplevel),delete this.tooltip_mesh,delete this.toplevel,this.control&&this.control.HideTooltip(),a=new b.Object3D,this.scene.add(a),this.toplevel=a,this.resize3D();else{B.assign3DHandler(this);a=B.getRender3DKind(a);var f=this.getSizeFor3d(void 0,a);this.size_z3d=100;this.size_xy3d=10<f.height&&10<f.width?Math.round(f.width/f.height*this.size_z3d):this.size_z3d;this.scene=new b.Scene;
this.toplevel=new b.Object3D;this.scene.add(this.toplevel);this.scene_width=f.width;this.scene_height=f.height;this.camera=new b.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size_z3d);this.camera_Theta=this.camera_Phi=30;this.pointLight=new b.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size_xy3d/2,this.size_xy3d/2,this.size_z3d/2);this.lookat=new b.Vector3(0,0,.8*this.size_z3d);this.camera.up=new b.Vector3(0,0,1);this.scene.add(this.camera);
D(this);this.renderer=B.createRender3D(this.scene_width,this.scene_height,a);this.webgl=a===JSROOT.constants.Render3D.WebGL;this.add3dCanvas(f,this.renderer.jsroot_dom,this.webgl);this.first_render_tm=0;this.enable_highlight=!1;if(!JSROOT.batch_mode&&this.webgl){this.control=B.createOrbitControl(this,this.camera,this.scene,this.renderer,this.lookat);var c=this,h=this.getMainPainter();this.control.ProcessMouseMove=function(a){for(var b=null,f=null,k=null,h=0;h<a.length;++h)if(a[h].object.tooltip){if(b=
a[h].object.tooltip(a[h])){f=a[h].object;break}}else a[h].object.zoom&&!k&&(k=a[h].object);b&&!b.use_itself&&(a=1E-4*c.size_xy3d,h=1E-4*c.size_z3d,(b.x1>b.x2||b.y1>b.y2||b.z1>b.z2)&&console.warn("check 3D hints coordinates"),b.x1-=a,b.x2+=a,b.y1-=a,b.y2+=a,b.z1-=h,b.z2+=h);c.highlightBin3D(b,f);return!b&&k&&c.Get3DZoomCoord?(f=k.GlobalIntersect(this.raycaster),b=k.zoom,f=c.Get3DZoomCoord(f,b),"z"===b&&k.use_y_for_z&&(b="y"),k={name:b,title:"RAxis",line:"any info",only_status:!0},k.line=b+" : "+c.axisAsText(b,
f),k):b&&b.lines?b:""};this.control.ProcessMouseLeave=function(){c.highlightBin3D(null)};this.control.contextMenu=function(a,b){var c="painter",f=h;if(b)for(var r=0;r<b.length;++r){var n=b[r].object;if(n.zoom){c=n.zoom;f=null;break}if(n.painter&&"function"===typeof n.painter.fillContextMenu){f=n.painter;break}}(b=h.getFramePainter())&&b.showContextMenu&&b.showContextMenu(c,a,f)}}}};JSROOT.v7.RFramePainter.prototype.render3D=function(a){var f=this;if(-1111===a){var c=JSROOT._.get_document();a=b.CreateSVGRenderer(!1,
0,c);a.setSize(this.scene_width,this.scene_height);a.render(this.scene,this.camera);return a.makeOuterHTML?(c=c.createElement("div"),c.innerHTML=a.makeOuterHTML(),c.childNodes[0]):a.domElement}void 0===a&&(a=5);0<a&&this.webgl&&JSROOT.batch_mode?this.render_tmout||(this.render_tmout=setTimeout(function(){return f.render3D(0)},a)):(this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.renderer&&(B.beforeRender3D(this.renderer),a=new Date,this.opt3d||(this.opt3d={FrontBox:!0,
BackBox:!0}),Q(this.camera,this.toplevel,this.opt3d.FrontBox,this.opt3d.BackBox),this.renderer.render(this.scene,this.camera),B.afterRender3D(this.renderer),c=new Date,0===this.first_render_tm&&(this.first_render_tm=c.getTime()-a.getTime(),this.enable_highlight=1200>this.first_render_tm&&this.isTooltipAllowed(),console.log("three.js r"+b.REVISION+", first render tm = "+this.first_render_tm))))};JSROOT.v7.RFramePainter.prototype.resize3D=function(){var a=this.getSizeFor3d(this.access3dKind());this.apply3dSize(a);
if(this.scene_width===a.width&&this.scene_height===a.height||10>a.width||10>a.height)return!1;this.scene_width=a.width;this.scene_height=a.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);this.renderer.setJSROOTSize&&this.renderer.setJSROOTSize(this.scene_width,this.scene_height);return!0};JSROOT.v7.RFramePainter.prototype.highlightBin3D=function(a,f){var c=!1,h=null,u=!0,r=!a||void 0===a.x1||
!this.enable_highlight,t=this.getMainPainter();!t||t.provideUserTooltip&&t.hasUserTooltip()||(t=null);this.tooltip_selfmesh&&(u=this.tooltip_selfmesh!==f,this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color,delete this.tooltip_selfmesh,c=!0);this.tooltip_mesh&&(h=this.tooltip_mesh,this.toplevel.remove(this.tooltip_mesh),delete this.tooltip_mesh,c=!0);if(r)c&&this.render3D(),c&&t&&t.provideUserTooltip(null);else{if(a.use_itself)f.save_color=f.material.color,f.material.color=new b.Color(a.color),
this.tooltip_selfmesh=f,c=u;else{c=!0;f=B.Box3D.Indexes;u=B.Box3D.Normals;r=B.Box3D.Vertices;var k=new b.Color(a.color?a.color:16711680),C=a.opacity||1;if(h){var n=h.geometry.attributes.position.array;h.geometry.attributes.position.needsUpdate=!0;h.material.color=k;h.material.opacity=C}else{n=new Float32Array(3*f.length);var g=new Float32Array(3*f.length);h=new b.BufferGeometry;h.setAttribute("position",new b.BufferAttribute(n,3));h.setAttribute("normal",new b.BufferAttribute(g,3));k=new b.MeshBasicMaterial({color:k,
opacity:C,flatShading:!0});h=new b.Mesh(h,k)}a.x1===a.x2&&console.warn("same tip X",a.x1,a.x2);a.y1===a.y2&&console.warn("same tip Y",a.y1,a.y2);a.z1===a.z2&&(a.z2=a.z1+1E-4);k=0;for(C=-3;k<f.length;++k){var w=r[f[k]];n[3*k]=a.x1+w.x*(a.x2-a.x1);n[3*k+1]=a.y1+w.y*(a.y2-a.y1);n[3*k+2]=a.z1+w.z*(a.z2-a.z1);g&&(0===k%6&&(C+=3),g[3*k]=u[C],g[3*k+1]=u[C+1],g[3*k+2]=u[C+2])}this.tooltip_mesh=h;this.toplevel.add(h)}c&&this.render3D();c&&a.$painter&&"function"==typeof a.$painter.redrawProjection&&a.$painter.redrawProjection(a.ix-
1,a.ix,a.iy-1,a.iy);c&&t&&t.getObject()&&t.provideUserTooltip({obj:t.getObject(),name:t.getObject().fName,bin:a.bin,cont:a.value,binx:a.ix,biny:a.iy,binz:a.iz,grx:(a.x1+a.x2)/2,gry:(a.y1+a.y2)/2,grz:(a.z1+a.z2)/2})}};JSROOT.v7.RFramePainter.prototype.set3DOptions=function(a){this.opt3d=a};JSROOT.v7.RFramePainter.prototype.drawXYZ=function(a,f){function c(a,c,f){var d=new b.Geometry;"z"===a?d.vertices.push(new b.Vector3(0,0,0),new b.Vector3(4*A,0,0),new b.Vector3(4*A,0,2*c),new b.Vector3(0,0,2*c)):
d.vertices.push(new b.Vector3(-c,0,0),new b.Vector3(c,0,0),new b.Vector3(c,4*-A,0),new b.Vector3(-c,4*-A,0));d.faces.push(new b.Face3(0,2,1));d.faces.push(new b.Face3(0,3,2));d.computeFaceNormals();var e=new b.MeshBasicMaterial({transparent:!0,vertexColors:b.NoColors,side:b.DoubleSide,opacity:0});d=new b.Mesh(d,e);d.zoom=a;d.size_3d=c;d.use_y_for_z=f;"y"==a&&d.rotateZ(Math.PI/2).rotateX(Math.PI);d.GlobalIntersect=function(a){var c=new b.Plane,d=this.geometry;if(d&&d.vertices&&(c.setFromCoplanarPoints(d.vertices[0],
d.vertices[1],d.vertices[2]),c.applyMatrix4(this.matrixWorld),d=a.ray.origin.clone(),a=d.clone().addScaledVector(a.ray.direction,1E10),c=c.intersectLine(new b.Line3(d,a),new b.Vector3)))return a=-this.size_3d,d=this.size_3d,"z"===this.zoom&&(a=0,d=2*this.size_3d),c[this.zoom]<a?c[this.zoom]=a:c[this.zoom]>d&&(c[this.zoom]=d),c};d.ShowSelection=function(a,c){var d=this.children?this.children[0]:null,f=this.zoom;if(!a||!c)return d&&(this.remove(d),B.disposeThreejsObject(d)),d;if(d)var e=d.geometry;
else e=this.geometry.clone(),"z"===f?e.vertices[1].x=e.vertices[2].x=A:e.vertices[2].y=e.vertices[3].y=-A,d=new b.Mesh(e,new b.MeshBasicMaterial({color:65280,side:b.DoubleSide})),this.add(d);"z"==f?(e.vertices[0].z=e.vertices[1].z=a[f],e.vertices[2].z=e.vertices[3].z=c[f]):(e.vertices[0].x=e.vertices[3].x=a[f],e.vertices[1].x=e.vertices[2].x=c[f]);e.computeFaceNormals();e.verticesNeedUpdate=!0;return e.normalsNeedUpdate=!0};return d}f||(f={});var h=-this.size_xy3d,u=this.size_xy3d,r=-this.size_xy3d,
t=this.size_xy3d,k=0,C=2*this.size_z3d,n=Math.round(.05*this.size_z3d),g=this.xmin,w=this.xmax,v=this.ymin,d=this.ymax,N=this.zmin,m=this.zmax,p=!1,e=!1;this.size_z3d||(h=this.xmin,u=this.xmax,r=this.ymin,t=this.ymax,k=this.zmin,C=this.zmax,n=.05*(C-k));"zoom_xmin"in this&&"zoom_xmax"in this&&this.zoom_xmin!==this.zoom_xmax&&(g=this.zoom_xmin,w=this.zoom_xmax);"zoom_ymin"in this&&"zoom_ymax"in this&&this.zoom_ymin!==this.zoom_ymax&&(v=this.zoom_ymin,d=this.zoom_ymax,p=!0);"zoom_zmin"in this&&"zoom_zmax"in
this&&this.zoom_zmin!==this.zoom_zmax&&(N=this.zoom_zmin,m=this.zoom_zmax,e=!0);f.use_y_for_z&&(this.zmin=this.ymin,this.zmax=this.ymax,N=v,m=d,e=p,v=0,d=1);this.lego_zmin=N;this.lego_zmax=m;void 0===f.zmult||e||(m*=f.zmult);this.x_handle=new JSROOT.v7.RAxisPainter(this.getDom(),this,this.xaxis,"x_");this.x_handle.setPadName(this.getPadName());this.x_handle.snapid=this.snapid;this.x_handle.configureAxis("xaxis",this.xmin,this.xmax,g,w,!1,[h,u]);this.x_handle.assignFrameMembers(this,"x");this.y_handle=
new JSROOT.v7.RAxisPainter(this.getDom(),this,this.yaxis,"y_");this.y_handle.setPadName(this.getPadName());this.y_handle.snapid=this.snapid;this.y_handle.configureAxis("yaxis",this.ymin,this.ymax,v,d,!1,[r,t]);this.y_handle.assignFrameMembers(this,"y");this.z_handle=new JSROOT.v7.RAxisPainter(this.getDom(),this,this.zaxis,"z_");this.z_handle.setPadName(this.getPadName());this.z_handle.snapid=this.snapid;this.z_handle.configureAxis("zaxis",this.zmin,this.zmax,N,m,!1,[k,C]);this.z_handle.assignFrameMembers(this,
"z");var l=new b.MeshBasicMaterial({color:0});g=new b.LineBasicMaterial({color:0});var A=.5*n;v=[];var x=1;m=this.x_handle.createTicks(!1,!0);N=this.y_handle.createTicks(!1,!0);d=this.z_handle.createTicks(!1,!0);w=new b.Object3D;w.axis_draw=!0;a.add(w);a=[];var z=0;for(p=this.xaxis;m.next();){e=m.grpos;var y=1===m.kind,E=this.x_handle.format(m.tick,2);m.last_major()?p&&p.fTitle||(E="x"):null===E&&(y=!1,E="");if(y&&E&&0<E.length){E=new b.TextGeometry(E,{font:JSROOT.threejs_font_helvetiker_regular,
size:n,height:0,curveSegments:5});E.computeBoundingBox();var q=E.boundingBox.max.x-E.boundingBox.min.x,L=E.boundingBox.max.y-E.boundingBox.min.y;E.center=!0;z=Math.max(z,L);E.grx=e;v.push(E);m.last_major()||(L=m.next_major_grpos()-e,0<q&&(x=Math.min(x,.9*L/q)),this.x_handle.isCenteredLabels()&&(E.grx+=L/2))}a.push(e,0,0,e,y?-A:.6*-A,0)}p&&p.fTitle&&(m=new b.TextGeometry(p.fTitle,{font:JSROOT.threejs_font_helvetiker_regular,size:n,height:0,curveSegments:5}),m.computeBoundingBox(),m.center=!1,m.gry=
2,m.grx=(h+u)/2,v.push(m));this.Get3DZoomCoord=function(a,b){a=a[b];var c=this["scale_"+b+"min"],d=this["scale_"+b+"max"];a="z"===b?a/2/this.size_z3d:(a+this.size_xy3d)/2/this.size_xy3d;return a=this["log"+b]?Math.exp(Math.log(c)+a*(Math.log(d)-Math.log(c))):c+a*(d-c)};var I=new b.Object3D;I.position.set(0,r,k);I.rotation.x=.25*Math.PI;I.xyid=2;a=B.createLineSegments(a,g);I.add(a);v.forEach(function(a){var c=a.boundingBox.max.x-a.boundingBox.min.x,d=a.center?a.grx-c/2:u-c;c=new b.Matrix4;c.set(x,
0,0,d,0,x,0,(-z*x-1.5*A)*(a.gry||1),0,0,1,0,0,0,0,1);a=new b.Mesh(a,l);a.applyMatrix4(c);I.add(a)});f.zoom&&I.add(c("x",this.size_xy3d));w.add(I);I=new b.Object3D;I.position.set(0,t,k);I.rotation.x=.75*Math.PI;I.add(new b.LineSegments(a.geometry,g));v.forEach(function(a){var c=a.boundingBox.max.x-a.boundingBox.min.x,d=a.center?a.grx+c/2:u;c=new b.Matrix4;c.set(-x,0,0,d,0,x,0,(-z*x-1.5*A)*(a.gry||1),0,0,-1,0,0,0,0,1);a=new b.Mesh(a,l);a.applyMatrix4(c);I.add(a)});I.xyid=4;f.zoom&&I.add(c("x",this.size_xy3d));
w.add(I);v=[];x=1;z=0;a=[];for(m=this.yaxis;N.next();)p=N.grpos,e=1===N.kind,y=this.y_handle.format(N.tick,2),N.last_major()?m&&m.fTitle||(y="y"):null===y&&(e=!1,y=""),e&&(y=new b.TextGeometry(y,{font:JSROOT.threejs_font_helvetiker_regular,size:n,height:0,curveSegments:5}),y.computeBoundingBox(),E=y.boundingBox.max.x-y.boundingBox.min.x,q=y.boundingBox.max.y-y.boundingBox.min.y,y.center=!0,z=Math.max(z,q),y.gry=p,v.push(y),N.last_major()||(q=N.next_major_grpos()-p,0<E&&(x=Math.min(x,.9*q/E)),this.y_handle.isCenteredLabels()&&
(y.gry+=q/2))),a.push(0,p,0,e?-A:.6*-A,p,0);m&&m.fTitle&&(N=new b.TextGeometry(m.fTitle,{font:JSROOT.threejs_font_helvetiker_regular,size:n,height:0,curveSegments:5}),N.computeBoundingBox(),N.center=!1,N.grx=2,N.gry=(r+t)/2,v.push(N));if(!f.use_y_for_z){a=B.createLineSegments(a,g);var O=new b.Object3D;O.position.set(h,0,k);O.rotation.y=-.25*Math.PI;O.add(a);v.forEach(function(a){var c=a.boundingBox.max.x-a.boundingBox.min.x,d=a.center?a.gry+c/2:t;c=new b.Matrix4;c.set(0,x,0,(-z*x-1.5*A)*(a.grx||1),
-x,0,0,d,0,0,1,0,0,0,0,1);a=new b.Mesh(a,l);a.applyMatrix4(c);O.add(a)});O.xyid=3;f.zoom&&O.add(c("y",this.size_xy3d));w.add(O);O=new b.Object3D;O.position.set(u,0,k);O.rotation.y=-.75*Math.PI;O.add(new b.LineSegments(a.geometry,g));v.forEach(function(a){var c=a.boundingBox.max.x-a.boundingBox.min.x,d=a.center?a.gry-c/2:t-c;c=new b.Matrix4;c.set(0,x,0,(-z*x-1.5*A)*(a.grx||1),x,0,0,d,0,0,-1,0,0,0,0,1);a=new b.Mesh(a,l);a.applyMatrix4(c);O.add(a)});O.xyid=1;f.zoom&&O.add(c("y",this.size_xy3d));w.add(O)}v=
[];x=1;a=[];y=p=e=null;N=this.zaxis;m=0;this.size_z3d&&(e=[],p=[]);for(;d.next();){E=d.grpos;q=1==d.kind;L=this.z_handle.format(d.tick,2);null===L&&(q=!1,L="");if(q&&L){L=new b.TextGeometry(L,{font:JSROOT.threejs_font_helvetiker_regular,size:n,height:0,curveSegments:5});L.computeBoundingBox();var Z=L.boundingBox.max.x-L.boundingBox.min.x,M=L.boundingBox.max.y-L.boundingBox.min.y;L.translate(-Z,-M/2,0);L.grz=E;v.push(L);null!==y&&0<M&&(x=Math.min(x,.9*(E-y)/M));m=Math.max(m,Z);y=E}e&&q&&e.push(h,0,
E,u,0,E);p&&q&&p.push(0,r,E,0,t,E);a.push(0,0,E,q?A:.6*A,0,E)}e&&0<e.length&&(d=new b.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),e=B.createLineSegments(e,d),e.position.set(0,t,0),e.grid=2,e.visible=!1,w.add(e),d=new b.LineSegments(e.geometry,d),d.position.set(0,r,0),d.grid=4,d.visible=!1,w.add(d));p&&0<p.length&&(d=new b.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),p=B.createLineSegments(p,d),p.position.set(u,0,0),p.grid=3,p.visible=!1,w.add(p),d=new b.LineSegments(p.geometry,d),d.position.set(h,
0,0),d.grid=1,d.visible=!1,w.add(d));var K=[];a=B.createLineSegments(a,g);for(d={$jscomp$loop$prop$n$61:0};4>d.$jscomp$loop$prop$n$61;d={$jscomp$loop$prop$n$61:d.$jscomp$loop$prop$n$61},++d.$jscomp$loop$prop$n$61)K.push(new b.Object3D),v.forEach(function(a){return function(c){var d=new b.Matrix4;d.set(-x,0,0,2*A,0,0,1,0,0,x,0,c.grz);c=new b.Mesh(c,l);c.applyMatrix4(d);K[a.$jscomp$loop$prop$n$61].add(c)}}(d)),N&&N.fTitle&&(e=new b.TextGeometry(N.fTitle,{font:JSROOT.threejs_font_helvetiker_regular,
size:n,height:0,curveSegments:5}),e.computeBoundingBox(),y=C-(e.boundingBox.max.x-e.boundingBox.min.x),e.rotateZ(Math.PI/2),p=new b.Matrix4,p.set(-x,0,0,3*A+m,0,0,1,0,0,x,0,y),e=new b.Mesh(e,l),e.applyMatrix4(p),K[d.$jscomp$loop$prop$n$61].add(e)),K[d.$jscomp$loop$prop$n$61].add(0==d.$jscomp$loop$prop$n$61?a:new b.LineSegments(a.geometry,g)),f.zoom&&K[d.$jscomp$loop$prop$n$61].add(c("z",this.size_z3d,f.use_y_for_z)),K[d.$jscomp$loop$prop$n$61].zid=d.$jscomp$loop$prop$n$61+2,w.add(K[d.$jscomp$loop$prop$n$61]);
K[0].position.set(h,t,0);K[0].rotation.z=.75*Math.PI;K[1].position.set(u,t,0);K[1].rotation.z=.25*Math.PI;K[2].position.set(u,r,0);K[2].rotation.z=-.25*Math.PI;K[3].position.set(h,r,0);K[3].rotation.z=-.75*Math.PI;if(0!==this.size_z3d){f=B.createLineSegments([h,0,0,u,0,0],g,null,!0);for(n=0;2>n;++n)v=new b.LineSegments(f,g),v.position.set(0,r,0===n?k:C),v.xyboxid=2,v.bottom=0==n,w.add(v),v=new b.LineSegments(f,g),v.position.set(0,t,0===n?k:C),v.xyboxid=4,v.bottom=0==n,w.add(v);r=B.createLineSegments([0,
r,0,0,t,0],g,null,!0);for(f=0;2>f;++f)n=new b.LineSegments(r,g),n.position.set(h,0,0===f?k:C),n.xyboxid=3,n.bottom=0==f,w.add(n),n=new b.LineSegments(r,g),n.position.set(u,0,0===f?k:C),n.xyboxid=1,n.bottom=0==f,w.add(n);h=B.createLineSegments([0,0,k,0,0,C],g,null,!0);for(k=0;4>k;++k)C=new b.LineSegments(h,g),C.zboxid=K[k].zid,C.position.copy(K[k].position),w.add(C)}};JSROOT.v7.RHistPainter.prototype.drawLego=function(){var a=this;if(this.draw_content){var f=B.Box3D.Vertices,c=B.Box3D.Indexes,h=B.Box3D.Normals,
u=B.Box3D.Segments,r=[0,1,1,2,2,3,3,0],t=[new b.Vector3(0,0,0),new b.Vector3(0,1,0),new b.Vector3(1,1,0),new b.Vector3(1,0,0)],k=this.getFramePainter(),C=k.z_handle.gr.domain()[0],n=k.z_handle.gr.domain()[1],g=this.prepareDraw({rounding:!1,use3d:!0,extra:1}),w=g.i1,v=g.i2,d=g.j1,N=g.j2,m=g.stepi,p=g.stepj,e,l,A,x,z,y,E,D=this.getHisto(),L=D?D.$baseh:null,I=11===this.options.Lego||13===this.options.Lego;if(!(w>=v||d>=N)){var O=function(b,c,d){y=D.getBinContent(b+1,c+1);z=L?L.getBinContent(b+1,c+1):
!1!==a.options.BaseLine?a.options.BaseLine:a.options.Zero?C:0;y<z&&(b=z,z=y,y=b);if(z>=J||y<T)return!1;E=y===T||z>=y;return!E||0<d?!0:D.$baseh?!1:a.options.Zero||0<C?!0:a._show_empty_bins},Z=65535>D.getBin(v,N),M=[C,n],K=null;if(12===this.options.Lego||14===this.options.Lego)K=k.getHistPalette(),this.createContour(k,K,{full_z_range:!0}),M=K.getContour(),C=M[0],n=M[M.length-1];for(var G=0;G<M.length-1;++G){var T=M[G];var J=M[G+1];K&&G==M.length-2&&J<n&&(J=n);var H=0,F=0,P=x=0,Q=k.grz(T),R=k.grz(J);
for(e=w;e<v;e+=m)for(l=d;l<N;l+=p)if(O(e,l,G)){var W=!E&&0<G;var da=!E&&y>J&&G<M.length-2;x+=E?12:c.length;W&&(x-=6);da&&(x-=6);I&&!E&&(x-=12,P+=12)}var ba=new Float32Array(3*x),ea=new Float32Array(3*x),X=Z?new Uint16Array(x/3):new Uint32Array(x/3),U=A=null,S=null,Y=0,V=0,aa=W=void 0,fa=void 0;0<P&&(A=new Float32Array(3*P),U=new Float32Array(3*P),S=Z?new Uint16Array(P/3):new Uint32Array(P/3));for(e=w;e<v;e+=m){x=g.grx[e]+g.xbar1*(g.grx[e+m]-g.grx[e]);var ca=g.grx[e]+g.xbar2*(g.grx[e+m]-g.grx[e]);
for(l=d;l<N;l+=p)if(O(e,l,G)){W=!E&&0<G;da=!E&&y>J&&G<M.length-2;var ia=g.gry[l]+g.ybar1*(g.gry[l+p]-g.gry[l]);var ka=g.gry[l]+g.ybar2*(g.gry[l+p]-g.gry[l]);H=z<=T?Q:k.grz(z);F=y>J?R:k.grz(y);aa=fa=0;E&&(fa+=12,aa+=24);var la=c.length,ma=D.getBin(e+1,l+1);for(W&&(la-=6);aa<la;)W=f[c[aa]],I&&12>aa?(A[V]=x+W.x*(ca-x),A[V+1]=ia+W.y*(ka-ia),A[V+2]=H+W.z*(F-H),U[V]=h[fa],U[V+1]=h[fa+1],U[V+2]=h[fa+2],0===V%9&&(S[V/9]=ma),V+=3):(ba[Y]=x+W.x*(ca-x),ba[Y+1]=ia+W.y*(ka-ia),ba[Y+2]=H+W.z*(F-H),ea[Y]=h[fa],
ea[Y+1]=h[fa+1],ea[Y+2]=h[fa+2],0===Y%9&&(X[Y/9]=ma),Y+=3),++aa,0===aa%6&&(fa+=3,da&&aa===c.length-12&&(aa+=6,fa+=3))}}e=new b.BufferGeometry;e.setAttribute("position",new b.BufferAttribute(ba,3));e.setAttribute("normal",new b.BufferAttribute(ea,3));l=3;x=this.getColor(l);if(K)x=K.getColor(G);else if(1===this.options.Lego||2>l)l=1,x="white";ca=new b.MeshBasicMaterial({color:x,flatShading:!0});e=new b.Mesh(e,ca);e.face_to_bins_index=X;e.painter=this;e.zmin=C;e.zmax=n;e.baseline=!1!==this.options.BaseLine?
this.options.BaseLine:this.options.Zero?C:0;e.tip_color=3===l?16711680:65280;e.handle=g;e.tooltip=function(a){if(isNaN(a.faceIndex))return console.error("faceIndex not provided, check three.js version",b.REVISION,"expected r102"),null;if(0>a.faceIndex||a.faceIndex>=this.face_to_bins_index.length)return null;var c=this.painter,d=this.handle,f=c.getFramePainter(),e=c.getHisto();a=c.get3DToolTip(this.face_to_bins_index[a.faceIndex]);var h=a.ix-1,k=h+d.stepi,g=a.iy-1,l=g+d.stepj;a.x1=Math.max(-f.size_xy3d,
d.grx[h]+d.xbar1*(d.grx[k]-d.grx[h]));a.x2=Math.min(f.size_xy3d,d.grx[h]+d.xbar2*(d.grx[k]-d.grx[h]));a.y1=Math.max(-f.size_xy3d,d.gry[g]+d.ybar1*(d.gry[l]-d.gry[g]));a.y2=Math.min(f.size_xy3d,d.gry[g]+d.ybar2*(d.gry[l]-d.gry[g]));d=this.baseline;k=a.value;e.$baseh&&(d=e.$baseh.getBinContent(h+1,g+1));k<d&&(e=d,d=k,k=e);a.z1=f.grz(Math.max(this.zmin,d));a.z2=f.grz(Math.min(this.zmax,k));a.color=this.tip_color;c.is_projection&&2==c.getDimension()&&(a.$painter=c);return a};k.toplevel.add(e);0<P&&(ca=
new b.BufferGeometry,ca.setAttribute("position",new b.BufferAttribute(A,3)),ca.setAttribute("normal",new b.BufferAttribute(U,3)),l=2>l?new b.Color(16711680):new b.Color(q.rgb(x).darker(.5).toString()),l=new b.MeshBasicMaterial({color:l,flatShading:!0}),l=new b.Mesh(ca,l),l.face_to_bins_index=S,l.painter=this,l.handle=e.handle,l.tooltip=e.tooltip,l.zmin=e.zmin,l.zmax=e.zmax,l.baseline=e.baseline,l.tip_color=e.tip_color,k.toplevel.add(l))}if(!(12<this.options.Lego)){x=ca=0;c=!0;J=n;T=C;for(e=w;e<v;e+=
m)for(l=d;l<N;l+=p)O(e,l,0)&&(ca+=E?t.length:f.length,x+=E?r.length:u.length);65520<ca&&(c=!1);c||(ca=3*x);h=new Float32Array(3*ca);I=c?new Uint16Array(x):null;Z=k.grz(C);M=k.grz(n);P=S=G=K=0;for(e=w;e<v;e+=m)for(x=g.grx[e]+g.xbar1*(g.grx[e+m]-g.grx[e]),ca=g.grx[e]+g.xbar2*(g.grx[e+m]-g.grx[e]),l=d;l<N;l+=p)if(O(e,l,0))if(ia=g.gry[l]+g.ybar1*(g.gry[l+p]-g.gry[l]),ka=g.gry[l]+g.ybar2*(g.gry[l+p]-g.gry[l]),K=z<=C?Z:k.grz(z),G=y>n?M:k.grz(y),U=E?r:u,X=E?t:f,c){for(w=0;w<U.length;++w)I[P++]=S/3+U[w];
for(w=0;w<X.length;++w)A=X[w],h[S]=x+A.x*(ca-x),h[S+1]=ia+A.y*(ka-ia),h[S+2]=K+A.z*(G-K),S+=3}else for(w=0;w<U.length;++w)A=X[U[w]],h[S]=x+A.x*(ca-x),h[S+1]=ia+A.y*(ka-ia),h[S+2]=K+A.z*(G-K),S+=3;f=this.v7EvalColor("line_color","lightblue");f=new b.LineBasicMaterial({color:new b.Color(f),linewidth:this.v7EvalAttr("line_width",1)});f=B.createLineSegments(h,f,c?I:null);k.toplevel.add(f)}}}};JSROOT.v7.RH1Painter.prototype.draw3D=function(a){var b=this;this.mode3d=!0;var c=this.getFramePainter(),h=this.isMainPainter();
if("resize"==a)return h&&c.resize3D()&&c.render3D(),Promise.resolve(this);this.deleteAttr();this.scanContent(!0);h&&(c.create3DScene(this.options.Render3D),c.setAxesRanges(this.getAxis("x"),this.xmin,this.xmax,null,this.ymin,this.ymax,null,0,0),c.set3DOptions(this.options),c.drawXYZ(c.toplevel,{use_y_for_z:!0,zmult:1.1,zoom:JSROOT.settings.Zooming,ndim:1}));return c.mode3d?this.drawingBins(a).then(function(){var a=b.getFramePainter();b.drawLego();b.updatePaletteDraw();a.render3D();a.addKeysHandler();
return b}):Promise.resolve(this)};JSROOT.v7.RH2Painter.prototype.draw3D=function(a){var b=this;this.mode3d=!0;var c=this.getFramePainter(),h=this.isMainPainter();if("resize"==a)return h&&c.resize3D()&&c.render3D(),Promise.resolve(this);var u=1.1;this.zmin=c.logz?.3*this.gminposbin:this.gminbin;this.zmax=this.gmaxbin;-1111!==this.options.minimum&&(this.zmin=this.options.minimum);-1111!==this.options.maximum&&(this.zmax=this.options.maximum,u=1);c.logz&&0>=this.zmin&&(this.zmin=1E-5*this.zmax);this.deleteAttr();
h&&(c.create3DScene(this.options.Render3D),c.setAxesRanges(this.getAxis("x"),this.xmin,this.xmax,this.getAxis("y"),this.ymin,this.ymax,null,this.zmin,this.zmax),c.set3DOptions(this.options),c.drawXYZ(c.toplevel,{zmult:u,zoom:JSROOT.settings.Zooming,ndim:2}));return c.mode3d?this.drawingBins(a).then(function(){var a=b.getFramePainter();b.draw3DBins();a.render3D();a.addKeysHandler();return b}):Promise.resolve(this)};JSROOT.v7.RH2Painter.prototype.draw3DBins=function(){if(this.draw_content){if(this.isRH2Poly())return this.drawPolyLego();
if(this.options.Surf)return this.drawSurf();if(this.options.Error)return this.drawError();if(this.options.Contour)return this.drawContour3D(!0);this.drawLego();this.updatePaletteDraw()}};JSROOT.v7.RH2Painter.prototype.drawContour3D=function(a){var b=this.getFramePainter(),c=this.prepareDraw({rounding:!1,use3d:!0,extra:100,middle:0}),h=b.getHistPalette(),u=2*b.size_z3d,r=[];this.createContour(b,h,{full_z_range:!0});var t=h.getContour();this.buildContour(c,t,h,function(c,f,h,g,w,v){if(!(3>w-g)){if(a&&
(u=b.grz(t[v]),0>u||u>2*b.size_z3d))return;for(c=g;c<w;++c)r.push(f[c],h[c],u),r.push(f[c+1],h[c+1],u)}});c=B.createLineSegments(r,ja(this));b.toplevel.add(c)};JSROOT.v7.RH2Painter.prototype.drawSurf=function(){function a(a,b,c,d,e,f){if(l){var h=0>c?-1:c>2*t.size_z3d?1:0,g=0>f?-1:f>2*t.size_z3d?1:0;if(h!==g||0===h){if(!E)return++O;if(0!==h){var k=f-c;c=0>h?0:2*t.size_z3d;a=d-(d-a)/k*(f-c);b=e-(e-b)/k*(f-c)}0!==g&&(h=c-f,f=0>g?0:2*t.size_z3d,d=a-(a-d)/h*(c-f),e=b-(b-e)/h*(c-f));D[M]=a;D[M+1]=b;D[M+
2]=c;M+=3;D[M]=d;D[M+1]=e;D[M+2]=f;M+=3}}}function f(a,b,c,d,f,e,h,g){F>=H.length&&console.log("more than 6 points???");c=(h-c)/(e-c);e=3;0!==P&&Math.abs(c)<Math.abs(P)&&(H[F]=H[F-3],H[F+1]=H[F-2],H[F+2]=H[F-1],F-=3,e=6);H[F]=a+c*(d-a);H[F+1]=b+c*(f-b);H[F+2]=h;g&&G&&(Q[R]=H[F],Q[R+1]=H[F+1],Q[R+2]=H[F+2],R+=3);F+=e;P=c}function c(a,b,c){b=8*((b-k.i1)/w*N+(c-k.j1)/v);if(0<=J[b])return console.error("More than 8 vertexes for the bin");c=b+8+J[b];J[b]--;J[c]=a}function h(a){for(var b=k.i1;b<k.i2;b+=
w)for(var c=k.j1;c<k.j2;c+=v){var d=8*((b-k.i1)/w*N+(c-k.j1)/v);if(-1!==J[d]){var f=0<=J[d]?d:d+9+J[d];d+=8;for(var e=0,h=0,g=0,l=f;l<d;++l){var n=J[l];if(0>n)return console.error("FAILURE in NORMALS RECALCULATIONS");e+=a[n];h+=a[n+1];g+=a[n+2]}e/=d-f;h/=d-f;for(g/=d-f;f<d;++f)l=J[f],a[l]=e,a[l+1]=h,a[l+2]=g}}}function u(a,b,d,h,g,k,l,m,r,t){for(var y=1;y<e.length;++y){var p=d<e[y-1]?-1:d>e[y]?1:0,u=k<e[y-1]?-1:k>e[y]?1:0,z=r<e[y-1]?-1:r>e[y]?1:0,A=p+u+z;if(3!==A){if(-3===A)break;if(E){if(F=R=0,0===
p&&(H[F]=a,H[F+1]=b,H[F+2]=d,F+=3),p!==u&&(P=0,(0>p||0>u)&&f(a,b,d,h,g,k,e[y-1]),(0<p||0<u)&&f(a,b,d,h,g,k,e[y],!0)),0===u&&(H[F]=h,H[F+1]=g,H[F+2]=k,F+=3),u!==z&&(P=0,(0>u||0>z)&&f(h,g,k,l,m,r,e[y-1]),(0<u||0<z)&&f(h,g,k,l,m,r,e[y],!0)),0===z&&(H[F]=l,H[F+1]=m,H[F+2]=r,F+=3),z!==p&&(P=0,(0>z||0>p)&&f(l,m,r,a,b,d,e[y-1]),(0<z||0<p)&&f(l,m,r,a,b,d,e[y],!0)),0!==F)if(9>F)console.log("found less than 3 points",F/3);else{if(G&&6===R){for(p=0;6>p;++p)G[T+p]=Q[p];T+=6}p=L[y];u=I[y];x&&9===F&&(c(u,C,n),
c(u+3,C+1,t?n+v:n),c(u+6,t?C:C+w,n+v));for(z=3;z<F-3;z+=3)p[u]=H[0],p[u+1]=H[1],p[u+2]=H[2],u+=3,p[u]=H[z],p[u+1]=H[z+1],p[u+2]=H[z+2],u+=3,p[u]=H[z+3],p[u+1]=H[z+4],p[u+2]=H[z+5],u+=3;I[y]=u}}else A=Math.abs(u-p)+Math.abs(z-u)+Math.abs(p-z),0===p&&++A,0===u&&++A,0===z&&++A,1!==A&&2!==A||console.error("FOND npnts",A),2<A&&(void 0===q[y]&&(q[y]=0),q[y]+=A-2),!(0<p||0<u||0<z)||p===u&&u===z&&z===p||++K}}}var r=this.getHisto(),t=this.getFramePainter(),k=this.prepareDraw({rounding:!1,use3d:!0,extra:1,
middle:.5}),C,n,g,w=k.stepi,v=k.stepj;var d=k.i2-k.i1;var N=k.j2-k.j1,m=t.z_handle.gr.domain()[0];1<w&&(d=Math.round(d/w),d*w<k.i2-k.i1&&d++);1<v&&(N=Math.round(N/v),N*v<k.j2-k.j1&&N++);var p=t.logz?function(a){return a<m?-.1:t.grz(a)}:t.grz;if(!(2>k.i2-k.i1||2>k.j2-k.j1)){var e=g=null,l=!0,A=!1,x=!1,z=null;var y=0;switch(this.options.Surf){case 11:y=2;break;case 12:case 15:case 17:y=2;l=!1;break;case 14:l=!1;x=!0;break;case 16:y=1;A=!0;l=!1;break;default:g=t.z_handle.createTicks(!0),A=!0}0<y&&(z=
t.getHistPalette(),2==y&&this.createContour(t,z,{full_z_range:!0}),g=z.getContour());if(g)for(e=new Float32Array(g.length),y=0;y<g.length;++y)e[y]=p(g[y]);else e=[0,2*t.size_z3d];var E,q=[],L=[],I=[],O=0,D=null,M=0,K=0,G=null,T=0,J=null,H=new Float32Array(18),F=0,P=0,Q=new Float32Array(6),R=0;if(x)for(J=new Int32Array(d*N*8),d=0;d<J.length;++d)J[d]=-1;for(E=0;2>E;++E){if(E){for(d=1;d<e.length;++d)q[d]&&(L[d]=new Float32Array(9*q[d]),I[d]=0);l&&0<O&&(D=new Float32Array(6*O));A&&0<K&&(G=new Float32Array(6*
K))}for(C=k.i1;C<k.i2-w;C+=w)for(d=k.grx[C],y=k.grx[C+w],n=k.j1;n<k.j2-v;n+=v){g=k.gry[n];var W=k.gry[n+v];var da=p(r.getBinContent(C+1,n+1));var ba=p(r.getBinContent(C+1,n+1+v));var ea=p(r.getBinContent(C+1+v,n+1));var X=p(r.getBinContent(C+1+v,n+1+v));u(d,g,da,y,W,X,d,W,ba,!0);u(d,g,da,y,g,ea,y,W,X,!1);a(d,W,ba,d,g,da);a(d,g,da,y,g,ea);C===k.i2-2&&a(y,g,ea,y,W,X);n===k.j2-2&&a(d,W,ba,y,W,X)}}for(r=1;r<e.length;++r)L[r]&&(I[r]!==9*q[r]&&console.error("SURF faces missmatch lvl",r,"faces",q[r],"index",
I[r],"check",9*q[r]-I[r]),p=new b.BufferGeometry,p.setAttribute("position",new b.BufferAttribute(L[r],3)),p.computeVertexNormals(),x&&1===r&&h(p.getAttribute("normal").array),A=A=void 0,A=z?z.getColor(r-1):this.getColor(5),A=14===this.options.Surf?new b.MeshLambertMaterial({color:A,side:b.DoubleSide}):new b.MeshBasicMaterial({color:A,side:b.DoubleSide}),p=new b.Mesh(p,A),t.toplevel.add(p),p.painter=this);D&&(6*O!==M&&console.error("SURF lines mismmatch nsegm",O," lindx",M,"difference",6*O-M),z=this.getColor(7),
z=new b.LineBasicMaterial({color:new b.Color(z),linewidth:this.v7EvalAttr("line_width",1)}),z=B.createLineSegments(D,z),z.painter=this,t.toplevel.add(z));G&&(6*K!==T&&console.error("SURF grid draw mismatch ngridsegm",K,"gindx",T,"diff",6*K-T),z=1===this.options.Surf?new b.LineDashedMaterial({color:0,dashSize:2,gapSize:2}):new b.LineBasicMaterial({color:new b.Color(this.v7EvalColor("line_color","lightblue"))}),z=B.createLineSegments(G,z),z.painter=this,t.toplevel.add(z));17===this.options.Surf&&this.drawContour3D();
if(13===this.options.Surf){k=this.prepareDraw({rounding:!1,use3d:!0,extra:100,middle:0});z=this.getContour();var U=this.getHistPalette(),S=-1,Y=2*t.size_z3d;this.buildContour(k,z,U,function(a,c,d,f,e){c[e]===c[f]&&d[e]===d[f]&&e--;if(!(3>e-f)){for(var h=[],g=f;g<=e;++g)g!==f&&c[g]===c[g-1]&&d[g]===d[g-1]||h.push(new b.Vector2(c[g],d[g]));if(!(3>h.length)&&(f=b.ShapeUtils.triangulateShape(h,[]))&&0!==f.length){if(0>S||S!==a)S=a,Y+=1E-4*t.size_z3d;c=new Float32Array(9*f.length);d=new Float32Array(9*
f.length);for(g=e=0;g<f.length;++g)for(var k=f[g],l=0;3>l;++l){var m=h[k[l]];c[e]=m.x;c[e+1]=m.y;c[e+2]=Y;d[e]=0;d[e+1]=0;d[e+2]=1;e+=3}h=new b.BufferGeometry;h.setAttribute("position",new b.BufferAttribute(c,3));h.setAttribute("normal",new b.BufferAttribute(d,3));a=U.getColor(a);a=new b.MeshBasicMaterial({color:a,flatShading:!0,side:b.DoubleSide,opacity:.5});a=new b.Mesh(h,a);a.painter=this;t.toplevel.add(a)}}})}this.updatePaletteDraw()}};JSROOT.v7.RH2Painter.prototype.drawError=function(){for(var a=
this.getFramePainter(),f=this.getHisto(),c=this.prepareDraw({rounding:!1,use3d:!0,extra:1}),h=a.z_handle.gr.domain()[0],u=a.z_handle.gr.domain()[1],r,t,k,C,n,g,w,v,d,q=0,m=null,p=null,e=0,l=c.stepi,A=c.stepj,x=0;2>x;++x){for(r=c.i1;r<c.i2;r+=l)for(n=c.grx[r],w=c.grx[r+l],t=c.j1;t<c.j2;t+=A)if(k=f.getBinContent(r+1,t+1),!(k<h||k>u)){if(g=k===h)g=this.options.Zero||0<h?!1:!this._show_empty_bins;g||(0===x?q+=3:(C=f.getBinError(r+1,t+1),p[e/18]=f.getBin(r+1,t+1),g=c.gry[t],v=c.gry[t+A],d=a.grz(k-C<h?
h:k-C),k=a.grz(k+C>u?u:k+C),m[e]=n,m[e+3]=w,m[e+1]=m[e+4]=(g+v)/2,m[e+2]=m[e+5]=(d+k)/2,e+=6,m[e]=m[e+3]=(n+w)/2,m[e+1]=g,m[e+4]=v,m[e+2]=m[e+5]=(d+k)/2,e+=6,m[e]=m[e+3]=(n+w)/2,m[e+1]=m[e+4]=(g+v)/2,m[e+2]=d,m[e+5]=k,e+=6))}if(0===x){if(0===q)return;m=new Float32Array(6*q);p=new Int32Array(q/3)}}f=new b.Color(this.v7EvalColor("line_color","lightblue"));r=new b.LineBasicMaterial({color:f,linewidth:this.v7EvalAttr("line_width",1)});m=B.createLineSegments(m,r);m.painter=this;m.intersect_index=p;m.zmin=
h;m.zmax=u;m.tip_color=.5>f.g?65280:16711680;m.handle=c;m.tooltip=function(a){if(isNaN(a.index))return console.error("segment index not provided, check three.js version",b.REVISION,"expected r102"),null;var c=Math.floor(a.index/6);if(0>c||c>=this.intersect_index.length)return null;var d=this.painter;a=d.getFramePainter();c=d.get3DToolTip(this.intersect_index[c]);d=this.handle;var f=c.ix-1,e=f+d.stepi,h=c.iy-1,g=h+d.stepj;c.x1=Math.max(-a.size_xy3d,d.grx[f]);c.x2=Math.min(a.size_xy3d,d.grx[e]);c.y1=
Math.max(-a.size_xy3d,d.gry[h]);c.y2=Math.min(a.size_xy3d,d.gry[g]);c.z1=a.grz(c.value-c.error<this.zmin?this.zmin:c.value-c.error);c.z2=a.grz(c.value+c.error>this.zmax?this.zmax:c.value+c.error);c.color=this.tip_color;return c};a.toplevel.add(m)};JSROOT.v7.RH2Painter.prototype.drawPolyLego=function(){var a=this.getHisto(),f=this.getHistPalette(),c=this.getFramePainter(),h=c.z_handle.gr.domain()[0],u=c.z_handle.gr.domain()[1],r,t=a.fBins.arr.length,k=c.grz(h),C=k;this.maxbin=this.gmaxbin;this.minbin=
this.gminbin;this.minposbin=this.gminposbin;for(r=0;r<t;++r){var n=a.fBins.arr[r];if(!(n.fContent<h)){var g=f.getContourIndex(n.fContent);if(null!==g&&!(n.fXmin>c.scale_xmax||n.fXmax<c.scale_xmin||n.fYmin>c.scale_ymax||n.fYmax<c.scale_ymin)){C=c.grz(n.fContent>u?u:n.fContent);var w=[],v=[],d=1,q=n.fPoly,m=0;"TMultiGraph"==q._typename&&(d=n.fPoly.fGraphs.arr.length,q=null);for(var p=0;p<d;++p){if(!q||0<p)q=n.fPoly.fGraphs.arr[p];for(var e=q.fNpoints,l=q.fX,A=q.fY;2<e&&l[0]===l[e-1]&&A[0]===A[e-1];)--e;
for(var x=void 0,z=void 0,y=0;2>y;++y){var B=void 0,D=void 0,L=void 0,I=void 0,O=c.size_xy3d*c.size_z3d,Z=0<y?0:O/1E6;x=[];z=null;for(var M=0;M<e;++M)L=c.grx(l[M]),I=c.gry(A[M]),0<M&&(O=(L-B)*(L-B)+(I-D)*(I-D)),O>Z&&(x.push(new b.Vector2(L,I)),B=L,D=I);try{2<x.length&&(z=b.ShapeUtils.triangulateShape(x,[]))}catch(K){z=null}if(z&&z.length>x.length-3)break}z&&z.length&&x&&(w.push(x),v.push(z),m+=2*z.length,C>k&&(m+=2*x.length))}n=new Float32Array(9*m);for(q=d=0;q<w.length;++q){m=w[q];p=v[q];for(e=0;2>
e;++e)for(l=0;l<p.length;++l)z=p[l],A=m[z[0]],x=m[z[0===e?2:1]],z=m[z[0===e?1:2]],n[d]=A.x,n[d+1]=A.y,n[d+2]=e?C:k,d+=3,n[d]=x.x,n[d+1]=x.y,n[d+2]=e?C:k,d+=3,n[d]=z.x,n[d+1]=z.y,n[d+2]=e?C:k,d+=3;if(C>k)for(p=0;p<m.length;++p)e=m[p],l=m[0<p?p-1:m.length-1],n[d]=e.x,n[d+1]=e.y,n[d+2]=k,d+=3,n[d]=l.x,n[d+1]=l.y,n[d+2]=k,d+=3,n[d]=l.x,n[d+1]=l.y,n[d+2]=C,d+=3,n[d]=e.x,n[d+1]=e.y,n[d+2]=k,d+=3,n[d]=l.x,n[d+1]=l.y,n[d+2]=C,d+=3,n[d]=e.x,n[d+1]=e.y,n[d+2]=C,d+=3}w=new b.BufferGeometry;w.setAttribute("position",
new b.BufferAttribute(n,3));w.computeVertexNormals();g=this.fPalette.getColor(g);g=new b.MeshBasicMaterial({color:g,flatShading:!0});g=new b.Mesh(w,g);c.toplevel.add(g);g.painter=this;g.bins_index=r;g.draw_z0=k;g.draw_z1=C;g.tip_color=65280;g.tooltip=function(){var a=this.painter,b=a.getFramePainter(),c=a.getObject().fBins.arr[this.bins_index];return{use_itself:!0,x1:b.grx(c.fXmin),x2:b.grx(c.fXmax),y1:b.gry(c.fYmin),y2:b.gry(c.fYmax),z1:this.draw_z0,z2:this.draw_z1,bin:this.bins_index,value:c.fContent,
color:this.tip_color,lines:a.getPolyBinTooltips(this.bins_index)}}}}}};R.prototype=Object.create(JSROOT.v7.RHistPainter.prototype);R.prototype.getDimension=function(){return 3};R.prototype.scanContent=function(a){if(!(a&&this.nbinsx&&this.nbinsy&&this.nbinsz)&&(a=this.getHisto())){this.extractAxesProperties(3);if(this.isDisplayItem())this.gminbin=a.fContMin,this.gminposbin=0<a.fContMinPos?a.fContMinPos:null,this.gmaxbin=a.fContMax;else{this.gminbin=this.gmaxbin=a.getBinContent(1,1,1);for(var b=0;b<
this.nbinsx;++b)for(var c=0;c<this.nbinsy;++c)for(var h=0;h<this.nbinsz;++h){var u=a.getBinContent(b+1,c+1,h+1);u<this.gminbin?this.gminbin=u:u>this.gmaxbin&&(this.gmaxbin=u)}}this.draw_content=0<this.gmaxbin}};R.prototype.countStat=function(){var a=this.getHisto(),b=this.getAxis("x"),c=this.getAxis("y"),h=this.getAxis("z"),u=0,r=0,t=0,k=0,C=0,n=0,g=0,w=this.getSelectIndex("x","left"),v=this.getSelectIndex("x","right"),d=this.getSelectIndex("y","left"),q=this.getSelectIndex("y","right"),m=this.getSelectIndex("z",
"left"),p=this.getSelectIndex("z","right"),e=this.getFramePainter(),l={name:a.fName,entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},A,x,z;for(A=1;A<=this.nbinsx;++A){var y=b.GetBinCoord(A-.5);var B=A<=w+1?0:A>v+1?2:1;for(x=1;x<=this.nbinsy;++x){var D=c.GetBinCoord(x-.5);var L=x<=d+1?0:x>q+1?2:1;for(z=1;z<=this.nbinsz;++z){var I=h.GetBinCoord(z-.5);var O=z<=m+1?0:z>p+1?2:1;var Z=a.getBinContent(A,x,z);l.entries+=Z;1==B&&1==L&&1==O&&(u+=Z,r+=y*Z,t+=D*Z,k+=I*Z,C+=y*y*Z,n+=D*D*Z,g+=
I*I*Z)}}}0<a.fTsumw&&!e.isAxisZoomed("x")&&!e.isAxisZoomed("y")&&!e.isAxisZoomed("z")&&(u=a.fTsumw,r=a.fTsumwx,C=a.fTsumwx2,t=a.fTsumwy,n=a.fTsumwy2,k=a.fTsumwz,g=a.fTsumwz2);0<u&&(l.meanx=r/u,l.meany=t/u,l.meanz=k/u,l.rmsx=Math.sqrt(Math.abs(C/u-l.meanx*l.meanx)),l.rmsy=Math.sqrt(Math.abs(n/u-l.meany*l.meany)),l.rmsz=Math.sqrt(Math.abs(g/u-l.meanz*l.meanz)));l.integral=u;1<a.fEntries&&(l.entries=a.fEntries);return l};R.prototype.fillStatistic=function(a,b){var c=this.countStat(),f=b%10,u=Math.floor(b/
10)%10,r=Math.floor(b/100)%10,t=Math.floor(b/1E3)%10;b=Math.floor(b/1E6)%10;a.clearStat();0<f&&a.addText(c.name);0<u&&a.addText("Entries = "+a.format(c.entries,"entries"));0<r&&(a.addText("Mean x = "+a.format(c.meanx)),a.addText("Mean y = "+a.format(c.meany)),a.addText("Mean z = "+a.format(c.meanz)));0<t&&(a.addText("Std Dev x = "+a.format(c.rmsx)),a.addText("Std Dev y = "+a.format(c.rmsy)),a.addText("Std Dev z = "+a.format(c.rmsz)));0<b&&a.addText("Integral = "+a.format(c.integral,"entries"));return!0};
R.prototype.getBinTooltips=function(a,b,c){var f=[],u=this.getHisto(),r=1,t=1,k=1;this.isDisplayItem()&&(r=u.stepx||1,t=u.stepy||1,k=u.stepz||1);f.push(this.getObjectHint());f.push("x = "+this.getAxisBinTip("x",a,r)+"  xbin="+a);f.push("y = "+this.getAxisBinTip("y",b,t)+"  ybin="+b);f.push("z = "+this.getAxisBinTip("z",c,k)+"  zbin="+c);a=u.getBinContent(a+1,b+1,c+1);r="entries = "+(1<r||1<t||1<k?"~":"");a===Math.round(a)?f.push(r+a):f.push(r+B.floatToString(a,JSROOT.gStyle.fStatFormat));return f};
R.prototype.draw3DScatter=function(a){var f=this.getHisto(),c=this.getFramePainter(),h=a.i1,u=a.i2,r=a.stepi,t=a.j1,k=a.j2,q=a.stepj,n=a.k1,g=a.k2,w=a.stepk,v,d;if(u<=h||k<=t||g<=n)return!0;var D=1E3<this.gmaxbin?1E3/this.gmaxbin:1,m=0,p=0,e=Math.max(0,this.gminbin);for(a=h;a<u;a+=r)for(v=t;v<k;v+=q)for(d=n;d<g;d+=w){var l=f.getBinContent(a+1,v+1,d+1);p+=l;l<=e||(m+=Math.round(l*D))}if(m>(c.webgl?1E5:3E4))return!1;JSROOT.seed(p);p=new B.PointsCreator(m,c.webgl,c.size_xy3d/200);m=new Int32Array(m);
var A=0,x=this.getAxis("x"),z=this.getAxis("y"),y=this.getAxis("z");for(a=h;a<u;a+=r)for(v=t;v<k;v+=q)for(d=n;d<g;d+=w)if(l=f.getBinContent(a+1,v+1,d+1),!(l<=e))for(h=Math.round(l*D),l=0;l<h;++l){var E=x.GetBinCoord(a+JSROOT.random()),Q=z.GetBinCoord(v+JSROOT.random()),L=y.GetBinCoord(d+JSROOT.random());m[A++]=f.getBin(a+1,v+1,d+1);p.addPoint(c.grx(E),c.gry(Q),c.grz(L))}f=this.v7EvalColor("fill_color","red");f=p.createPoints(f);c.toplevel.add(f);f.bins=m;f.painter=this;f.tip_color=65280;f.tooltip=
function(a){if(isNaN(a.index))return console.error("intersect.index not provided, check three.js version",b.REVISION,"expected r102"),null;var c=Math.floor(a.index/this.nvertex);if(0>c||c>=this.bins.length)return null;a=this.painter;var d=a.getFramePainter();c=a.get3DToolTip(this.bins[c]);c.x1=d.grx(a.getAxis("x").GetBinLowEdge(c.ix));c.x2=d.grx(a.getAxis("x").GetBinLowEdge(c.ix+r));c.y1=d.gry(a.getAxis("y").GetBinLowEdge(c.iy));c.y2=d.gry(a.getAxis("y").GetBinLowEdge(c.iy+q));c.z1=d.grz(a.getAxis("z").GetBinLowEdge(c.iz));
c.z2=d.grz(a.getAxis("z").GetBinLowEdge(c.iz+w));c.color=this.tip_color;c.opacity=.3;return c};return!0};R.prototype.draw3DBins=function(){if(this.draw_content){var a=this.prepareDraw({only_indexes:!0,extra:-.5,right_extra:-1});if(!this.options.Scatter||!this.draw3DScatter(a)){var f=this.v7EvalColor("fill_color","red"),c=this.getFramePainter(),h=0,u=!1,r=!1,t=!1,k=1,q=!0,n=.5;if(this.options.Sphere){n=.4;u=!0;11===this.options.Sphere&&(t=!0);var g=c.webgl?new b.SphereGeometry(.5,16,12):new b.SphereGeometry(.5,
8,6);g.applyMatrix4((new b.Matrix4).makeRotationX(Math.PI/2));h=9*g.faces.length;var w=new Float32Array(h);var v=new Float32Array(h);for(var d=0;d<g.faces.length;++d)w[9*d]=g.vertices[g.faces[d].a].x,w[9*d+1]=g.vertices[g.faces[d].a].y,w[9*d+2]=g.vertices[g.faces[d].a].z,w[9*d+3]=g.vertices[g.faces[d].b].x,w[9*d+4]=g.vertices[g.faces[d].b].y,w[9*d+5]=g.vertices[g.faces[d].b].z,w[9*d+6]=g.vertices[g.faces[d].c].x,w[9*d+7]=g.vertices[g.faces[d].c].y,w[9*d+8]=g.vertices[g.faces[d].c].z,v[9*d]=g.faces[d].vertexNormals[0].x,
v[9*d+1]=g.faces[d].vertexNormals[0].y,v[9*d+2]=g.faces[d].vertexNormals[0].z,v[9*d+3]=g.faces[d].vertexNormals[1].x,v[9*d+4]=g.faces[d].vertexNormals[1].y,v[9*d+5]=g.faces[d].vertexNormals[1].z,v[9*d+6]=g.faces[d].vertexNormals[2].x,v[9*d+7]=g.faces[d].vertexNormals[2].y,v[9*d+8]=g.faces[d].vertexNormals[2].z}else{g=B.Box3D.Indexes;d=B.Box3D.Normals;var D=B.Box3D.Vertices;h=3*g.length;w=new Float32Array(h);v=new Float32Array(h);for(var m=0,p=-3;m<g.length;++m){var e=D[g[m]];w[3*m]=e.x-.5;w[3*m+1]=
e.y-.5;w[3*m+2]=e.z-.5;0===m%6&&(p+=3);v[3*m]=d[p];v[3*m+1]=d[p+1];v[3*m+2]=d[p+2]}r=!0;11==this.options.Box?t=!0:12==this.options.Box?(t=!0,r=!1):this.options.Color&&(t=!0,k=.5,r=q=!1,u=!0)}q&&(q=this.gminbin||this.gmaxbin?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1);var l=this.getHisto(),A=a.i1,x=a.i2,z=a.stepi,y=a.j1,E=a.j2,Q=a.stepj,L=a.k1,I=a.k2,O=a.stepk;a=null;t&&(a=c.getHistPalette(),this.createContour(c,a));if(!(x<=A||E<=y||I<=L)){var R=this.getAxis("x"),M=this.getAxis("y"),
K=this.getAxis("z");g=(c.grx(R.GetBinCoord(x))-c.grx(R.GetBinCoord(A)))/(x-A)*z;d=(c.gry(M.GetBinCoord(E))-c.gry(M.GetBinCoord(y)))/(E-y)*Q;D=(c.grz(K.GetBinCoord(I))-c.grz(K.GetBinCoord(L)))/(I-L)*O;var G=0,T,J,H;m=[];var F=0;p=[];for(T=A;T<x;T+=z)for(J=y;J<E;J+=Q)for(H=L;H<I;H+=O){var P=l.getBinContent(T+1,J+1,H+1);if(this.options.Color||!(0===P||P<this.gminbin)){var ha=q?Math.pow(Math.abs(P*q),.3333):1;.001>ha||(G++,t&&(e=a.getContourIndex(P),0<=e?(void 0===m[e]&&(m[e]=0,p[e]=F++),m[e]+=1):console.error("not found color for",
P)))}}t||(m.push(G),F=1,p=[0]);var ja=Array(F);e=Array(F);var W=Array(F),da=Array(F),ba=Array(F),ea=Array(F);F=Array(F);for(T=0;T<m.length;++T)m[T]&&(G=m[T],J=p[T],ja[J]=0,ba[J]=0,r&&(ba[J]=65520<G*h/3?2:1),e[J]=new Float32Array(G*h),W[J]=new Float32Array(G*h),da[J]=new Int32Array(G),1===ba[J]&&(ea[J]=new Uint16Array(G*B.Box3D.MeshSegments.length)),2===ba[J]&&(F[J]=new Float32Array(G*B.Box3D.Segments.length*3)));R=this.getAxis("x");M=this.getAxis("y");K=this.getAxis("z");for(T=A;T<x;T+=z)for(G=R.GetBinCenter(T+
1),r=c.grx(G),J=y;J<E;J+=Q)for(G=M.GetBinCenter(J+1),A=c.gry(G),H=L;H<I;H+=O)if(P=l.getBinContent(T+1,J+1,H+1),this.options.Color||!(0===P||P<this.gminbin))if(ha=q?Math.pow(Math.abs(P*q),.3333):1,!(.001>ha)){var X=0;if(t){G=a.getContourIndex(P);if(0>G)continue;X=p[G]}G=ja[X];P=K.GetBinCenter(H+1);P=c.grz(P);da[X][G]=l.getBin(T+1,J+1,H+1);for(var U=G*h,S=e[X],Y=W[X],V=0;V<h;V+=3,U+=3)S[U]=r+w[V]*g*ha,S[U+1]=A+w[V+1]*d*ha,S[U+2]=P+w[V+2]*D*ha,Y[U]=v[V],Y[U+1]=v[V+1],Y[U+2]=v[V+2];if(1===ba[X]){S=B.Box3D.MeshSegments;
U=G*S.length;Y=Math.round(G*h/3);V=ea[X];for(var aa=0;aa<S.length;++aa)V[U+aa]=Y+S[aa]}if(2===ba[X])for(S=B.Box3D.Segments,Y=F[X],U=G*S.length*3,V=0;V<S.length;++V,U+=3)aa=B.Box3D.Vertices[S[V]],Y[U]=r+(aa.x-.5)*g*ha,Y[U+1]=A+(aa.y-.5)*d*ha,Y[U+2]=P+(aa.z-.5)*D*ha;ja[X]=G+1}for(w=0;w<m.length;++w)m[w]&&(G=m[w],v=p[w],l=new b.BufferGeometry,l.setAttribute("position",new b.BufferAttribute(e[v],3)),l.setAttribute("normal",new b.BufferAttribute(W[v],3)),t&&(f=a.getColor(w)),x=u?new b.MeshLambertMaterial({color:f,
opacity:k,transparent:1>k}):new b.MeshBasicMaterial({color:f,opacity:k}),l=new b.Mesh(l,x),l.bins=da[v],l.bins_faces=h/9,l.painter=this,l.scalex=n*g,l.scaley=n*d,l.scalez=n*D,l.tip_color=65280,l.use_scale=q,l.tooltip=function(a){if(isNaN(a.faceIndex))return console.error("intersect.faceIndex not provided, check three.js version",b.REVISION,"expected r102"),null;a=Math.floor(a.faceIndex/this.bins_faces);if(0>a||a>=this.bins.length)return null;var c=this.painter,d=c.getFramePainter();a=c.get3DToolTip(this.bins[a]);
var e=d.grx(c.getAxis("x").GetBinCoord(a.ix-.5)),f=d.gry(c.getAxis("y").GetBinCoord(a.iy-.5));c=d.grz(c.getAxis("z").GetBinCoord(a.iz-.5));d=this.use_scale?Math.pow(Math.abs(a.value*this.use_scale),.3333):1;a.x1=e-this.scalex*d;a.x2=e+this.scalex*d;a.y1=f-this.scaley*d;a.y2=f+this.scaley*d;a.z1=c-this.scalez*d;a.z2=c+this.scalez*d;a.color=this.tip_color;return a},c.toplevel.add(l),0<ba[v]&&(l=this.v7EvalColor("line_color","lightblue"),l=new b.LineBasicMaterial({color:l}),x=null,x=1===ba[v]?B.createLineSegments(e[v],
l,ea[v]):B.createLineSegments(F[v],l),c.toplevel.add(x)));t&&this.updatePaletteDraw()}}}};R.prototype.redraw=function(a){var b=this,c=this.getFramePainter();"resize"==a?c.resize3D()&&c.render3D():(c.create3DScene(this.options.Render3D),c.setAxesRanges(this.getAxis("x"),this.xmin,this.xmax,this.getAxis("y"),this.ymin,this.ymax,this.getAxis("z"),this.zmin,this.zmax),c.set3DOptions(this.options),c.drawXYZ(c.toplevel,{zoom:JSROOT.settings.Zooming,ndim:3}),this.drawingBins(a).then(function(){var a=b.getFramePainter();
b.draw3DBins();a.render3D();a.addKeysHandler()}))};R.prototype.fillToolbar=function(){var a=this.getPadPainter();a&&(a.addPadButton("auto_zoom","Unzoom all axes","ToggleZoom","Ctrl *"),this.draw_content&&a.addPadButton("statbox","Toggle stat box","ToggleStatBox"),a.showPadButtons())};R.prototype.canZoomInside=function(a,b,c){var f=this.getHisto();f&&(f=f["f"+a.toUpperCase()+"axis"]);return!f||1<f.FindBin(c,.5)-f.FindBin(b,0)};R.prototype.autoZoom=function(){var a=this.getSelectIndex("x","left"),b=
this.getSelectIndex("x","right"),c=this.getSelectIndex("y","left"),h=this.getSelectIndex("y","right"),u=this.getSelectIndex("z","left"),r=this.getSelectIndex("z","right"),t,k,q,n=this.getHisto();if(a!==b&&c!==h&&u!==r){var g=n.getBinContent(a+1,c+1,u+1);for(t=a;t<b;++t)for(k=c;k<h;++k)for(q=u;q<r;++q)g=Math.min(g,n.getBinContent(t+1,k+1,q+1));if(!(0<g)){var w=b,v=a,d=h,B=c,m=r,p=u;for(t=a;t<b;++t)for(k=c;k<h;++k)for(q=u;q<r;++q)n.getBinContent(t+1,k+1,q+1)>g&&(t<w&&(w=t),t>=v&&(v=t+1),k<d&&(d=k),
k>=B&&(B=k+1),q<m&&(m=q),q>=p&&(p=q+1));t=!1;w===v-1&&w>a+1&&v<b-1&&(w--,v++);d===B-1&&d>c+1&&B<h-1&&(d--,B++);m===p-1&&m>u+1&&p<r-1&&(m--,p++);if((w>a||v<b)&&w<v-1){var e=this.getAxis("x").GetBinLowEdge(w+1);var l=this.getAxis("x").GetBinLowEdge(v+1);t=!0}if((d>c||B<h)&&d<B-1){var A=this.getAxis("y").GetBinLowEdge(d+1);var x=this.getAxis("y").GetBinLowEdge(B+1);t=!0}if((m>u||p<r)&&m<p-1){var z=this.getAxis("z").GetBinLowEdge(m+1);var y=this.getAxis("z").GetBinLowEdge(p+1);t=!0}t&&this.getFramePainter().zoom(e,
l,A,x,z,y)}}};R.prototype.fillHistContextMenu=function(a){var b=this,c=B.getDrawSettings("ROOT."+this.getObject()._typename,"nosame");a.addDrawMenu("Draw with",c.opts,function(a){if("inspect"===a)return b.showInspector();b.decodeOptions(a);b.interactiveRedraw(!0,"drawopt")})};JSROOT.v7.RH3Painter=R;JSROOT.v7.drawHist3=function(a,b){var c=new R(a,b);return B.ensureRCanvas(c,"3d").then(function(){c.setAsMainPainter();c.options={Box:0,Scatter:!1,Sphere:0,Color:!1,minimum:-1111,maximum:-1111};var a=c.v7EvalAttr("kind",
""),b=c.v7EvalAttr("sub",0),f=c.options;switch(a){case "box":f.Box=10+b;break;case "sphere":f.Sphere=10+b;break;case "col":f.Color=!0;break;case "scat":f.Scatter=!0;break;default:f.Box=10}c.scanContent();c.redraw();return c})};return JSROOT});
