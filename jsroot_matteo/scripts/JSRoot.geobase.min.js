JSROOT.define(["three","csg"],function(g,z){function A(a){this.nfaces=a;this.indx=0;this.pos=new Float32Array(9*a);this.norm=new Float32Array(9*a);return this}function B(){this.polygons=[]}function Sd(a,b){var d=[4,7,6,5,0,3,7,4,4,5,1,0,6,2,1,5,7,3,2,6,1,2,3,0];b=0<b?new B:new A(12);for(var c=0;c<d.length;c+=4){var e=3*d[c],f=3*d[c+1],h=3*d[c+2],l=3*d[c+3];b.addFace4(a[e],a[e+1],a[e+2],a[f],a[f+1],a[f+2],a[h],a[h+1],a[h+2],a[l],a[l+1],a[l+2]);0===c?b.setNormal(0,0,1):20===c?b.setNormal(0,0,-1):b.calcNormal()}return b.create()}
function Td(a,b){if("TGeoCone"==a._typename||"TGeoConeSeg"==a._typename){var d=[a.fRmax2,a.fRmax1];var c=[a.fRmin2,a.fRmin1]}else d=[a.fRmax,a.fRmax],c=[a.fRmin,a.fRmin];var e=0<c[0]||0<c[1],f=0,h=360;if("TGeoConeSeg"==a._typename||"TGeoTubeSeg"==a._typename||"TGeoCtub"==a._typename)f=a.fPhi1,h=a.fPhi2-a.fPhi1;var l=Math.max(4,Math.round(h/k.GradPerSegm)),q=l*(0>=d[0]||0>=d[1]?1:2);e&&(q+=l*(0>=c[0]||0>=c[1]?1:2));0<d[0]&&(q+=l*(0<c[0]?2:1));0<d[1]&&(q+=l*(0<c[1]?2:1));360>h&&(q+=(d[0]>c[0]?2:0)+
(d[1]>c[1]?2:0));if(0>b)return q;var m=f*Math.PI/180,g=h/l*Math.PI/180;f=new Float32Array(l+1);for(var t=new Float32Array(l+1),u=0;u<=l;++u)t[u]=Math.cos(m+u*g),f[u]=Math.sin(m+u*g);b=b?new B:new A(q);var w;"TGeoCtub"==a._typename&&(w=function(b,c,d){var e=0>d?a.fNlow:a.fNhigh;return(0>d?-a.fDz:a.fDz)-(b*e[0]+c*e[1])/e[2]});for(q=0;2>q&&(1!==q||e);++q){m=0===q?d:c;g=q;u=1-q;var r=1,pa=0;m[0]!==m[1]&&(pa=Math.atan2(m[1]-m[0],2*a.fDZ),r=Math.cos(pa),pa=Math.sin(pa));1===q&&(r*=-1,pa*=-1);var p=0;0>=
m[0]?p=2:0>=m[1]&&(p=1);for(var n=0;n<l;++n)b.addFace4(m[0]*t[n+g],m[0]*f[n+g],a.fDZ,m[1]*t[n+g],m[1]*f[n+g],-a.fDZ,m[1]*t[n+u],m[1]*f[n+u],-a.fDZ,m[0]*t[n+u],m[0]*f[n+u],a.fDZ,p),w&&b.recalcZ(w),b.setNormal_12_34(r*t[n+g],r*f[n+g],pa,r*t[n+u],r*f[n+u],pa,p)}for(e=0;2>e;++e)if(!(0>=d[e])){q=e;m=1-e;g=0==e?1:-1;u=0>=c[e]?2:0;2!=u||360!==h||w||b.startPolygon(0===e);for(r=0;r<l;++r)b.addFace4(c[e]*t[r+q],c[e]*f[r+q],g*a.fDZ,d[e]*t[r+q],d[e]*f[r+q],g*a.fDZ,d[e]*t[r+m],d[e]*f[r+m],g*a.fDZ,c[e]*t[r+m],
c[e]*f[r+m],g*a.fDZ,u),w?(b.recalcZ(w),b.calcNormal()):b.setNormal(0,0,g);b.stopPolygon()}360>h&&(b.addFace4(c[1]*t[0],c[1]*f[0],-a.fDZ,d[1]*t[0],d[1]*f[0],-a.fDZ,d[0]*t[0],d[0]*f[0],a.fDZ,c[0]*t[0],c[0]*f[0],a.fDZ,d[0]===c[0]?2:c[1]===d[1]?1:0),w&&b.recalcZ(w),b.calcNormal(),b.addFace4(c[0]*t[l],c[0]*f[l],a.fDZ,d[0]*t[l],d[0]*f[l],a.fDZ,d[1]*t[l],d[1]*f[l],-a.fDZ,c[1]*t[l],c[1]*f[l],-a.fDZ,d[0]===c[0]?1:c[1]===d[1]?2:0),w&&b.recalcZ(w),b.calcNormal());return b.create()}function Rb(a,b){if(!a||!a.fN||
!a.fP)return null;var d=new g.Vector3(a.fP[0],a.fP[1],a.fP[2]);a=new g.Vector3(a.fN[0],a.fN[1],a.fN[2]);a.normalize();var c=1E10;if(b){if(b){var e=null;b instanceof z.Geometry?e=b.tree.collectPolygons([]):b.polygons&&(e=b.polygons);if(null!==e){b=new g.Box3;for(var f=0;f<e.length;++f)for(var h=e[f],l=h.vertices.length,q=0;q<l;++q)b.expandByPoint(h.vertices[q]);e=b}else b.boundingBox||b.computeBoundingBox(),e=b.boundingBox.clone()}else e=null;e&&(c=1E3*e.getSize(new g.Vector3).length())}e=new g.Vector3(-c,
-c/2,0);b=new g.Vector3(0,c,0);f=new g.Vector3(c,-c/2,0);c=new g.Vector3(0,0,-c);h=new g.Geometry;h.vertices.push(e,b,f,c);h.faces.push(new g.Face3(0,2,1));h.faces.push(new g.Face3(0,1,3));h.faces.push(new g.Face3(1,2,3));h.faces.push(new g.Face3(2,0,3));h.lookAt(a);h.computeFaceNormals();e.add(d);b.add(d);f.add(d);c.add(d);return h}function I(a){return a?a instanceof z.Geometry?a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))&&a.count?Math.round(a.count/3):0:a.polygons?
a.polygons.length:a.faces.length:0}function He(a,b){if(0>b)return Ja(a.fNode.fLeft,-10)+Ja(a.fNode.fRight,-10);var d=!1,c=k.createMatrix(a.fNode.fLeftMat);var e=k.createMatrix(a.fNode.fRightMat);0===b?b=4E3:d=!0;c&&-.9>c.determinant()&&k.warn("Axis reflection in left composite shape - not supported");e&&-.9>e.determinant()&&k.warn("Axis reflections in right composite shape - not supported");var f="TGeoHalfSpace"==a.fNode.fLeft._typename?Rb(a.fNode.fLeft):Ja(a.fNode.fLeft,b);if(!f)return null;var h=
I(f),l=0;f._exceed_limit&&(h+=b);if(h<b){var g="TGeoHalfSpace"==a.fNode.fRight._typename?Rb(a.fNode.fRight,f):Ja(a.fNode.fRight,b);l=I(g)}if(h+l>=b||!g)return f.polygons&&(f=z.CreateBufferGeometry(f.polygons),I(f)),c&&f.applyMatrix4(c),f._exceed_limit=!0,f;b=new z.Geometry(f,c,k.CompressComp?0:void 0);e=new z.Geometry(g,e,b.maxid);b.maxid=e.maxid;switch(a.fNode._typename){case "TGeoIntersection":b.direct_intersect(e);break;case "TGeoUnion":b.direct_union(e);break;case "TGeoSubtraction":b.direct_subtract(e);
break;default:k.warn("unsupported bool operation "+a.fNode._typename+", use first geom")}0===I(b)&&(k.warn("Zero faces in comp shape left: "+a.fNode.fLeft._typename+" "+I(f)+" faces right: "+a.fNode.fRight._typename+" "+I(g)+" faces  use first"),b=new z.Geometry(f,c));return d?{polygons:b.toPolygons()}:b.toBufferGeometry()}function Sb(a){function b(a){return void 0===a?"???":a==Math.round(a)&&1E7>a?Math.round(a):e?a.toExponential(4):a.toPrecision(7)}var d=[],c=null;void 0!==a.fVolume?c=a.fVolume.fShape:
void 0!==a.fShape?c=a.fShape:void 0!==a.fShapeBits&&void 0!==a.fShapeId&&(c=a);if(!c)return d.push(a._typename),d;a=Math.max(c.fDX,c.fDY,c.fDZ);var e=1E7<a||1E-7>a;d.push(c._typename);d.push("DX="+b(c.fDX)+" DY="+b(c.fDY)+" DZ="+b(c.fDZ));switch(c._typename){case "TGeoPara":d.push("Alpha="+c.fAlpha+" Phi="+c.fPhi+" Theta="+c.fTheta);break;case "TGeoTrd2":d.push("Dy1="+b(c.fDy1)+" Dy2="+b(c.fDy1));case "TGeoTrd1":d.push("Dx1="+b(c.fDx1)+" Dx2="+b(c.fDx1));break;case "TGeoSphere":d.push("Rmin="+b(c.fRmin)+
" Rmax="+b(c.fRmax));d.push("Phi1="+c.fPhi1+" Phi2="+c.fPhi2);d.push("Theta1="+c.fTheta1+" Theta2="+c.fTheta2);break;case "TGeoConeSeg":d.push("Phi1="+c.fPhi1+" Phi2="+c.fPhi2);case "TGeoCone":d.push("Rmin1="+b(c.fRmin1)+" Rmax1="+b(c.fRmax1));d.push("Rmin2="+b(c.fRmin2)+" Rmax2="+b(c.fRmax2));break;case "TGeoCtub":case "TGeoTubeSeg":d.push("Phi1="+c.fPhi1+" Phi2="+c.fPhi2);case "TGeoEltu":case "TGeoTube":d.push("Rmin="+b(c.fRmin)+" Rmax="+b(c.fRmax));break;case "TGeoTorus":d.push("Rmin="+b(c.fRmin)+
" Rmax="+b(c.fRmax));d.push("Phi1="+c.fPhi1+" Dphi="+c.fDphi);break;case "TGeoParaboloid":d.push("Rlo="+b(c.fRlo)+" Rhi="+b(c.fRhi));d.push("A="+b(c.fA)+" B="+b(c.fB));break;case "TGeoHype":d.push("Rmin="+b(c.fRmin)+" Rmax="+b(c.fRmax));d.push("StIn="+b(c.fStIn)+" StOut="+b(c.fStOut));break;case "TGeoScaledShape":d=Sb(c.fShape),c.fScale&&d.unshift("Scale X="+c.fScale.fScale[0]+" Y="+c.fScale.fScale[1]+" Z="+c.fScale.fScale[2])}return d}function Tb(a){var b=new g.Matrix4;a.updateMatrixWorld();a.matrixWorldInverse.getInverse(a.matrixWorld);
b.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);return b}function v(a,b){this.toplevel=!0;this.name_prefix="";this.maxdepth=1;this.vislevel=4;this.maxnodes=1E4;a?(a.$geoh&&(this.toplevel=!1),this.createClones(a)):b&&(this.nodes=b)}function Ub(a,b){var d=new g.Vector3(1,1,-1);if(void 0===a.geomZ)if("BufferGeometry"==a.geom.type){var c=a.geom.getAttribute("position").array,e=a.geom.getAttribute("normal").array,f=a.geom.getIndex();if(f){f=f.array;var h=a.geom.drawRange.start,l=a.geom.drawRange.count;
h+l>f.length&&(l=f.length-h);for(var q=new Float32Array(3*l),m=new Float32Array(3*l),k=0;k<l;++k){var t=f[h+k];(0>t||3*t>=c.length)&&console.log("strange index",3*t,c.length);q[3*k]=c[3*t];q[3*k+1]=c[3*t+1];q[3*k+2]=c[3*t+2];m[3*k]=e[3*t];m[3*k+1]=e[3*t+1];m[3*k+2]=e[3*t+2]}c=q;e=m}f=c.length;l=0;q=new Float32Array(f);m=new Float32Array(f);for(h=0;h<f;h+=3)q[h]=c[h+l],q[h+1]=c[h+1+l],q[h+2]=-c[h+2+l],m[h]=e[h+l],m[h+1]=e[h+1+l],m[h+2]=-e[h+2+l],l+=3,6===l&&(l=-3);a.geomZ=new g.BufferGeometry;a.geomZ.setAttribute("position",
new g.BufferAttribute(q,3));a.geomZ.setAttribute("normal",new g.BufferAttribute(m,3))}else for(a.geomZ=a.geom.clone(),a.geomZ.scale(d.x,d.y,d.z),f=0;f<a.geomZ.faces.length;)c=geom.faces[f++],e=c.b,c.b=c.c,c.c=e;a=new g.Mesh(a.geomZ,b);a.scale.copy(d);a.updateMatrix();a._flippedMesh=!0;return a}function Vb(a,b,d){if(!a||!a.geometry)return b;b||(b=new g.Box3,b.makeEmpty());d||a.updateMatrixWorld();var c=new g.Vector3,e=a.geometry;if(e.isGeometry){e=e.vertices;for(var f=0,h=e.length;f<h;f++)c.copy(e[f]),
d||c.applyMatrix4(a.matrixWorld),b.expandByPoint(c)}else if(e.isBufferGeometry&&(e=e.attributes.position,void 0!==e))for(f=0,h=e.count;f<h;f++)c.fromBufferAttribute(e,f),d||c.applyMatrix4(a.matrixWorld),b.expandByPoint(c);return b}var k={GradPerSegm:6,CompressComp:!0,CompLimit:20};k.BITS={kVisOverride:JSROOT.BIT(0),kVisNone:JSROOT.BIT(1),kVisThis:JSROOT.BIT(2),kVisDaughters:JSROOT.BIT(3),kVisOneLevel:JSROOT.BIT(4),kVisStreamed:JSROOT.BIT(5),kVisTouched:JSROOT.BIT(6),kVisOnScreen:JSROOT.BIT(7),kVisContainers:JSROOT.BIT(12),
kVisOnly:JSROOT.BIT(13),kVisBranch:JSROOT.BIT(14),kVisRaytrace:JSROOT.BIT(15)};k.TestBit=function(a,b){a=a.fGeoAtt;return void 0===a?!1:0!==(a&b)};k.SetBit=function(a,b,d){void 0!==a.fGeoAtt&&(a.fGeoAtt=d?a.fGeoAtt|b:a.fGeoAtt&~b)};k.ToggleBit=function(a,b){void 0!==a.fGeoAtt&&(a.fGeoAtt^=b&16777215)};k.setInvisibleAll=function(a,b){void 0===b&&(b=!0);k.SetBit(a,k.BITS.kVisThis,!b);if(a.fNodes)for(var d=0;d<a.fNodes.arr.length;++d)k.SetBit(a.fNodes.arr[d].fVolume,k.BITS.kVisThis,!b)};k.warn=function(a){void 0===
k._warn_msgs&&(k._warn_msgs={});void 0===k._warn_msgs[a]&&(k._warn_msgs[a]=!0,console.warn(a))};k.getNodeKind=function(a){return void 0===a||null===a||"object"!==typeof a?-1:"fShape"in a&&"fTrans"in a?1:0};k.countNumShapes=function(a){return a?"TGeoCompositeShape"!==a._typename?1:k.countNumShapes(a.fNode.fLeft)+k.countNumShapes(a.fNode.fRight):0};k.produceNormal=function(a,b,d,c,e,f,h,l,q){a=new g.Vector3(a,b,d);c=new g.Vector3(c,e,f);h=new g.Vector3(h,l,q);l=new g.Vector3;q=new g.Vector3;l.subVectors(h,
c);q.subVectors(a,c);l.cross(q);return l};A.prototype.addFace3=function(a,b,d,c,e,f,h,l,g){var m=this.indx,k=this.pos;k[m]=a;k[m+1]=b;k[m+2]=d;k[m+3]=c;k[m+4]=e;k[m+5]=f;k[m+6]=h;k[m+7]=l;k[m+8]=g;this.last4=!1;this.indx=m+9};A.prototype.startPolygon=function(){};A.prototype.stopPolygon=function(){};A.prototype.addFace4=function(a,b,d,c,e,f,h,l,g,m,k,t,u){var q=this.indx,r=this.pos;1!==u&&(r[q]=a,r[q+1]=b,r[q+2]=d,r[q+3]=c,r[q+4]=e,r[q+5]=f,r[q+6]=h,r[q+7]=l,r[q+8]=g,q+=9);2!==u&&(r[q]=a,r[q+1]=b,
r[q+2]=d,r[q+3]=h,r[q+4]=l,r[q+5]=g,r[q+6]=m,r[q+7]=k,r[q+8]=t,q+=9);this.last4=q!==this.indx+9;this.indx=q};A.prototype.setNormal4=function(a,b,d,c,e,f,h,l,q,m,g,k,u){if(this.last4&&u)return console.error("missmatch between addFace4 and setNormal4 calls");var w=this.indx-(this.last4?18:9),r=this.norm;1!==u&&(r[w]=a,r[w+1]=b,r[w+2]=d,r[w+3]=c,r[w+4]=e,r[w+5]=f,r[w+6]=h,r[w+7]=l,r[w+8]=q,w+=9);2!==u&&(r[w]=a,r[w+1]=b,r[w+2]=d,r[w+3]=h,r[w+4]=l,r[w+5]=q,r[w+6]=m,r[w+7]=g,r[w+8]=k)};A.prototype.recalcZ=
function(a){for(var b=this.pos,d=this.indx,c=d-(this.last4?18:9);c<d;)b[c+2]=a(b[c],b[c+1],b[c+2]),c+=3};A.prototype.calcNormal=function(){this.cb||(this.pA=new g.Vector3,this.pB=new g.Vector3,this.pC=new g.Vector3,this.cb=new g.Vector3,this.ab=new g.Vector3);this.pA.fromArray(this.pos,this.indx-9);this.pB.fromArray(this.pos,this.indx-6);this.pC.fromArray(this.pos,this.indx-3);this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.setNormal(this.cb.x,this.cb.y,
this.cb.z)};A.prototype.setNormal=function(a,b,d){var c=this.indx-9,e=this.norm;e[c]=e[c+3]=e[c+6]=a;e[c+1]=e[c+4]=e[c+7]=b;e[c+2]=e[c+5]=e[c+8]=d;this.last4&&(c-=9,e[c]=e[c+3]=e[c+6]=a,e[c+1]=e[c+4]=e[c+7]=b,e[c+2]=e[c+5]=e[c+8]=d)};A.prototype.setNormal_12_34=function(a,b,d,c,e,f,h){void 0===h&&(h=0);var l=this.indx-(0<h?9:18),g=this.norm;1!==h&&(g[l]=a,g[l+1]=b,g[l+2]=d,g[l+3]=a,g[l+4]=b,g[l+5]=d,g[l+6]=c,g[l+7]=e,g[l+8]=f,l+=9);2!==h&&(g[l]=a,g[l+1]=b,g[l+2]=d,g[l+3]=c,g[l+4]=e,g[l+5]=f,g[l+6]=
c,g[l+7]=e,g[l+8]=f)};A.prototype.create=function(){this.nfaces!==this.indx/9&&console.error("Mismatch with created "+this.nfaces+" and filled "+this.indx/9+" number of faces");var a=new g.BufferGeometry;a.setAttribute("position",new g.BufferAttribute(this.pos,3));a.setAttribute("normal",new g.BufferAttribute(this.norm,3));return a};B.prototype.startPolygon=function(a){this.multi=1;this.mnormal=a};B.prototype.stopPolygon=function(){this.multi&&(this.multi=0,console.error("Polygon should be already closed at this moment"))};
B.prototype.addFace3=function(a,b,d,c,e,f,h,l,g){this.addFace4(a,b,d,c,e,f,h,l,g,h,l,g,2)};B.prototype.addFace4=function(a,b,d,c,e,f,h,l,g,m,k,t,u){void 0===u&&(u=0);this.v1=new z.Vertex(a,b,d,0,0,0);this.v2=1===u?null:new z.Vertex(c,e,f,0,0,0);this.v3=new z.Vertex(h,l,g,0,0,0);this.v4=2===u?null:new z.Vertex(m,k,t,0,0,0);this.reduce=u;if(this.multi)2!==u&&console.error("polygon not supported for not-reduced faces"),1===this.multi++?(u=new z.Polygon,u.vertices.push(this.mnormal?this.v2:this.v3),this.polygons.push(u)):
(u=this.polygons[this.polygons.length-1],1E-12<(this.mnormal?this.v2:this.v3).diff(this.mnormal?u.vertices[u.vertices.length-1]:u.vertices[0])&&console.error("vertex missmatch when building polygon")),1E-12>(this.mnormal?this.v3:this.v2).diff(this.mnormal?u.vertices[0]:u.vertices[u.vertices.length-1])?this.multi=0:this.mnormal?u.vertices.push(this.v3):u.vertices.unshift(this.v2);else{a=new z.Polygon;switch(u){case 0:a.vertices.push(this.v1,this.v2,this.v3,this.v4);break;case 1:a.vertices.push(this.v1,
this.v3,this.v4);break;case 2:a.vertices.push(this.v1,this.v2,this.v3)}this.polygons.push(a)}};B.prototype.setNormal4=function(a,b,d,c,e,f,h,l,g,m,k,t){this.v1.setnormal(a,b,d);this.v2&&this.v2.setnormal(c,e,f);this.v3.setnormal(h,l,g);this.v4&&this.v4.setnormal(m,k,t)};B.prototype.setNormal_12_34=function(a,b,d,c,e,f){this.v1.setnormal(a,b,d);this.v2&&this.v2.setnormal(a,b,d);this.v3.setnormal(c,e,f);this.v4&&this.v4.setnormal(c,e,f)};B.prototype.calcNormal=function(){this.cb||(this.pA=new g.Vector3,
this.pB=new g.Vector3,this.pC=new g.Vector3,this.cb=new g.Vector3,this.ab=new g.Vector3);this.pA.set(this.v1.x,this.v1.y,this.v1.z);1!==this.reduce?(this.pB.set(this.v2.x,this.v2.y,this.v2.z),this.pC.set(this.v3.x,this.v3.y,this.v3.z)):(this.pB.set(this.v3.x,this.v3.y,this.v3.z),this.pC.set(this.v4.x,this.v4.y,this.v4.z));this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.setNormal(this.cb.x,this.cb.y,this.cb.z)};B.prototype.setNormal=function(a,b,
d){this.v1.setnormal(a,b,d);this.v2&&this.v2.setnormal(a,b,d);this.v3.setnormal(a,b,d);this.v4&&this.v4.setnormal(a,b,d)};B.prototype.recalcZ=function(a){this.v1.z=a(this.v1.x,this.v1.y,this.v1.z);this.v2&&(this.v2.z=a(this.v2.x,this.v2.y,this.v2.z));this.v3.z=a(this.v3.x,this.v3.y,this.v3.z);this.v4&&(this.v4.z=a(this.v4.x,this.v4.y,this.v4.z))};B.prototype.create=function(){return{polygons:this.polygons}};k.createMatrix=function(a){if(!a)return null;switch(a._typename){case "TGeoTranslation":var b=
a.fTranslation;break;case "TGeoRotation":var d=a.fRotationMatrix;break;case "TGeoScale":var c=a.fScale;break;case "TGeoGenTrans":c=a.fScale;case "TGeoCombiTrans":b=a.fTranslation;a.fRotation&&(d=a.fRotation.fRotationMatrix);break;case "TGeoHMatrix":b=a.fTranslation;d=a.fRotationMatrix;c=a.fScale;break;case "TGeoIdentity":break;default:console.warn("unsupported matrix "+a._typename)}if(!b&&!d&&!c)return null;a=new g.Matrix4;d&&a.set(d[0],d[1],d[2],0,d[3],d[4],d[5],0,d[6],d[7],d[8],0,0,0,0,1);b&&a.setPosition(b[0],
b[1],b[2]);c&&a.scale(new g.Vector3(c[0],c[1],c[2]));return a};k.getNodeMatrix=function(a,b){var d=null;if(1===a)d=new g.Matrix4,b.fTrans&&(d.set(b.fTrans[0],b.fTrans[4],b.fTrans[8],0,b.fTrans[1],b.fTrans[5],b.fTrans[9],0,b.fTrans[2],b.fTrans[6],b.fTrans[10],0,0,0,0,1),d.setPosition(b.fTrans[12],b.fTrans[13],b.fTrans[14]));else if(b.fMatrix)d=k.createMatrix(b.fMatrix);else if("TGeoNodeOffset"==b._typename&&b.fFinder)switch(a=JSROOT.BIT(14),0!==(b.fFinder.fBits&a)&&k.warn("Unsupported reflected pattern "+
b.fFinder._typename),b.fFinder._typename){case "TGeoPatternX":case "TGeoPatternY":case "TGeoPatternZ":case "TGeoPatternParaX":case "TGeoPatternParaY":case "TGeoPatternParaZ":a=b.fFinder.fStart+(b.fIndex+.5)*b.fFinder.fStep;d=new g.Matrix4;switch(b.fFinder._typename[b.fFinder._typename.length-1]){case "X":d.setPosition(a,0,0);break;case "Y":d.setPosition(0,a,0);break;case "Z":d.setPosition(0,0,a)}break;case "TGeoPatternCylPhi":d=Math.PI/180*(b.fFinder.fStart+(b.fIndex+.5)*b.fFinder.fStep);b=Math.cos(d);
a=Math.sin(d);d=new g.Matrix4;d.set(b,-a,0,0,a,b,0,0,0,0,1,0,0,0,0,1);break;case "TGeoPatternCylR":d=new g.Matrix4;break;case "TGeoPatternTrapZ":a=b.fFinder.fStart+(b.fIndex+.5)*b.fFinder.fStep;d=new g.Matrix4;d.setPosition(b.fFinder.fTxz*a,b.fFinder.fTyz*a,a);break;default:k.warn("Unsupported pattern type "+b.fFinder._typename)}return d};k.numGeometryFaces=function(a){return a?a instanceof z.Geometry?a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))&&a.count?Math.round(a.count/
3):0:a.polygons?a.polygons.length:a.faces.length:0};k.numGeometryVertices=function(a){return a?a instanceof z.Geometry?3*a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))?a.count:0:a.polygons?4*a.polygons.length:a.vertices.length:0};var Ja=function(a,b){void 0===b&&(b=0);try{switch(a._typename){case "TGeoBBox":if(0>b)var d=12;else{var c=a.fDX,e=a.fDY,f=a.fDZ,h=b?new B:new A(12);h.addFace4(c,e,f,c,-e,f,c,-e,-f,c,e,-f);h.setNormal(1,0,0);h.addFace4(-c,e,-f,-c,-e,-f,-c,-e,
f,-c,e,f);h.setNormal(-1,0,0);h.addFace4(-c,e,-f,-c,e,f,c,e,f,c,e,-f);h.setNormal(0,1,0);h.addFace4(-c,-e,f,-c,-e,-f,c,-e,-f,c,-e,f);h.setNormal(0,-1,0);h.addFace4(-c,e,f,-c,-e,f,c,-e,f,c,e,f);h.setNormal(0,0,1);h.addFace4(c,e,-f,c,-e,-f,-c,-e,-f,-c,e,-f);h.setNormal(0,0,-1);d=h.create()}return d;case "TGeoPara":if(0>b)var l=12;else{var q=a.fTxy,m=a.fTxz,X=a.fTyz;l=Sd([-a.fZ*m-q*a.fY-a.fX,-a.fY-a.fZ*X,-a.fZ,-a.fZ*m+q*a.fY-a.fX,a.fY-a.fZ*X,-a.fZ,-a.fZ*m+q*a.fY+a.fX,a.fY-a.fZ*X,-a.fZ,-a.fZ*m-q*a.fY+
a.fX,-a.fY-a.fZ*X,-a.fZ,a.fZ*m-q*a.fY-a.fX,-a.fY+a.fZ*X,a.fZ,a.fZ*m+q*a.fY-a.fX,a.fY+a.fZ*X,a.fZ,a.fZ*m+q*a.fY+a.fX,a.fY+a.fZ*X,a.fZ,a.fZ*m-q*a.fY+a.fX,-a.fY+a.fZ*X,a.fZ],b)}return l;case "TGeoTrd1":case "TGeoTrd2":if(0>b)var t=12;else{var u;if("TGeoTrd1"==a._typename)var w=u=a.fDY;else w=a.fDy1,u=a.fDy2;t=Sd([-a.fDx1,w,-a.fDZ,a.fDx1,w,-a.fDZ,a.fDx1,-w,-a.fDZ,-a.fDx1,-w,-a.fDZ,-a.fDx2,u,a.fDZ,a.fDx2,u,a.fDZ,a.fDx2,-u,a.fDZ,-a.fDx2,-u,a.fDZ],b)}return t;case "TGeoArb8":case "TGeoTrap":case "TGeoGtra":var r=
b;if(0>r)var pa=12;else{for(var p=[a.fXY[0][0],a.fXY[0][1],-a.fDZ,a.fXY[1][0],a.fXY[1][1],-a.fDZ,a.fXY[2][0],a.fXY[2][1],-a.fDZ,a.fXY[3][0],a.fXY[3][1],-a.fDZ,a.fXY[4][0],a.fXY[4][1],a.fDZ,a.fXY[5][0],a.fXY[5][1],a.fDZ,a.fXY[6][0],a.fXY[6][1],a.fDZ,a.fXY[7][0],a.fXY[7][1],a.fDZ],n=[4,7,6,6,5,4,3,7,4,4,0,3,5,1,0,0,4,5,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1],v=0;v<p.length;v+=p.length/2)for(var z=v;z<v+p.length/2-3;z+=3)for(var I=z+3;I<v+p.length/2;I+=3)if(p[z]===p[I]&&p[z+1]===p[I+1]&&p[z+2]===p[I+2])for(var yc=
0;yc<n.length;++yc)n[yc]===I/3&&(n[yc]=z/3);for(var zc=[],Rb=0,C=0;C<n.length;C+=3){var Sb=100*n[C]+10*n[C+1]+n[C+2],Tb=100*n[C+1]+10*n[C+2]+n[C],Ub=100*n[C+2]+10*n[C]+n[C+1];n[C]==n[C+1]||n[C]==n[C+2]||n[C+1]==n[C+2]||0<=zc.indexOf(Sb)||0<=zc.indexOf(Tb)||0<=zc.indexOf(Ub)?n[C]=n[C+1]=n[C+2]=-1:(zc.push(Sb,Tb,Ub),Rb++)}for(var Ta=r?new B:new A(Rb),qa=0;qa<n.length;qa+=6){var ja=3*n[qa],wa=3*n[qa+1],xa=3*n[qa+2],Ka=3*n[qa+3],ya=3*n[qa+4],nb=3*n[qa+5],Ua=null;if(0<=ja&&0<=Ka&&r)if(0===qa)Ua=new g.Vector3(0,
0,1);else if(30===qa)Ua=new g.Vector3(0,0,-1);else{var vd=k.produceNormal(p[ja],p[ja+1],p[ja+2],p[wa],p[wa+1],p[wa+2],p[xa],p[xa+1],p[xa+2]);vd.normalize();var Vb=k.produceNormal(p[Ka],p[Ka+1],p[Ka+2],p[ya],p[ya+1],p[ya+2],p[nb],p[nb+1],p[nb+2]);Vb.normalize();1E-12>vd.distanceToSquared(Vb)&&(Ua=vd)}null!==Ua?(Ta.addFace4(p[ja],p[ja+1],p[ja+2],p[wa],p[wa+1],p[wa+2],p[xa],p[xa+1],p[xa+2],p[ya],p[ya+1],p[ya+2]),Ta.setNormal(Ua.x,Ua.y,Ua.z)):(0<=ja&&(Ta.addFace3(p[ja],p[ja+1],p[ja+2],p[wa],p[wa+1],p[wa+
2],p[xa],p[xa+1],p[xa+2]),Ta.calcNormal()),0<=Ka&&(Ta.addFace3(p[Ka],p[Ka+1],p[Ka+2],p[ya],p[ya+1],p[ya+2],p[nb],p[nb+1],p[nb+2]),Ta.calcNormal()))}pa=Ta.create()}return pa;case "TGeoSphere":var Ac=b,y=[a.fRmax,a.fRmin],Ie=a.fPhi1,wd=a.fPhi2-a.fPhi1,Je=a.fTheta1,Ke=a.fTheta2-a.fTheta1,G=a.fNseg,K=a.fNz,La=0>=y[1];if(0<Ac){var xd=(La?2:4)*G*K/Ac;1<xd&&(G=Math.max(4,Math.floor(G/Math.sqrt(xd))),K=Math.max(4,Math.floor(K/Math.sqrt(xd))))}var Bc=G*K*2,Cc=2*G,Dc=2*G,Ud=360===wd?0:K*(La?2:4);La&&(Dc=Cc=
G);if(0>Ac)var Vd=Bc*(La?1:2)+Cc+Dc+Ud;else{for(var L=new Float32Array(G+1),M=new Float32Array(G+1),x=new Float32Array(K+1),N=new Float32Array(K+1),Wb=0;Wb<=K;++Wb){var Wd=(Je+Ke/K*Wb)*Math.PI/180;x[Wb]=Math.sin(Wd);N[Wb]=Math.cos(Wd)}for(var Xb=0;Xb<=G;++Xb){var Xd=(Ie+wd/G*Xb)*Math.PI/180;L[Xb]=Math.sin(Xd);M[Xb]=Math.cos(Xd)}1E-10>=Math.abs(x[0])&&(Bc-=G,Cc=0);1E-10>=Math.abs(x[K])&&(Bc-=G,Dc=0);for(var Le=Bc*(La?1:2)+Cc+Dc+Ud,Va=Ac?new B:new A(Le),ob=0;2>ob&&(1!==ob||!La);++ob)for(var aa=y[ob],
ba=0===ob?1:-1,Yd=1-ob,Me=1-Yd,Ec=0;Ec<K;++Ec){var Y=Ec+Yd,Z=Ec+Me,Fc=0;1E-10>=Math.abs(x[Y])?Fc=1:1E-10>=Math.abs(x[Z])&&(Fc=2);for(var E=0;E<G;++E)Va.addFace4(aa*x[Y]*M[E],aa*x[Y]*L[E],aa*N[Y],aa*x[Y]*M[E+1],aa*x[Y]*L[E+1],aa*N[Y],aa*x[Z]*M[E+1],aa*x[Z]*L[E+1],aa*N[Z],aa*x[Z]*M[E],aa*x[Z]*L[E],aa*N[Z],Fc),Va.setNormal4(ba*x[Y]*M[E],ba*x[Y]*L[E],ba*N[Y],ba*x[Y]*M[E+1],ba*x[Y]*L[E+1],ba*N[Y],ba*x[Z]*M[E+1],ba*x[Z]*L[E+1],ba*N[Z],ba*x[Z]*M[E],ba*x[Z]*L[E],ba*N[Z],Fc)}for(var pb=0;pb<=K;pb+=K)if(1E-10<=
Math.abs(x[pb]))for(var Ma=x[pb],Gc=N[pb],Yb=0===pb?0:1,Hc=1-Yb,ra=0;ra<G;++ra)Va.addFace4(y[1]*Ma*M[ra+Yb],y[1]*Ma*L[ra+Yb],y[1]*Gc,y[0]*Ma*M[ra+Yb],y[0]*Ma*L[ra+Yb],y[0]*Gc,y[0]*Ma*M[ra+Hc],y[0]*Ma*L[ra+Hc],y[0]*Gc,y[1]*Ma*M[ra+Hc],y[1]*Ma*L[ra+Hc],y[1]*Gc,La?2:0),Va.calcNormal();if(360>wd)for(var Zb=0;Zb<=G;Zb+=G)for(var Ic=L[Zb],Jc=M[Zb],Wa=0===Zb?1:0,qb=1-Wa,O=0;O<K;++O)Va.addFace4(y[1]*x[O+Wa]*Jc,y[1]*x[O+Wa]*Ic,y[1]*N[O+Wa],y[0]*x[O+Wa]*Jc,y[0]*x[O+Wa]*Ic,y[0]*N[O+Wa],y[0]*x[O+qb]*Jc,y[0]*
x[O+qb]*Ic,y[0]*N[O+qb],y[1]*x[O+qb]*Jc,y[1]*x[O+qb]*Ic,y[1]*N[O+qb],La?2:0),Va.calcNormal();Vd=Va.create()}return Vd;case "TGeoCone":case "TGeoConeSeg":case "TGeoTube":case "TGeoTubeSeg":case "TGeoCtub":return Td(a,b);case "TGeoEltu":var Zd=b,Na=Math.max(4,Math.round(360/k.GradPerSegm));if(0>Zd)var $d=4*Na;else{for(var Oa=new Float32Array(Na+1),Pa=new Float32Array(Na+1),$b=0;$b<=Na;++$b){var ae=$b/Na*2*Math.PI;Oa[$b]=a.fRmin*Math.cos(ae);Pa[$b]=a.fRmax*Math.sin(ae)}for(var ac=Zd?new B:new A(4*Na),
be=1,ce=0,rb=1,sb=0,ca=0;ca<Na;++ca){ac.addFace4(Oa[ca],Pa[ca],+a.fDZ,Oa[ca],Pa[ca],-a.fDZ,Oa[ca+1],Pa[ca+1],-a.fDZ,Oa[ca+1],Pa[ca+1],a.fDZ);be=rb;ce=sb;rb=Oa[ca+1]*a.fRmax/a.fRmin;sb=Pa[ca+1]*a.fRmin/a.fRmax;var de=Math.sqrt(rb*rb+sb*sb);rb/=de;sb/=de;ac.setNormal_12_34(be,ce,0,rb,sb,0)}for(var bc=0;2>bc;++bc)for(var Kc=0===bc?1:-1,ee=bc,fe=1-bc,tb=0;tb<Na;++tb)ac.addFace3(0,0,Kc*a.fDZ,Oa[tb+ee],Pa[tb+ee],Kc*a.fDZ,Oa[tb+fe],Pa[tb+fe],Kc*a.fDZ),ac.setNormal(0,0,Kc);$d=ac.create()}return $d;case "TGeoTorus":var ub=
b,D=a.fR,ka=Math.max(6,Math.round(360/k.GradPerSegm)),la=Math.max(8,Math.round(a.fDphi/k.GradPerSegm)),vb=(0<a.fRmin?4:2)*ka*(la+(360!==a.fDphi?1:0));if(0>ub)var ge=vb;else{0<ub&&vb>ub&&(ka=Math.floor(ka/Math.sqrt(vb/ub)),la=Math.floor(la/Math.sqrt(vb/ub)),vb=(0<a.fRmin?4:2)*ka*(la+(360!==a.fDphi?1:0)));for(var za=new Float32Array(ka+1),H=new Float32Array(ka+1),da=new Float32Array(la+1),ea=new Float32Array(la+1),wb=0;wb<=ka;++wb)za[wb]=Math.sin(wb/ka*2*Math.PI),H[wb]=Math.cos(wb/ka*2*Math.PI);for(var cc=
0;cc<=la;++cc){var he=(a.fPhi1+a.fDphi*cc/la)/180*Math.PI;da[cc]=Math.sin(he);ea[cc]=Math.cos(he)}for(var dc=ub?new B:new A(vb),Xa=new g.Vector3,Ya=new g.Vector3,Za=new g.Vector3,$a=new g.Vector3,Lc=new g.Vector3,Mc=new g.Vector3,Nc=new g.Vector3,Oc=new g.Vector3,Pc=new g.Vector3,Qc=new g.Vector3,xb=0;2>xb&&!(0<xb&&0>=a.fRmin);++xb)for(var fa=0<xb?a.fRmin:a.fRmax,ie=1-xb,Ne=1-ie,ha=0<xb?-1:1,Rc=0;Rc<la;++Rc){var yb=Rc+ie,zb=Rc+Ne;Pc.x=D*ea[yb];Pc.y=D*da[yb];Qc.x=D*ea[zb];Qc.y=D*da[zb];for(var P=0;P<
ka;++P)Xa.x=(D+fa*H[P])*ea[yb],Xa.y=(D+fa*H[P])*da[yb],Xa.z=fa*za[P],Ya.x=(D+fa*H[P+1])*ea[yb],Ya.y=(D+fa*H[P+1])*da[yb],Ya.z=fa*za[P+1],Za.x=(D+fa*H[P+1])*ea[zb],Za.y=(D+fa*H[P+1])*da[zb],Za.z=fa*za[P+1],$a.x=(D+fa*H[P])*ea[zb],$a.y=(D+fa*H[P])*da[zb],$a.z=fa*za[P],dc.addFace4(Xa.x,Xa.y,Xa.z,Ya.x,Ya.y,Ya.z,Za.x,Za.y,Za.z,$a.x,$a.y,$a.z),Lc.subVectors(Xa,Pc).normalize(),Mc.subVectors(Ya,Pc).normalize(),Nc.subVectors(Za,Qc).normalize(),Oc.subVectors($a,Qc).normalize(),dc.setNormal4(ha*Lc.x,ha*Lc.y,
ha*Lc.z,ha*Mc.x,ha*Mc.y,ha*Mc.z,ha*Nc.x,ha*Nc.y,ha*Nc.z,ha*Oc.x,ha*Oc.y,ha*Oc.z)}if(360!==a.fDphi)for(var Q=0;Q<=la;Q+=la)for(var Ab=a.fRmax,Bb=a.fRmin,ab=0<Q?0:1,Cb=1-ab,Oe=0<a.fRmin?0:1,je=0<Q?1:-1,R=0;R<ka;++R)dc.addFace4((D+Ab*H[R+ab])*ea[Q],(D+Ab*H[R+ab])*da[Q],Ab*za[R+ab],(D+Bb*H[R+ab])*ea[Q],(D+Bb*H[R+ab])*da[Q],Bb*za[R+ab],(D+Bb*H[R+Cb])*ea[Q],(D+Bb*H[R+Cb])*da[Q],Bb*za[R+Cb],(D+Ab*H[R+Cb])*ea[Q],(D+Ab*H[R+Cb])*da[Q],Ab*za[R+Cb],Oe),dc.setNormal(-je*da[Q],je*ea[Q],0);ge=dc.create()}return ge;
case "TGeoPcon":case "TGeoPgon":var ke=b,Pe=a.fPhi1,Sc=a.fDphi,J=60,bb=1;"TGeoPgon"==a._typename?(J=a.fNedges,bb=1/Math.cos(Math.PI/180*Sc/J/2)):J=Math.max(5,Math.round(Sc/k.GradPerSegm));for(var yd=new Int16Array(2*a.fNz),le=0,cb=!1,zd=0;zd<a.fNz;++zd)0<a.fRmin[zd]&&(cb=!0);if(0>ke)var me=(cb?4:2)*J*(a.fNz-1);else{for(var Aa=360===Sc?null:[],db=0;2>db;++db)for(var Tc=0===db?"fRmax":"fRmin",S=0;S<a.fNz;++S){var Ad=a.fZ[S],Db=a[Tc][S];yd[2*S+db]=0;0<S&&S<a.fNz-1&&(a.fZ[S-1]===Ad&&a[Tc][S-1]===Db||
a[Tc][S+1]===Db&&a[Tc][S-1]===Db)||(0<S&&(0===db||cb)&&(yd[2*S+db]=1,le++),null!==Aa&&(0===db?Aa.push(new g.Vector2(bb*Db,Ad)):Db<a.fRmax[S]&&Aa.unshift(new g.Vector2(bb*Db,Ad))))}var Uc=le*J*2;a.fRmin[0]!==a.fRmax[0]&&(Uc+=J*(cb?2:1));a.fRmin[a.fNz-1]!==a.fRmax[a.fNz-1]&&(Uc+=J*(cb?2:1));var ma=null;if(null!==Aa){if(Aa.length===2*a.fNz){ma=[];for(var Qa=a.fNz-1;0<Qa;--Qa)if(a.fZ[Qa]!==a.fZ[Qa-1]){var Bd=2*a.fNz-1-Qa;ma.push([Bd,Qa-1,Qa]);ma.push([Bd,Bd+1,Qa-1])}}else ma=g.ShapeUtils.triangulateShape(Aa,
[]);Uc+=2*ma.length}for(var ne=Pe*Math.PI/180,oe=Sc/J*Math.PI/180,T=new Float32Array(J+1),U=new Float32Array(J+1),Eb=0;Eb<=J;++Eb)U[Eb]=Math.cos(ne+Eb*oe),T[Eb]=Math.sin(ne+Eb*oe);for(var Ba=ke?new B:new A(Uc),eb=0;2>eb;++eb)for(var pe=0===eb?"fRmax":"fRmin",Vc=a.fZ[0],fb=bb*a[pe][0],Fb=1-eb,Gb=eb,ec=0;ec<a.fNz;++ec)if(0!==yd[2*ec+eb]){var Wc=a.fZ[ec],gb=bb*a[pe][ec],Hb=1,Xc=0;if(gb!==fb){var qe=Math.atan2(gb-fb,Wc-Vc);Hb=Math.cos(qe);Xc=Math.sin(qe)}0<eb&&(Hb*=-1,Xc*=-1);for(var V=0;V<J;++V)Ba.addFace4(fb*
U[V+Fb],fb*T[V+Fb],Vc,gb*U[V+Fb],gb*T[V+Fb],Wc,gb*U[V+Gb],gb*T[V+Gb],Wc,fb*U[V+Gb],fb*T[V+Gb],Vc),Ba.setNormal_12_34(Hb*U[V+Fb],Hb*T[V+Fb],Xc,Hb*U[V+Gb],Hb*T[V+Gb],Xc);Vc=Wc;fb=gb}for(var Ra=0;Ra<a.fNz;Ra+=a.fNz-1){var fc=bb*a.fRmin[Ra],gc=bb*a.fRmax[Ra];if(fc!==gc){var Yc=a.fZ[Ra],hc=0===Ra?1:0,Zc=1-hc,Qe=0===Ra?-1:1;cb||ma||Ba.startPolygon(0<Ra);for(var sa=0;sa<J;++sa)Ba.addFace4(fc*U[sa+hc],fc*T[sa+hc],Yc,gc*U[sa+hc],gc*T[sa+hc],Yc,gc*U[sa+Zc],gc*T[sa+Zc],Yc,fc*U[sa+Zc],fc*T[sa+Zc],Yc,cb?0:2),
Ba.setNormal(0,0,Qe);Ba.stopPolygon()}}if(ma)for(var Ca=0;Ca<=J;Ca+=J)for(var re=0===Ca?1:2,Re=3-re,ic=0;ic<ma.length;++ic){var Cd=Aa[ma[ic][0]],Dd=Aa[ma[ic][re]],Ed=Aa[ma[ic][Re]];Ba.addFace3(Cd.x*U[Ca],Cd.x*T[Ca],Cd.y,Dd.x*U[Ca],Dd.x*T[Ca],Dd.y,Ed.x*U[Ca],Ed.x*T[Ca],Ed.y);Ba.calcNormal()}me=Ba.create()}return me;case "TGeoXtru":var se=b,Fd=(a.fNz-1)*a.fNvert*2;if(0>se)var te=Fd+3*a.fNvert;else{for(var hb=[],$c=0;$c<a.fNvert;++$c)hb.push(new g.Vector2(a.fX[$c],a.fY[$c]));var jc=g.ShapeUtils.triangulateShape(hb,
[]);jc.length<hb.length-2?(k.warn("Problem with XTRU shape "+a.fName+" with "+hb.length+" vertices"),jc=[]):Fd+=2*jc.length;for(var kc=se?new B:new A(Fd),ta=0;ta<a.fNz-1;++ta)for(var ue=a.fZ[ta],ad=a.fScale[ta],ve=a.fZ[ta+1],bd=a.fScale[ta+1],we=a.fX0[ta],xe=a.fX0[ta+1],ye=a.fY0[ta],ze=a.fY0[ta+1],ib=0;ib<a.fNvert;++ib){var cd=(ib+1)%a.fNvert;kc.addFace4(ad*a.fX[ib]+we,ad*a.fY[ib]+ye,ue,bd*a.fX[ib]+xe,bd*a.fY[ib]+ze,ve,bd*a.fX[cd]+xe,bd*a.fY[cd]+ze,ve,ad*a.fX[cd]+we,ad*a.fY[cd]+ye,ue);kc.calcNormal()}for(var Da=
0;Da<=a.fNz-1;Da+=a.fNz-1)for(var Gd=a.fZ[Da],Ib=a.fScale[Da],Hd=a.fX0[Da],Id=a.fY0[Da],Jd=0;Jd<jc.length;++Jd){var Kd=jc[Jd],Ae=hb[Kd[0]],Be=hb[Kd[0===Da?2:1]],Ce=hb[Kd[0===Da?1:2]];kc.addFace3(Ib*Ae.x+Hd,Ib*Ae.y+Id,Gd,Ib*Be.x+Hd,Ib*Be.y+Id,Gd,Ib*Ce.x+Hd,Ib*Ce.y+Id,Gd);kc.setNormal(0,0,0===Da?-1:1)}te=kc.create()}return te;case "TGeoParaboloid":var dd=b,ia=Math.max(4,Math.round(360/k.GradPerSegm)),na=30;if(0<dd){var Ld=2*ia*(na+1)/dd;1<Ld&&(ia=Math.max(5,Math.floor(ia/Math.sqrt(Ld))),na=Math.max(5,
Math.floor(na/Math.sqrt(Ld))))}var lc=-a.fDZ,mc=a.fDZ,nc=a.fRlo,ed=a.fRhi;0<=a.fA?a.fB>lc&&(lc=a.fB):a.fB<mc&&(mc=a.fB);var De=Math.atan2(lc,nc),Se=Math.atan2(mc,ed),fd=(na+1)*ia*2;0===nc&&(fd-=2*ia);0===ed&&(fd-=2*ia);if(0>dd)var Ee=fd;else{for(var Ea=new Float32Array(ia+1),Fa=new Float32Array(ia+1),Jb=0;Jb<=ia;++Jb)Fa[Jb]=Math.cos(Jb/ia*2*Math.PI),Ea[Jb]=Math.sin(Jb/ia*2*Math.PI);for(var gd=dd?new B:new A(fd),Md=lc,jb=0,oc=0,Nd=-1,Ga=0;Ga<=na+1;++Ga){var kb=0,W=0,Kb=0,hd=-1;if(0!==Ga||0!==nc){if(Ga===
na+1&&0===jb)break;switch(Ga){case 0:kb=lc;W=nc;break;case na:kb=mc;W=ed;break;case na+1:kb=mc;W=0;break;default:var id=Math.tan(De+(Se-De)*Ga/na);W=.5*(id+Math.sqrt(id*id-4*a.fA*a.fB))/a.fA;1E-6>W&&(W=0);kb=W*id}Kb=a.fA*W;hd=0<a.fA?-1:1;var pc=0;0===jb?pc=1:0===W&&(pc=2);for(var F=0;F<ia;++F)gd.addFace4(W*Fa[F],W*Ea[F],kb,jb*Fa[F],jb*Ea[F],Md,jb*Fa[F+1],jb*Ea[F+1],Md,W*Fa[F+1],W*Ea[F+1],kb,pc),0===pc||1===Ga&&0===nc||Ga===na+1&&0===ed?gd.setNormal4(Kb*Fa[F],Kb*Ea[F],hd,oc*Fa[F],oc*Ea[F],Nd,oc*Fa[F+
1],oc*Ea[F+1],Nd,Kb*Fa[F+1],Kb*Ea[F+1],hd,pc):gd.setNormal(0,0,Ga<na?-1:1);Md=kb;jb=W;oc=Kb;Nd=hd}}Ee=gd.create()}return Ee;case "TGeoHype":var lb=b;if(0===a.fTin&&0===a.fTout)var Od=Td(a,lb);else{var oa=Math.max(4,Math.round(360/k.GradPerSegm)),mb=30,Lb=oa*(mb+1)*(0<a.fRmin?4:2);if(0>lb)Od=Lb;else{0<lb&&lb>Lb&&(oa=Math.max(4,Math.floor(oa/Math.sqrt(Lb/lb))),mb=Math.max(4,Math.floor(mb/Math.sqrt(Lb/lb))),Lb=oa*(mb+1)*(0<a.fRmin?4:2));for(var Ha=new Float32Array(oa+1),Ia=new Float32Array(oa+1),Mb=
0;Mb<=oa;++Mb)Ia[Mb]=Math.cos(Mb/oa*2*Math.PI),Ha[Mb]=Math.sin(Mb/oa*2*Math.PI);for(var qc=lb?new B:new A(Lb),Nb=0;2>Nb&&!(0<Nb&&0>=a.fRmin);++Nb)for(var jd=0<Nb?a.fRmin:a.fRmax,Fe=0<Nb?a.fTinsq:a.fToutsq,rc=1-Nb,kd=1-rc,ld=0;ld<mb;++ld)for(var md=-a.fDz+ld/mb*2*a.fDz,nd=-a.fDz+(ld+1)/mb*2*a.fDz,od=Math.sqrt(jd*jd+Fe*md*md),pd=Math.sqrt(jd*jd+Fe*nd*nd),ua=0;ua<oa;++ua)qc.addFace4(od*Ia[ua+rc],od*Ha[ua+rc],md,pd*Ia[ua+rc],pd*Ha[ua+rc],nd,pd*Ia[ua+kd],pd*Ha[ua+kd],nd,od*Ia[ua+kd],od*Ha[ua+kd],md),qc.calcNormal();
for(var sc=0;2>sc;++sc)for(var Sa=0===sc?a.fDz:-a.fDz,qd=Math.sqrt(a.fRmax*a.fRmax+a.fToutsq*Sa*Sa),rd=0<a.fRmin?Math.sqrt(a.fRmin*a.fRmin+a.fTinsq*Sa*Sa):0,Te=0<a.fRmin?0:1,tc=1-sc,sd=1-tc,va=0;va<oa;++va)qc.addFace4(qd*Ia[va+tc],qd*Ha[va+tc],Sa,rd*Ia[va+tc],rd*Ha[va+tc],Sa,rd*Ia[va+sd],rd*Ha[va+sd],Sa,qd*Ia[va+sd],qd*Ha[va+sd],Sa,Te),qc.setNormal(0,0,0===sc?1:-1);Od=qc.create()}}return Od;case "TGeoTessellated":for(var uc=0,Pd=0;Pd<a.fFacets.length;++Pd)uc=4==a.fFacets[Pd].fNvert?uc+2:uc+1;if(0>
b)var Ge=uc;else{for(var td=b?new B:new A(uc),Qd=0;Qd<a.fFacets.length;++Qd){var vc=a.fFacets[Qd],Ob=a.fVertices[vc.fIvert[0]].fVec,Pb=a.fVertices[vc.fIvert[1]].fVec,Qb=a.fVertices[vc.fIvert[2]].fVec;if(4==vc.fNvert){var Rd=a.fVertices[vc.fIvert[3]].fVec;td.addFace4(Ob[0],Ob[1],Ob[2],Pb[0],Pb[1],Pb[2],Qb[0],Qb[1],Qb[2],Rd[0],Rd[1],Rd[2])}else td.addFace3(Ob[0],Ob[1],Ob[2],Pb[0],Pb[1],Pb[2],Qb[0],Qb[1],Qb[2]);td.calcNormal()}Ge=td.create()}return Ge;case "TGeoCompositeShape":return He(a,b);case "TGeoShapeAssembly":break;
case "TGeoScaledShape":var ud=Ja(a.fShape,b);a.fScale&&0<=b&&"object"===typeof ud&&"function"===typeof ud.scale&&ud.scale(a.fScale.fScale[0],a.fScale.fScale[1],a.fScale.fScale[2]);return ud;case "TGeoHalfSpace":if(0>b)return 1;default:k.warn("unsupported shape type "+a._typename)}}catch(wc){var xc="";void 0!==wc.stack&&(xc=wc.stack.split("\n")[0],xc=0<=xc.indexOf(wc.message)?wc.stack.split("\n")[1]:" at: "+xc);k.warn(a._typename+" err: "+wc.message+xc)}return 0>b?0:null};k.compareStacks=function(a,
b){if(!a||!b)return 0;if(a===b)return a.length;for(var d=Math.min(a.length,b.length),c=0;c<d;++c)if(a[c]!==b[c])return c;return d};k.isSameStack=function(a,b){if(!a||!b)return!1;if(a===b)return!0;if(a.length!==b.length)return!1;for(var d=0;d<a.length;++d)if(a[d]!==b[d])return!1;return!0};v.prototype.setVisLevel=function(a){this.vislevel=a&&!isNaN(a)?a:4};v.prototype.getVisLevel=function(){return this.vislevel};v.prototype.setMaxVisNodes=function(a){this.maxnodes=isNaN(a)?1E4:a};v.prototype.getMaxVisNodes=
function(){return this.maxnodes};v.prototype.updateNode=function(a){a&&!isNaN(a.id)&&a.id<this.nodes.length&&(this.nodes[a.id]=a)};v.prototype.getNodeShape=function(a){if(!this.origin||!this.nodes)return null;var b=this.origin[a];a=this.nodes[a];if(!b||!a)return null;if(0===a.kind){if(b.fVolume)return b.fVolume.fShape}else return b.fShape;return null};v.prototype.cleanup=function(a,b){if(a)for(var d=0;d<a.length;++d)delete a[d].stack,a[d]=void 0;if(b)for(a=0;a<b.length;++a)delete b[a].geom,b[a]=void 0;
if(this.nodes)for(b=0;b<this.nodes.length;++b)this.nodes[b]&&delete this.nodes[b].chlds;delete this.nodes;delete this.origin;delete this.sortmap};v.prototype.createClones=function(a,b,d){if(!b){if(a&&"$$Shape$$"==a._typename)return this.createClonesForShape(a);this.origin=[];b=1;d=k.getNodeKind(a)}if(!(0>d||!a||"_refid"in a)){a._refid=this.origin.length;this.origin.push(a);b>this.maxdepth&&(this.maxdepth=b);var c=null;c=0===d?a.fVolume&&a.fVolume.fNodes?a.fVolume.fNodes.arr:null:a.fElements?a.fElements.arr:
null;if(null!==c)for(k.checkDuplicates(a,c),a=0;a<c.length;++a)this.createClones(c[a],b+1,d);if(!(1<b)){this.nodes=[];b=[];for(c=0;c<this.origin.length;++c)a={id:c,kind:d,vol:0,nfaces:0},this.nodes.push(a),b.push(a);for(c=0;c<this.origin.length;++c){var e=this.origin[c];a=this.nodes[c];var f=null,h=null;1===d?(h=e.fShape,e.fElements&&(f=e.fElements.arr)):e.fVolume&&(h=e.fVolume.fShape,e.fVolume.fNodes&&(f=e.fVolume.fNodes.arr));if(e=k.getNodeMatrix(d,e)){a.matrix=e.elements;if(1===a.matrix[0]){e=
!0;for(var g=1;g<a.matrix.length&&e;++g)e=a.matrix[g]===(5===g||10===g||15===g?1:0);e&&delete a.matrix}a.matrix&&1==d&&(a.abs_matrix=!0)}h&&(a.fDX=h.fDX,a.fDY=h.fDY,a.fDZ=h.fDZ,a.vol=h.fDX*h.fDY*h.fDZ,void 0===h.$nfaces&&(h.$nfaces=Ja(h,-1)),a.nfaces=h.$nfaces,0>=a.nfaces&&(a.vol=0));if(f)for(a.chlds=Array(f.length),h=0;h<f.length;++h)a.chlds[h]=f[h]._refid}for(d=0;d<this.origin.length;++d)delete this.origin[d]._refid;b.sort(function(a,b){return b.vol-a.vol});this.sortmap=Array(this.nodes.length);
for(d=0;d<this.nodes.length;++d)this.sortmap[d]=b[d].id,b[d].sortid=d}}};v.prototype.createClonesForShape=function(a){this.origin=[];this.plain_shape=a;this.nodes=[{id:0,sortid:0,kind:2,name:"Shape",nfaces:a.nfaces,fDX:1,fDY:1,fDZ:1,vol:1,vis:!0}]};v.prototype.countVisibles=function(){var a=0;if(this.nodes)for(var b=0;b<this.nodes.length;++b)this.nodes[b].vis&&a++;return a};v.prototype.markVisibles=function(a,b,d){if(this.plain_shape)return 1;if(!this.origin||!this.nodes)return 0;for(var c=0,e=0;e<
this.nodes.length;++e){var f=this.nodes[e],h=this.origin[e];f.vis=0;delete f.nochlds;0===f.kind?h.fVolume&&(a?(f.vis=k.TestBit(h.fVolume,k.BITS.kVisOnScreen)?99:0,0==e&&f.vis&&d&&(f.vis=0),b&&(k.SetBit(h.fVolume,k.BITS.kVisNone,!1),k.SetBit(h.fVolume,k.BITS.kVisThis,0<f.vis),k.SetBit(h.fVolume,k.BITS.kVisDaughters,!0))):(f.vis=!k.TestBit(h.fVolume,k.BITS.kVisNone)&&k.TestBit(h.fVolume,k.BITS.kVisThis)?99:0,k.TestBit(h,k.BITS.kVisDaughters)&&k.TestBit(h.fVolume,k.BITS.kVisDaughters)||(f.nochlds=!0),
0<f.vis&&f.chlds&&!f.nochlds&&(f.vis=1),0==e&&(d&&(f.vis=0),delete f.nochlds))):(f.vis=h.fRnrSelf?99:0,0===e&&1===this.nodes.length&&(f.vis=99),this.vislevel=9999);if(0>=f.vol||0>=f.nfaces)f.vis=0;f.vis&&c++}return c};v.prototype.produceIdShifts=function(){function a(b,c){if(0>c.idshift&&(c.idshift=0,c.chlds))for(var d=0;d<c.chlds.length;++d)c.idshift+=a(b,b[c.chlds[d]]);return c.idshift+1}for(var b=0;b<this.nodes.length;++b)this.nodes[b].idshift=-1;a(this.nodes,this.nodes[0])};v.prototype.getVisibleFlags=
function(){for(var a=Array(this.nodes.length),b=0;b<this.nodes.length;++b)a[b]={vis:this.nodes[b].vis,nochlds:this.nodes[b].nochlds};return a};v.prototype.setVisibleFlags=function(a){if(!this.nodes||!a||!a.length!=this.nodes.length)return 0;for(var b=0,d=0;d<this.nodes.length;++d){var c=this.nodes[d];c.vis=a[d].vis;c.nochlds=a[d].nochlds;c.vis&&b++}return b};v.prototype.scanVisible=function(a,b){if(!this.nodes)return 0;void 0===b&&(a||(a={}),b=a.vislvl||this.vislevel||4,88<b&&(b=88),a.stack=Array(100),
a.nodeid=0,a.counter=0,a.last=0,a.CopyStack=function(a){var b={nodeid:this.nodeid,seqid:this.counter,stack:Array(this.last)};a&&(b.factor=a);for(a=0;a<this.last;++a)b.stack[a]=this.stack[a+1];return b},a.domatrix&&(a.matrices=[],a.mpool=[new g.Matrix4],a.getmatrix=function(){return this.matrices[this.last]}));var d=0,c=this.nodes[a.nodeid];if(a.domatrix){a.mpool[a.last+1]||(a.mpool[a.last+1]=new g.Matrix4);var e=0<a.last?a.matrices[a.last-1]:new g.Matrix4;c.matrix?(a.matrices[a.last]=a.mpool[a.last].fromArray(e.elements),
a.matrices[a.last].multiply(a.mpool[a.last+1].fromArray(c.matrix))):a.matrices[a.last]=e}c.nochlds&&(b=0);c.vis>b&&(!a.func||a.func(c))&&d++;a.counter++;if(0<b&&c.chlds){a.last++;for(e=0;e<c.chlds.length;++e)a.nodeid=c.chlds[e],a.stack[a.last]=e,d+=this.scanVisible(a,b-1);a.last--}else a.counter+=c.idshift||0;0===a.last&&(delete a.last,delete a.stack,delete a.CopyStack,delete a.counter,delete a.matrices,delete a.mpool,delete a.getmatrix);return d};v.prototype.getNodeName=function(a){return this.origin?
(a=this.origin[a])?k.getObjectName(a):"":(a=this.nodes[a])?a.name:""};v.prototype.resolveStack=function(a,b){var d={id:0,obj:null,node:this.nodes[0],name:this.name_prefix};b&&(d.matrix=new g.Matrix4,d.node.matrix&&d.matrix.fromArray(d.node.matrix));this.origin&&(d.obj=this.origin[0]);if(a)for(var c=0;c<a.length;++c){d.id=d.node.chlds[a[c]];d.node=this.nodes[d.id];this.origin&&(d.obj=this.origin[d.id]);var e=this.getNodeName(d.id);e&&(d.name&&(d.name+="/"),d.name+=e);b&&d.node.matrix&&d.matrix.multiply((new g.Matrix4).fromArray(d.node.matrix))}return d};
v.prototype.buildStackByIds=function(a){if(!a)return null;if(0!==a[0])return console.error("wrong ids - first should be 0"),null;for(var b=this.nodes[0],d=[],c=1;c<a.length;++c){var e=a[c];if(!b)return null;b=b.chlds.indexOf(e);if(0>b)return console.error("wrong nodes ids "+a[c]+" is not child of "+a[c-1]),null;d.push(b);b=this.nodes[e]}return d};v.prototype.buildIdsByStack=function(a){if(!a)return null;for(var b=this.nodes[0],d=[0],c=0;c<a.length;++c)b=b.chlds[a[c]],d.push(b),b=this.nodes[b];return d};
v.prototype.isIdInStack=function(a,b){if(!a)return!0;for(var d=this.nodes[0],c=0;c<b.length;++c){d=d.chlds[b[c]];if(d==a)return!0;d=this.nodes[d]}return!1};v.prototype.findStackByName=function(a){a=a.split("/");var b=0,d=[];if(this.getNodeName(b)!==a[0])return null;for(var c=1;c<a.length;++c){var e=this.nodes[b];if(!e.chlds)return null;for(var f=0;f<e.chlds.length;++f){var h=e.chlds[f];if(this.getNodeName(h)===a[c]){d.push(f);b=h;break}}if(d.length===c-1)return null}return d};v.prototype.setDefaultColors=
function(a){if((this.use_dflt_colors=a)&&!this.dflt_table){a=[];for(var b=0;110>b;b++)a.push(920);a[3]=390;a[4]=a[5]=406;a[6]=a[7]=593;a[8]=a[9]=613;a[10]=a[11]=622;a[12]=921;a[13]=590;a[14]=807;a[16]=401;a[20]=390;a[24]=a[25]=a[26]=592;a[29]=809;a[79]=798;this.dflt_table=a}};v.prototype.getDrawEntryProperties=function(a){var b=this.nodes[a.nodeid];if(2===b.kind){b={name:b.name,nname:b.name,shape:null,material:null,chlds:null};var d=a.opacity||1;b.fillcolor=new g.Color(a.color?"rgb("+a.color+")":
"blue");b.material=new g.MeshLambertMaterial({transparent:1>d,opacity:d,wireframe:!1,color:b.fillcolor,side:g.FrontSide,vertexColors:g.NoColors,depthWrite:1==d});b.material.inherentOpacity=d;return b}if(!this.origin)return console.error("origin not there - kind",b.kind,a.nodeid,b),null;d=this.origin[a.nodeid];if(1===b.kind)return a={name:k.getObjectName(d),nname:k.getObjectName(d),shape:d.fShape,material:null,chlds:null},null!==d.fElements&&(a.chlds=d.fElements.arr),b=Math.min(1,d.fRGBA[3]),a.fillcolor=
new g.Color(d.fRGBA[0],d.fRGBA[1],d.fRGBA[2]),a.material=new g.MeshLambertMaterial({transparent:1>b,opacity:b,wireframe:!1,color:a.fillcolor,side:g.FrontSide,vertexColors:g.NoColors,depthWrite:1==b}),a.material.inherentOpacity=b,a;var c=d.fVolume;b={name:k.getObjectName(c),nname:k.getObjectName(d),volume:d.fVolume,shape:c.fShape,material:null,chlds:null};null!==d.fVolume.fNodes&&(b.chlds=d.fVolume.fNodes.arr);c&&(b.linewidth=c.fLineWidth);d=1;var e=JSROOT.Painter;e=e?e.root_colors:"white black red green blue yellow magenta cyan".split(" ");
a.custom_color?b.fillcolor=a.custom_color:1<c.fFillColor&&1==c.fLineColor?b.fillcolor=e[c.fFillColor]:0<=c.fLineColor&&(b.fillcolor=e[c.fLineColor]);c.fMedium&&c.fMedium.fMaterial&&(a=c.fMedium.fMaterial,c=a.fFillStyle,c=3E3>c||3100<c?0:c-3E3,this.use_dflt_colors&&(b.fillcolor=e[this.dflt_table[Math.round(a.fZ)]],.1>a.fDensity&&(c=60)),0<c&&(d=(100-c)/100),void 0===b.fillcolor&&(b.fillcolor=e[a.fFillColor]));void 0===b.fillcolor&&(b.fillcolor="lightgrey");b.material=new g.MeshLambertMaterial({transparent:1>
d,opacity:d,wireframe:!1,color:b.fillcolor,side:g.FrontSide,vertexColors:g.NoColors,depthWrite:1==d});b.material.inherentOpacity=d;return b};v.prototype.createObject3D=function(a,b,d){for(var c=this.nodes[0],e=b,f=0,h="object"==typeof d||"force"===d,l=0;l<=a.length;++l){var k=0<l?a[l-1]:0;0<l&&(c=this.nodes[c.chlds[k]]);var m=void 0;if(e.children)for(var X=0;X<e.children.length;++X)if(e.children[X].nchld===k){m=e.children[X];break}if(m)e=m,m.$jsroot_drawable&&f++;else{if(!h)return null;m=new g.Object3D;
c.abs_matrix?(m.absMatrix=new g.Matrix4,m.absMatrix.fromArray(c.matrix)):c.matrix&&(m.matrix.fromArray(c.matrix),m.matrix.decompose(m.position,m.quaternion,m.scale));m.nchld=k;e.add(m);0==l&&"object"==typeof d&&d.scale&&(0>d.scale.x||0>d.scale.y||0>d.scale.z)&&(m.scale.copy(d.scale),m.updateMatrix());m.updateMatrixWorld();e=m}}if("mesh"===d||"delete_mesh"===d){a=null;if(e)for(c=0;c<e.children.length&&!a;++c)f=e.children[c],"Mesh"===f.type&&void 0===f.nchld&&(a=f);if("mesh"===d||!a)return a;for(d=
e;a&&a!==b;)e=a.parent,e.remove(a),a=0==e.children.length?e:null;return d}e&&(e.$jsroot_drawable=!0,e.$jsroot_depth=f);return e};v.prototype.getVolumeBoundary=function(a,b,d){var c={min:0,max:1,sortidcut:0};if(!this.sortmap)return console.error("sorting map do not exist"),c;for(var e,f,h=0,g=0,k=0;k<this.sortmap.length&&h<d&&g<b;++k){var m=this.sortmap[k];0!==a[m]&&(f=this.nodes[m],e||(e=f),h+=a[m],g+=a[m]*f.nfaces)}if(!f)return console.error("no volumes selected"),c;c.max=e.vol;c.min=f.vol;c.sortidcut=
f.sortid;return c};v.prototype.collectVisibles=function(a,b){if(this.plain_shape)return{lst:[{nodeid:0,seqid:0,stack:[],factor:1,shapeid:0,server_shape:this.plain_shape}],complete:!0};var d={facecnt:0,viscnt:Array(this.nodes.length),vislvl:this.getVisLevel(),reset:function(){for(var a=this.facecnt=this.total=0;a<this.viscnt.length;++a)this.viscnt[a]=0},func:function(a){this.total++;this.facecnt+=a.nfaces;this.viscnt[a.id]++;return!0}};d.reset();var c=this.scanVisible(d),e=this.getMaxVisNodes();if(0<
e)for(;c>e&&1<d.vislvl;)d.vislvl--,d.reset(),c=this.scanVisible(d);this.actual_level=d.vislvl;var f=0,h=0,g=-1,k=10,m=this.nodes.length+1;console.log("Total visible nodes "+c+" numfaces "+d.facecnt);if(d.facecnt>a&&(c=this.getVolumeBoundary(d.viscnt,a*(b?.8:1),e*(b?.8:1)),f=c.min,h=c.max,m=c.sortidcut,b)){d.domatrix=!0;d.frustum=b;d.totalcam=0;d.func=function(a){a.vol<=f&&this.frustum.CheckShape(this.getmatrix(),a)&&(this.viscnt[a.id]++,this.totalcam+=a.nfaces);return!0};for(b=0;b<d.viscnt.length;++b)d.viscnt[b]=
0;this.scanVisible(d);g=d.totalcam>.2*a?this.getVolumeBoundary(d.viscnt,.2*a,.2*e).min:0;k=h/(0<g?0<g:f)}d.items=[];d.func=function(a){a.sortid<m?this.items.push(this.CopyStack()):0<=g&&a.vol>g&&this.frustum.CheckShape(this.getmatrix(),a)&&this.items.push(this.CopyStack(k));return!0};this.scanVisible(d);return{lst:d.items,complete:0===f}};v.prototype.mergeVisibles=function(a,b){for(var d=0,c=[],e=0;e<a.length&&d<b.length;++e){for(;d<b.length&&b[d].seqid<a[e].seqid;)c.push(b[d++]);d<b.length&&b[d].seqid===
a[e].seqid&&(b[d].done&&(a[e].done=!0),d++)}for(;d<b.length;)c.push(b[d++]);return c};v.prototype.collectShapes=function(a){if(this.plain_shape)return[this.plain_shape];for(var b=[],d=0;d<a.length;++d){var c=a[d],e=this.getNodeShape(c.nodeid);e&&(void 0===e._id?(e._id=b.length,b.push({id:e._id,shape:e,vol:this.nodes[c.nodeid].vol,refcnt:1,factor:1,ready:!1})):b[e._id].refcnt++,c.shape=b[e._id],c.factor&&c.factor>c.shape.factor&&(c.shape.factor=c.factor))}b.sort(function(a,b){return b.vol*b.factor-
a.vol*a.factor});for(d=0;d<b.length;++d)c=b[d],c.id=d,delete c.shape._id;for(d=0;d<a.length;++d)c=a[d],c.shape&&(c.shapeid=c.shape.id,delete c.shape);return b};v.prototype.mergeShapesLists=function(a,b){if(!a)return b;for(var d=0;d<a.length;++d){var c=a[d];c.shape._geom=c.geom;delete c.geom;void 0!==c.geomZ&&(c.shape._geomZ=c.geomZ,delete c.geomZ)}for(d=0;d<b.length;++d)c=b[d],void 0!==c.shape._geom&&(c.geom=c.shape._geom,delete c.shape._geom),void 0!==c.shape._geomZ&&(c.geomZ=c.shape._geomZ,delete c.shape._geomZ);
for(d=0;d<a.length;++d)c=a[d],delete c.shape._geom,delete c.shape._geomZ;return b};v.prototype.buildShapes=function(a,b,d){for(var c=0,e=(new Date).getTime(),f={done:!1,shapes:0,faces:0,notusedshapes:0},h=0;h<a.length;++h){var g=a[h];if(f.done)g.ready=!0;else if(g.ready||(g._typename="$$Shape$$",g.ready=!0,void 0===g.geom&&(g.geom=Ja(g.shape),g.geom&&c++),g.nfaces=I(g.geom)),f.shapes++,g.used||f.notusedshapes++,f.faces+=g.nfaces*g.refcnt,f.faces>=b)f.done=!0;else if(c>.01*a.length&&void 0!==d&&(new Date).getTime()-
e>d)return f}f.done=!0;return f};k.getObjectName=function(a){return a&&a.fName?a.fName+(a.$geo_suffix?a.$geo_suffix:""):""};k.checkDuplicates=function(a,b){if(a){if(a.$geo_checked)return;a.$geo_checked=!0}a=[];for(var d=[],c=0;c<b.length;++c){var e=b[c];if(e&&e.fName){if(!e.$geo_suffix){var f=a.indexOf(e.fName);if(0<=f){for(var g=d[f]||1;0<=a.indexOf(e.fName+"#"+g);)++g;e.$geo_suffix="#"+g;d[f]=g+1}}a.push(k.getObjectName(e))}}};k.cleanupShape=function(a){a&&(a.geom&&"funciton"==typeof a.geom.dispose&&
a.geom.dispose(),a.geomZ&&"funciton"==typeof a.geomZ.dispose&&a.geomZ.dispose(),delete a.geom,delete a.geomZ)};k.produceRenderOrder=function(a,b,d,c){function e(a){a&&a.traverse(function(a){a.renderOrder=0;a.material&&(a.material.depthWrite=!0)})}function f(a,b,c){if(a.children)for(var d=0;d<a.children.length;++d){var g=a.children[d];g.$jsroot_order===b?g.material&&(g.material.transparent?(g.material.depthWrite=!1,c.push(g)):e(g)):(void 0===a.$jsroot_depth||a.$jsroot_depth<b)&&f(g,b,c)}}function h(a,
e,f){if(300<a.length){for(var h=0;h<a.length;++h)a[h].renderOrder=(e+f)/2;return!1}h=new g.Vector3;for(var k=0;k<a.length;++k){var l=a[k],m=l.$jsroot_box3;m||(l.$jsroot_box3=m=Vb(l));if("size"===d)l.$jsroot_distance=m.getSize(new g.Vector3);else if("pnt"===d)l.$jsroot_distance=b.distanceTo(m.getCenter(h));else{var p=Math.min(b.distanceTo(m.min),b.distanceTo(m.max)),n=new g.Vector3(m.min.x,m.min.y,m.max.z);p=Math.min(p,b.distanceTo(n));n.set(m.min.x,m.max.y,m.min.z);p=Math.min(p,b.distanceTo(n));n.set(m.max.x,
m.min.y,m.min.z);p=Math.min(p,b.distanceTo(n));n.set(m.max.x,m.max.y,m.min.z);p=Math.min(p,b.distanceTo(n));n.set(m.max.x,m.min.y,m.max.z);p=Math.min(p,b.distanceTo(n));n.set(m.min.x,m.max.y,m.max.z);p=Math.min(p,b.distanceTo(n));l.$jsroot_distance=p}}a.sort(function(a,b){return a.$jsroot_distance-b.$jsroot_distance});k=Array(a.length);for(l=0;l<a.length;++l)a[l].$jsroot_index=l,k[l]=a[l];if("ray"===d)for(l=a.length-1;0<=l;--l){m=a[l];n=m.$jsroot_box3.getCenter(h);for(p=0;2>p;++p){n.sub(b).normalize();
q.set(b,n);n=q.intersectObjects(a,!1);for(var t=[],v=0;v<n.length;++v)0>t.indexOf(n[v].object)&&t.push(n[v].object);n=t;0>n.indexOf(m)&&0<p&&console.log("MISS",c?c.resolveStack(m.stack).name:"???");if(0<=n.indexOf(m)||0<p)break;n=m.geometry.attributes.position.array;n=new g.Vector3((n[0]+n[3]+n[6])/3,(n[1]+n[4]+n[7])/3,(n[2]+n[5]+n[8])/3);n.applyMatrix4(m.matrixWorld)}for(m=0;m<intersects.length-1;++m)if(p=intersects[m+1],n=intersects[m].$jsroot_index,t=p.$jsroot_index,!(n<t)){for(;t<n;++t)k[t]=k[t+
1],k[t].$jsroot_index=t;k[n]=p;p.$jsroot_index=n}}for(a=0;a<k.length;++a)k[a].renderOrder=f-(a+1)/(k.length+1)*(f-e),delete k[a].$jsroot_index,delete k[a].$jsroot_distance;return!0}function k(a,b,c,d){var e=[],g=!1;f(a,b,e);if(e.length){if(c===d)for(a=0;a<e.length;++a)e[a].renderOrder=c;else(g=h(e,c,d))||(c=d=(c+d)/2);for(a=0;a<e.length;++a){var l=e[a].parent,m=c,n=d;g&&(n=e[a].renderOrder,m=n-(d-c)/(e.length+2));k(l,b+1,m,n)}}}var q=new g.Raycaster;d&&"dflt"!==d?k(a,0,1,1E6):e(a)};k.build=function(a,
b){if(!a)return null;b||(b={});b.numfaces||(b.numfaces=1E5);b.numnodes||(b.numnodes=1E3);b.frustum||(b.frustum=null);b.res_mesh=b.res_faces=0;var d=null,c=!1;"fShapeBits"in a&&"fShapeId"in a?(d=a,a=null):"TGeoVolumeAssembly"===a._typename||"TGeoVolume"===a._typename?d=a.fShape:"TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::REveGeoShapeExtract"===a._typename?d=a.fShape:"TGeoManager"===a._typename?(a=a.fMasterVolume,c=!b.showtop,d=a.fShape):a.fVolume?d=a.fVolume.fShape:a=null;b.composite&&
d&&"TGeoCompositeShape"==d._typename&&d.fNode&&(a=k.buildCompositeVolume(d));!a&&d&&(a=JSROOT.extend(JSROOT.create("TEveGeoShapeExtract"),{fTrans:null,fShape:d,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:!0}));if(!a)return null;0===a._typename.indexOf("TGeoVolume")&&(a={_typename:"TGeoNode",fVolume:a,fName:a.fName,$geoh:a.$geoh,_proxy:!0});a=new v(a);a.setVisLevel(b.vislevel);a.setMaxVisNodes(b.numnodes);b.dflt_colors&&a.setDefaultColors(!0);0>=(b.no_screen?0:a.markVisibles(!0))?a.markVisibles(!1,!1,
c):a.markVisibles(!0,!0,c);a.produceIdShifts();c=a.collectVisibles(b.numfaces,b.frustum).lst;d=a.collectShapes(c);a.buildShapes(d,b.numfaces);for(var e=new g.Object3D,f=0;f<c.length;++f){var h=c[f];if(!h.done){var l=d[h.shapeid];if(!l.ready){console.warn("shape marked as not ready when should");break}h.done=!0;l.used=!0;if(l.geom&&0!==l.nfaces){var q=a.getDrawEntryProperties(h);b.res_mesh++;b.res_faces+=l.nfaces;h=a.createObject3D(h.stack,e,b);q.material.wireframe=b.wireframe;q.material.side=b.doubleside?
g.DoubleSide:g.FrontSide;l=-.9<(h.absMatrix||h.matrixWorld).determinant()?new g.Mesh(l.geom,q.material):Ub(l,q.material);h.add(l);h.absMatrix&&(l.matrix.copy(h.absMatrix),l.matrix.decompose(h.position,h.quaternion,h.scale),l.updateMatrixWorld())}else a.createObject3D(h.stack,e,"delete_mesh")}}return e};k.projectGeometry=function(a,b,d,c,e){a.boundingBox||a.computeBoundingBox();var f=a.boundingBox.clone();f.applyMatrix4(b);c||(c=0);if(f.min[d]>=c&&f.max[d]>=c||f.min[d]<=c&&f.max[d]<=c)return null;
a=new z.Geometry(a,b,0,e);b=2*Math.max(Math.abs(f.min.x),Math.abs(f.max.x));e=2*Math.max(Math.abs(f.min.y),Math.abs(f.max.y));f=2*Math.max(Math.abs(f.min.z),Math.abs(f.max.z));var g=1E4;switch(d){case "x":g=Math.max(e,f);break;case "y":g=Math.max(b,f);break;case "z":g=Math.max(b,e)}d=z.CreateNormal(d,c,g);a.cut_from_plane(d);return d.toBufferGeometry()};k.countGeometryFaces=I;k.createGeometry=Ja;k.createProjectionMatrix=Tb;k.createFrustum=function(a){if(!a)return null;a instanceof g.PerspectiveCamera&&
(a=Tb(a));var b=new g.Frustum;b.setFromProjectionMatrix(a);b.corners=new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,0,0,0]);b.test=new g.Vector3(0,0,0);b.CheckShape=function(a,b){var c=this.test,d=this.corners.length,g=this.corners,k;for(k=0;k<d;k+=3)if(c.x=g[k]*b.fDX,c.y=g[k+1]*b.fDY,c.z=g[k+2]*b.fDZ,this.containsPoint(c.applyMatrix4(a)))return!0;return!1};b.CheckBox=function(a){var b=this.test,d=0;b.set(a.min.x,a.min.y,a.min.z);this.containsPoint(b)&&d++;b.set(a.min.x,
a.min.y,a.max.z);this.containsPoint(b)&&d++;b.set(a.min.x,a.max.y,a.min.z);this.containsPoint(b)&&d++;b.set(a.min.x,a.max.y,a.max.z);this.containsPoint(b)&&d++;b.set(a.max.x,a.max.y,a.max.z);this.containsPoint(b)&&d++;b.set(a.max.x,a.min.y,a.max.z);this.containsPoint(b)&&d++;b.set(a.max.x,a.max.y,a.min.z);this.containsPoint(b)&&d++;b.set(a.max.x,a.max.y,a.max.z);this.containsPoint(b)&&d++;return 5<d};return b};k.createFlippedMesh=Ub;k.getBoundingBox=Vb;k.provideObjectInfo=Sb;k.ClonedNodes=v;JSROOT.GEO=
k;JSROOT.nodejs&&(module.exports=k);return k});
